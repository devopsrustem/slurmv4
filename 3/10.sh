üîé –°–¥–µ–ª–∞–π –Ω–∞ –≤—Å–µ—Ö 4 –Ω–æ–¥–∞—Ö
show_gids

–∏–ª–∏

ibv_devinfo -v | grep gid

–ù–∞–π–¥–∏:

–∫–∞–∫–æ–π GID —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç IP 10.99.91.x

RoCE v2

IPv4

–ò —Å—Ä–∞–≤–Ω–∏ –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏.

üî• –ü–æ—á–µ–º—É —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –∏–º–µ–Ω–Ω–æ –Ω–∞ RoCE mismatch

–û—à–∏–±–∫–∞ –Ω–µ —Ç–∞–∫–∞—è:

NCCL WARN ...

–û—à–∏–±–∫–∞ –∏–º–µ–Ω–Ω–æ:

remote mooncake session 10.99.91.49:15993 is not alive

Mooncake –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RDMA CM –ø–æ–≤–µ—Ä—Ö RoCE.

–ï—Å–ª–∏ GID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî
CM handshake –ø—Ä–æ—Ö–æ–¥–∏—Ç,
–Ω–æ QP –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è,
–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ "–≤–∏—Å–∏—Ç –º—ë—Ä—Ç–≤—ã–º".

–≠—Ç–æ —Ç–∏–ø–∏—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–∏:

—Ä–∞–∑–Ω—ã—Ö ToR

—Ä–∞–∑–Ω—ã—Ö MTU

—Ä–∞–∑–Ω—ã—Ö PFC/ECN –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

—Ä–∞–∑–Ω—ã—Ö GID index

üö® –í—Ç–æ—Ä–æ–π —Å–∏–ª—å–Ω—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç

–¢—ã —É–∫–∞–∑–∞–ª:

--disaggregation-ib-device mlx5_0

–£ DGX H100 –æ–±—ã—á–Ω–æ:

mlx5_0

mlx5_1

...

mlx5_7

–ù–æ!

–ù–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö mlx5_0 –º–æ–∂–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –†–ê–ó–ù–´–ô —Å–≤–∏—á.

–ï—Å–ª–∏ fabric –∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞ ‚Äî
prefill –∏ decode –æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö L2 –¥–æ–º–µ–Ω–∞—Ö.

üß™ –°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏ RDMA –¥–ª—è disaggregation:

–ù–∞ –≤—Å–µ—Ö 4 –Ω–æ–¥–∞—Ö:

export NCCL_IB_DISABLE=1

–ò —É–±–µ—Ä–∏:

--disaggregation-ib-device

–ü—É—Å—Ç—å Mooncake –ø–æ–π–¥—ë—Ç —á–µ—Ä–µ–∑ TCP.

–ï—Å–ª–∏ –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí 100% –ø—Ä–æ–±–ª–µ–º–∞ –≤ RoCE.

üéØ –í—Ç–æ—Ä–æ–π —Ç–µ—Å—Ç

–ü–æ–ø—Ä–æ–±—É–π –Ω–∞ –≤—Å–µ—Ö 4 –Ω–æ–¥–∞—Ö:

export NCCL_IB_GID_INDEX=0

(–≤—Ä–µ–º–µ–Ω–Ω–æ)

–ï—Å–ª–∏ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç GID mismatch.

üìå –í–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å

RoCE v1 –∏–ª–∏ v2?

–ü—Ä–æ–≤–µ—Ä—å:

cat /sys/class/infiniband/mlx5_0/ports/1/gid_attrs/types/*

–ï—Å–ª–∏ —É–≤–∏–¥–∏—à—å RoCE v1 –∏ RoCE v2 ‚Äî –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å.

üß† –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ disaggregation

–ë–µ–∑ disaggregation –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ NVLink/NVSwitch.

–° disaggregation:

KV –∏–¥—ë—Ç —á–µ—Ä–µ–∑ RDMA

fabric —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫—Ä–∏—Ç–∏—á–Ω–æ–π

–ò –ª—é–±—ã–µ –º–µ–ª–∫–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ª–æ–º–∞—é—Ç transfer.

üí° –ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑

–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏—á–∏–Ω:

60% GID index mismatch

25% RoCE v1/v2 mismatch

10% MTU mismatch

5% firewall

–û—Ç–≤–µ—Ç—å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π:

show_gids | grep 10.99.91

—Å –ª—é–±–æ–π prefill –∏ decode –Ω–æ–¥—ã.

–¢–æ–≥–¥–∞ —è —Å–∫–∞–∂—É —Ç–æ—á–Ω–æ.
