# roles/master_nodes/tasks/main.yml
---
# =============================================================================
# SLURM MASTER NODE CONFIGURATION (упрощенная версия)
# =============================================================================

- name: "[SLURM-MASTER] Начало настройки Slurm Master"
  debug:
    msg: |
       Настройка Slurm Master узла: {{ inventory_hostname }}
       Роль: {{ slurm_controller_role | default('primary') }}
       IP: {{ ansible_default_ipv4.address | default('определяется...') }}

# =============================================================================
# MARIADB SETUP (только настройка, пакеты уже в common)
# =============================================================================

- name: "[SLURM-MASTER] Настройка MariaDB для Slurm"
  include_tasks: mariadb.yml
  when: slurm_db_enabled | default(true)

# =============================================================================
# SLURM CONFIGURATION
# =============================================================================

- name: "[SLURM-MASTER] Создание конфигурации Slurm"
  include_tasks: config.yml

# =============================================================================
# SYSTEMD SERVICES
# =============================================================================

- name: "[SLURM-MASTER] Настройка systemd сервисов"
  include_tasks: services.yml

- name: "Configure JWT authentication for OpenOnDemand"
  include_tasks: jwt_config.yml

- name: "Fix permissions and create users"
  include_tasks: fix_permissions.yml

# =============================================================================
# PROLOG/EPILOG СКРИПТЫ ДЛЯ ENROOT (DEEPOPS ПОДХОД)
# =============================================================================

- name: "[SLURM-MASTER] Создание директорий для prolog/epilog"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /etc/slurm/prolog.d
    - /etc/slurm/epilog.d

- name: "[SLURM-MASTER] Создание Enroot prolog скрипта"
  template:
    src: prolog.sh.j2
    dest: /etc/slurm/prolog.d/prolog.sh
    owner: root
    group: root
    mode: '0755'
  notify: restart slurmctld

- name: "[SLURM-MASTER] Создание Enroot epilog скрипта"
  template:
    src: epilog.sh.j2
    dest: /etc/slurm/epilog.d/epilog.sh
    owner: root
    group: root
    mode: '0755'
  notify: restart slurmctld

- name: "[SLURM-MASTER] Копирование prolog/epilog скриптов на NFS для распространения"
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    remote_src: yes
    owner: root
    group: root
    mode: '0755'
  loop:
    - { src: "/etc/slurm/prolog.d/prolog.sh", dest: "/sw/config/prolog.sh" }
    - { src: "/etc/slurm/epilog.d/epilog.sh", dest: "/sw/config/epilog.sh" }

- name: "[SLURM-MASTER] Создание базовых enroot директорий"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /run/enroot
    - /tmp/enroot-data
    - /var/lib/enroot-cache

# =============================================================================
# ФИНАЛЬНАЯ ИНФОРМАЦИЯ
# =============================================================================

- name: "[SLURM-MASTER] Исправление прав на JWT ключ"
  file:
    path: /var/spool/slurm/jwt_hs256.key
    owner: slurm
    group: slurm
    mode: '0600'
  when: slurm_jwt_enabled | default(true)

- name: "Display master configuration completion"
  debug:
    msg: "Slurm master node configured successfully on {{ inventory_hostname }}"