# roles/slurm_master/tasks/main.yml
---
# =============================================================================
# SLURM MASTER NODE CONFIGURATION (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
# =============================================================================

- name: "[SLURM-MASTER] –ù–∞—á–∞–ª–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Slurm Master"
  debug:
    msg: |
      üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slurm Master —É–∑–ª–∞: {{ inventory_hostname }}
      üìç –†–æ–ª—å: {{ slurm_controller_role | default('primary') }}
      üåê IP: {{ ansible_default_ipv4.address | default('–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...') }}

# =============================================================================
# MARIADB SETUP (—Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, –ø–∞–∫–µ—Ç—ã —É–∂–µ –≤ common)
# =============================================================================

- name: "[SLURM-MASTER] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MariaDB –¥–ª—è Slurm"
  include_tasks: mariadb.yml
  when: slurm_db_enabled | default(true)

# =============================================================================
# SLURM CONFIGURATION
# =============================================================================

- name: "[SLURM-MASTER] –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Slurm"
  include_tasks: config.yml

# =============================================================================
# SYSTEMD SERVICES
# =============================================================================

- name: "[SLURM-MASTER] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–æ–≤"
  include_tasks: services.yml

# =============================================================================
# PROLOG/EPILOG –°–ö–†–ò–ü–¢–´ –î–õ–Ø ENROOT (DEEPOPS –ü–û–î–•–û–î)
# =============================================================================

- name: "[SLURM-MASTER] –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è prolog/epilog"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /etc/slurm/prolog.d
    - /etc/slurm/epilog.d

- name: "[SLURM-MASTER] –°–æ–∑–¥–∞–Ω–∏–µ Enroot prolog —Å–∫—Ä–∏–ø—Ç–∞"
  template:
    src: prolog.sh.j2
    dest: /etc/slurm/prolog.d/prolog.sh
    owner: root
    group: root
    mode: '0755'
  notify: restart slurmctld

- name: "[SLURM-MASTER] –°–æ–∑–¥–∞–Ω–∏–µ Enroot epilog —Å–∫—Ä–∏–ø—Ç–∞"
  template:
    src: epilog.sh.j2
    dest: /etc/slurm/epilog.d/epilog.sh
    owner: root
    group: root
    mode: '0755'
  notify: restart slurmctld

- name: "[SLURM-MASTER] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ prolog/epilog —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞ NFS –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è"
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    remote_src: yes
    owner: root
    group: root
    mode: '0755'
  loop:
    - { src: "/etc/slurm/prolog.d/prolog.sh", dest: "/sw/config/prolog.sh" }
    - { src: "/etc/slurm/epilog.d/epilog.sh", dest: "/sw/config/epilog.sh" }

- name: "[SLURM-MASTER] –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö enroot –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /run/enroot
    - /tmp/enroot-data
    - /var/lib/enroot-cache

# =============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# =============================================================================

- name: "[SLURM-MASTER] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
  debug:
    msg: |
      ‚úÖ Slurm Master –Ω–∞—Å—Ç—Ä–æ–µ–Ω!
      üîß –ö–ª–∞—Å—Ç–µ—Ä: {{ slurm_cluster_name | default('hpc-cluster') }}
      üéõÔ∏è Controller: {{ inventory_hostname }}:{{ slurm_controller_port | default(6817) }}
      üíæ Database: {{ slurm_db_enabled | default(true) | ternary('–≤–∫–ª—é—á–µ–Ω–∞', '–æ—Ç–∫–ª—é—á–µ–Ω–∞') }}