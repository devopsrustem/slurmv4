# roles/slurm_master/tasks/mariadb.yml
---
# =============================================================================
# MARIADB SETUP FOR SLURM (—Ç–æ–ª—å–∫–æ shell –∫–æ–º–∞–Ω–¥—ã, –ù–ï ansible –º–æ–¥—É–ª–∏)
# =============================================================================

- name: "[MARIADB] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–≤–µ–∂–µ–π MariaDB"
  shell: sudo mysql -e "SELECT VERSION();"
  register: mariadb_version
  changed_when: false
  tags: mariadb

- name: "[MARIADB] –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é MariaDB"
  debug:
    msg: "üê¨ MariaDB –≤–µ—Ä—Å–∏—è: {{ mariadb_version.stdout_lines[1] | default('unknown') }}"
  tags: mariadb

- name: "[MARIADB] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–∑—ã Slurm (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"
  shell: |
    sudo mysql -e "CREATE USER IF NOT EXISTS '{{ slurm_db_user }}'@'localhost' IDENTIFIED BY '{{ slurm_db_password }}';"
    sudo mysql -e "CREATE USER IF NOT EXISTS '{{ slurm_db_user }}'@'%' IDENTIFIED BY '{{ slurm_db_password }}';"
    sudo mysql -e "CREATE DATABASE IF NOT EXISTS {{ slurm_db_name }};"
    sudo mysql -e "GRANT ALL PRIVILEGES ON {{ slurm_db_name }}.* TO '{{ slurm_db_user }}'@'localhost';"
    sudo mysql -e "GRANT ALL PRIVILEGES ON {{ slurm_db_name }}.* TO '{{ slurm_db_user }}'@'%';"
    sudo mysql -e "FLUSH PRIVILEGES;"
  register: mariadb_setup
  tags: mariadb

- name: "[MARIADB] –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
  debug:
    msg: |
      üìù –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ mariadb_setup.rc == 0 | ternary('‚úÖ –£–°–ü–ï–•', '‚ùå –æ—à–∏–±–∫–∞') }}
      {% if mariadb_setup.rc != 0 %}
      ‚ö†Ô∏è  –û—à–∏–±–∫–∞: {{ mariadb_setup.stderr }}
      {% endif %}
  tags: mariadb

- name: "[MARIADB] –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Slurm"
  shell: mysql -u{{ slurm_db_user }} -p{{ slurm_db_password }} -e "USE {{ slurm_db_name }}; SELECT 1 AS test;"
  register: slurm_test
  changed_when: false
  failed_when: false
  tags: mariadb

- name: "[MARIADB] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö"
  shell: mysql -u{{ slurm_db_user }} -p{{ slurm_db_password }} -e "SHOW DATABASES;"
  register: databases_list
  changed_when: false
  failed_when: false
  tags: mariadb

- name: "[MARIADB] –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è Slurm"
  copy:
    dest: /etc/mysql/mariadb.conf.d/99-slurm.cnf
    content: |
      # Slurm optimizations
      [mysqld]
      innodb_buffer_pool_size = 128M
      innodb_lock_wait_timeout = 900
      innodb_log_file_size = 64M
      max_connections = 500
      query_cache_size = 32M
      query_cache_type = 1
    owner: root
    group: root
    mode: '0644'
  notify: restart mariadb
  tags: mariadb

- name: "[MARIADB] –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ MariaDB –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫"
  systemd:
    name: mariadb
    state: restarted
  tags: mariadb


- name: "[MARIADB] –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
  debug:
    msg: |
      üê¨ MariaDB –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:
      üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ slurm_db_user }}
      üìä –ë–∞–∑–∞: {{ slurm_db_name }}
      ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: {{ slurm_test.rc == 0 | ternary('–†–ê–ë–û–¢–ê–ï–¢!', '–æ—à–∏–±–∫–∞') }}
      
      üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–∑—ã:
      {{ databases_list.stdout | default('–Ω–µ –ø–æ–ª—É—á–µ–Ω—ã') }}
      
      {% if slurm_test.rc == 0 %}
      üéâ –ì–û–¢–û–í –î–õ–Ø SLURM!
      {% else %}
      ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: {{ slurm_test.stderr | default('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') }}
      {% endif %}
  tags: mariadb