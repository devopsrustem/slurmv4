# roles/slurm_master/tasks/config.yml
---
# =============================================================================
# SLURM CONFIGURATION FILES (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
# =============================================================================

- name: "[CONFIG] –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ slurm.conf"
  template:
    src: slurm.conf.j2
    dest: /etc/slurm/slurm.conf
    owner: slurm
    group: slurm
    mode: "0644"
    backup: yes
  notify: restart slurmctld
  tags: config

- name: "[CONFIG] –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ slurmdbd.conf"
  template:
    src: slurmdbd.conf.j2
    dest: /etc/slurm/slurmdbd.conf
    owner: slurm
    group: slurm
    mode: "0600"
    backup: yes
  when: slurm_db_enabled | default(true)
  notify: restart slurmdbd
  tags: config

- name: "[CONFIG] –°–æ–∑–¥–∞–Ω–∏–µ gres.conf –¥–ª—è GPU"
  template:
    src: gres.conf.j2
    dest: /etc/slurm/gres.conf
    owner: slurm
    group: slurm
    mode: "0644"
    backup: yes
  notify: restart slurmctld
  tags: config

- name: "[CONFIG] –°–æ–∑–¥–∞–Ω–∏–µ cgroup.conf"
  template:
    src: cgroup.conf.j2
    dest: /etc/slurm/cgroup.conf
    owner: slurm
    group: slurm
    mode: "0644"
    backup: yes
  notify: restart slurmctld
  tags: config

- name: "[CONFIG] –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –Ω–∞ NFS"
  file:
    path: "/sw/config"
    state: directory
    owner: slurm
    group: slurm
    mode: "0755"
  tags: config

- name: "[CONFIG] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –Ω–∞ NFS –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è"
  copy:
    src: "/etc/slurm/{{ item }}"
    dest: "/sw/config/{{ item }}"
    remote_src: yes
    owner: slurm
    group: slurm
    mode: "0644"
  loop:
    - slurm.conf
    - cgroup.conf
    - gres.conf
  tags: config

- name: "[CONFIG] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞"
  debug:
    msg: |
      üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Slurm:
      ‚úÖ slurm.conf —Å–æ–∑–¥–∞–Ω
      ‚úÖ gres.conf —Å–æ–∑–¥–∞–Ω (AutoDetect=nvml)
      ‚úÖ cgroup.conf —Å–æ–∑–¥–∞–Ω
      ‚úÖ slurmdbd.conf —Å–æ–∑–¥–∞–Ω
      üì§ –§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ /sw/config/ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
  tags: config