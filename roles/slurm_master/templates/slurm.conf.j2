# roles/master_nodes/templates/slurm.conf.j2
#
# Slurm Configuration File - {{ slurm_cluster_name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Slurm Version: 25.05.1
#

# =============================================================================
# CLUSTER IDENTIFICATION
# =============================================================================
ClusterName={{ slurm_cluster_name }}
ControlMachine={{ slurm_controller_host }}
ControlAddr={{ slurm_controller_addr }}

# =============================================================================
# AUTHENTICATION AND SECURITY
# =============================================================================
AuthType=auth/munge
CredType=cred/munge

# JWT Authentication for REST API
AuthAltTypes=auth/jwt
AuthAltParameters=jwt_key=/var/spool/slurm/jwt_hs256.key

# =============================================================================
# USERS AND PERMISSIONS
# =============================================================================
SlurmUser=root
SlurmdUser=root

# =============================================================================
# PORTS AND COMMUNICATION
# =============================================================================
SlurmctldPort={{ slurm_controller_port }}
SlurmdPort={{ slurm_daemon_port }}

# =============================================================================
# STATE AND LOGGING
# =============================================================================
StateSaveLocation={{ slurm_spool_dir }}/ctld
SlurmdSpoolDir={{ slurm_spool_dir }}/d
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmdPidFile=/var/run/slurmd.pid
SlurmctldLogFile={{ slurm_log_dir }}/slurmctld.log
SlurmdLogFile={{ slurm_log_dir }}/slurmd.log
SlurmctldDebug={{ slurm_debug_level }}
SlurmdDebug={{ slurm_debug_level }}

# =============================================================================
# DATABASE ACCOUNTING
# =============================================================================
{% if slurm_db_enabled %}
AccountingStorageType=accounting_storage/slurmdbd
AccountingStorageHost={{ slurm_db_host }}
AccountingStoragePort=6819
AccountingStorageUser={{ slurm_user }}
{% else %}
AccountingStorageType=accounting_storage/none
{% endif %}

# Job accounting - ОТКЛЮЧЕНО для системного пакета
JobAcctGatherType=jobacct_gather/none
JobAcctGatherFrequency=30

# =============================================================================
# SCHEDULING AND RESOURCE MANAGEMENT
# =============================================================================
SchedulerType=sched/backfill
SelectType=select/cons_tres
SelectTypeParameters=CR_Core_Memory

# =============================================================================
# TIMEOUTS AND LIMITS
# =============================================================================
SlurmctldTimeout={{ slurm_scheduler_timeout }}
SlurmdTimeout={{ slurm_node_timeout }}
InactiveLimit=0
MinJobAge=300
KillWait=30
Waittime=0

# =============================================================================
# PROCESS TRACKING (DEEPOPS КОНФИГУРАЦИЯ!)
# =============================================================================
ProctrackType=proctrack/cgroup
TaskPlugin=task/affinity,task/cgroup

# =============================================================================
# PROLOG/EPILOG НАСТРОЙКИ (DEEPOPS!)
# =============================================================================
PrologFlags=Alloc,Serial
Prolog=/etc/slurm/prolog.d/prolog.sh
Epilog=/etc/slurm/epilog.d/epilog.sh

# =============================================================================
# SLURM PLUGINS
# =============================================================================
SwitchType=switch/none
MpiDefault=none
{% if groups['gpu_nodes'] is defined and groups['gpu_nodes'] | length > 0 %}
GresTypes=gpu
{% endif %}

# =============================================================================
# NODE DEFINITIONS (АВТООПРЕДЕЛЕНИЕ РЕСУРСОВ)
# =============================================================================
{% for host in groups['compute_nodes'] %}
{% set node_facts = hostvars[host] %}
NodeName={{ host }} \
    CPUs={{ node_facts.ansible_processor_vcpus | default(4) }} \
    RealMemory={{ ((node_facts.ansible_memtotal_mb | default(12000)) * 0.9) | int }} \
    TmpDisk={{ ((node_facts.ansible_mounts | default([]) | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first | default(60000000000) ) / 1024 / 1024 * 0.8) | int }} \
{% if host in groups['gpu_nodes'] | default([]) %}
    Gres=gpu:{{ hostvars[host]['gpu_type'] | default('a100') }}:{{ hostvars[host]['gpu_count'] | default(8) }} \
{% endif %}
    State={{ slurm_node_defaults.state }}
{% endfor %}

# =============================================================================
# PARTITION DEFINITIONS
# =============================================================================
{% for partition in slurm_partitions %}
PartitionName={{ partition.name }} \
    Nodes={{ partition.nodes }} \
    Default={{ partition.default | default(false) | ternary('YES', 'NO') }} \
    MaxTime={{ partition.max_time | default('INFINITE') }} \
    State={{ partition.state | default('UP') }}
{% endfor %}

# =============================================================================
# FOOTER
# =============================================================================
#
# Configuration generated for {{ slurm_cluster_name }}
# Master: {{ slurm_controller_host }} ({{ slurm_controller_addr }})
# Nodes: {{ groups['compute_nodes'] | length }} compute nodes
# Date: {{ ansible_date_time.iso8601 }}
#