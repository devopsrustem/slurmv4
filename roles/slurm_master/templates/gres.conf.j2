# roles/slurm_master/templates/gres.conf.j2
#
# Generic Resource (GRES) Configuration File
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Cluster: {{ slurm_cluster_name }}
#

# =============================================================================
# GPU CONFIGURATION
# =============================================================================

# Automatic GPU detection via NVML
AutoDetect=nvml

{% if groups['gpu_nodes'] is defined and groups['gpu_nodes'] | length > 0 %}
# =============================================================================
# NODE-SPECIFIC GPU DEFINITIONS
# =============================================================================
{% for host in groups['gpu_nodes'] %}
{% set node_info = hostvars[host] %}

# {{ host }} - {{ node_info.gpu_type | default('h100') }} GPUs
{% if node_info.gpu_count is defined and node_info.gpu_count > 0 %}
NodeName={{ host }} Name=gpu Type={{ node_info.gpu_type | default('h100') }} File=/dev/nvidia[0-{{ node_info.gpu_count - 1 }}]
{% else %}
NodeName={{ host }} Name=gpu Type=h100 File=/dev/nvidia[0-7]
{% endif %}

{% endfor %}
{% else %}
# No GPU nodes defined in inventory
{% endif %}

# =============================================================================
# GPU TYPES CONFIGURATION
# =============================================================================

{% if groups['gpu_nodes'] is defined %}
{% set gpu_types = [] %}
{% for host in groups['gpu_nodes'] %}
{% set node_info = hostvars[host] %}
{% set gpu_type = node_info.gpu_type | default('h100') %}
{% if gpu_type not in gpu_types %}
{% set _ = gpu_types.append(gpu_type) %}
{% endif %}
{% endfor %}

# Supported GPU types in cluster:
{% for gpu_type in gpu_types %}
# - {{ gpu_type }}
{% endfor %}
{% endif %}

# =============================================================================
# ADVANCED GPU SETTINGS
# =============================================================================

# GPU memory binding (optional)
# NodeName=cn[01-64] Name=gpu Type=h100 File=/dev/nvidia[0-7] Cores=0-7,8-15,16-23,24-31,32-39,40-47,48-55,56-63

# GPU frequency settings (optional)
# NodeName=cn[01-64] Name=gpu Type=h100 File=/dev/nvidia[0-7] Freq=1410-1980

# =============================================================================
# OTHER RESOURCES (если нужны)
# =============================================================================

# MIC (Many Integrated Core) - если есть Intel Xeon Phi
# NodeName=node[1-10] Name=mic Count=2 File=/dev/mic[0-1]

# FPGA - если есть FPGA карты  
# NodeName=node[1-5] Name=fpga Count=1 File=/dev/fpga0

# InfiniBand - если нужно отслеживать IB порты
# NodeName=cn[01-64] Name=bandwidth Count=1

# =============================================================================
# FOOTER
# =============================================================================
#
# GRES configuration for {{ slurm_cluster_name }}
# Total GPU nodes: {{ groups['gpu_nodes'] | default([]) | length }}
# Generated: {{ ansible_date_time.iso8601 }}
#