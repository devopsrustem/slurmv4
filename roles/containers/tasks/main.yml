# roles/containers/tasks/main.yml
---
# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê ENROOT + PYXIS (–û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –ü–û–î–•–û–î)
# =============================================================================

- name: "[CONTAINERS] –ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
  debug:
    msg: |
      üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot + Pyxis –Ω–∞ {{ inventory_hostname }}
      üìç –†–æ–ª—å: {{ group_names | join(', ') }}
      üéØ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: make install + –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥

# =============================================================================
# –ü–†–û–í–ï–†–ö–ê –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–• –¢–†–ï–ë–û–í–ê–ù–ò–ô
# =============================================================================

- name: "[CONTAINERS] –ü—Ä–æ–≤–µ—Ä–∫–∞ Slurm headers"
  stat:
    path: "{{ slurm_install_prefix }}/include/slurm/spank.h"
  register: headers_check
  failed_when: not headers_check.stat.exists

# - name: "[CONTAINERS] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ headers"
#   debug:
#     msg: |
#       ‚úÖ Headers –Ω–∞–π–¥–µ–Ω—ã: {{ slurm_install_prefix }}/include/slurm/spank.h
#       üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ ansible_facts | json_query('[?path==`' + slurm_install_prefix + '/include`] | length(@)') | default('–º–Ω–æ–≥–æ') }}

# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê –°–ò–°–¢–ï–ú–ù–´–• –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# =============================================================================

- name: "[CONTAINERS] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
  apt:
    name: "{{ enroot_system_packages + pyxis_build_packages }}"
    state: present
    update_cache: yes

- name: "[CONTAINERS] –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π"
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ enroot_config_dir }}"
    - "{{ enroot_data_dir }}"
    - "{{ enroot_cache_dir }}"
    - "{{ enroot_runtime_path }}"
    - "{{ plugstack_config_dir }}"
    - /tmp/containers-build

# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê ENROOT
# =============================================================================

- name: "[ENROOT] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
  command: enroot version
  register: enroot_check
  failed_when: false
  changed_when: false

- name: "[ENROOT] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot"
  block:
    - name: "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ Enroot DEB"
      get_url:
        url: "{{ enroot_download_url }}/enroot_{{ enroot_version }}-1_amd64.deb"
        dest: "/tmp/containers-build/enroot_{{ enroot_version }}-1_amd64.deb"
        timeout: 300
        
    - name: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot –∏–∑ DEB"
      apt:
        deb: "/tmp/containers-build/enroot_{{ enroot_version }}-1_amd64.deb"
        state: present
  when: enroot_check.rc != 0

- name: "[ENROOT] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Enroot"
  template:
    src: enroot.conf.j2
    dest: "{{ enroot_config_dir }}/enroot.conf"
    mode: '0644'

# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê PYXIS (–û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –°–ü–û–°–û–ë!)
# =============================================================================

- name: "[PYXIS] –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"
  file:
    path: "{{ pyxis_build_dir }}"
    state: absent
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']

- name: "[PYXIS] –°–æ–∑–¥–∞–Ω–∏–µ build –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
  file:
    path: "{{ pyxis_build_dir }}"
    state: directory
    mode: '0755'
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']

- name: "[PYXIS] –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤"
  get_url:
    url: "{{ pyxis_download_url }}"
    dest: "/tmp/containers-build/pyxis-{{ pyxis_version }}.tar.gz"
    timeout: 300
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']

- name: "[PYXIS] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤"
  unarchive:
    src: "/tmp/containers-build/pyxis-{{ pyxis_version }}.tar.gz"
    dest: "{{ pyxis_build_dir }}"
    remote_src: yes
    extra_opts: ["--strip-components=1"]
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']

- name: "[PYXIS] –û–§–ò–¶–ò–ê–õ–¨–ù–ê–Ø –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞"
  shell: |
    cd {{ pyxis_build_dir }}
    
    echo "=== –û–§–ò–¶–ò–ê–õ–¨–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê PYXIS ==="
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º headers: {{ slurm_install_prefix }}/include"
    
    # –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ headers
    export CPPFLAGS="-I{{ slurm_install_prefix }}/include"
    export LDFLAGS="-L{{ slurm_install_prefix }}/lib"
    
    # –û—á–∏—Å—Ç–∫–∞ –∏ —Å–±–æ—Ä–∫–∞
    make clean || true
    make
    
    # –û–§–ò–¶–ò–ê–õ–¨–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê (–∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç!)
    sudo make install
    
    echo "‚úÖ Pyxis —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ!"
    echo "–ü–ª–∞–≥–∏–Ω: $(find /usr/local -name 'spank_pyxis.so' -type f)"
    echo "–ö–æ–Ω—Ñ–∏–≥: $(find /usr/local -name 'pyxis.conf' -type f)"
    
  register: pyxis_install
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login'] or ['slurm_master']

- name: "[PYXIS] –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
  debug:
    var: pyxis_install.stdout_lines
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']

# =============================================================================
# –û–§–ò–¶–ò–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–∫–∞–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏!)
# =============================================================================

- name: "[CONFIG] –°–æ–∑–¥–∞–Ω–∏–µ plugstack.conf.d –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
  file:
    path: "{{ plugstack_config_dir }}"
    state: directory
    mode: '0755'
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']

- name: "[CONFIG] –û–§–ò–¶–ò–ê–õ–¨–ù–ê–Ø —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥"
  file:
    src: /usr/local/share/pyxis/pyxis.conf
    dest: "{{ plugstack_config_dir }}/pyxis.conf"
    state: link
    force: yes
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']

# =============================================================================
# –ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
# =============================================================================

- name: "[RESTART] –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd –Ω–∞ compute —É–∑–ª–∞—Ö"
  systemd:
    name: slurmd
    state: restarted
    daemon_reload: yes
  when: inventory_hostname in groups['slurm_compute']

- name: "[RESTART] –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
  pause:
    seconds: 3

# =============================================================================
# –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò
# =============================================================================

- name: "[VERIFY] –ü—Ä–æ–≤–µ—Ä–∫–∞ Enroot"
  command: enroot version
  register: enroot_verify
  changed_when: false

- name: "[VERIFY] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ Pyxis"
  shell: |
    echo "=== –ü–†–û–í–ï–†–ö–ê PYXIS ==="
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–ª–∞–≥–∏–Ω
    if [ -f /usr/local/lib/slurm/spank_pyxis.so ]; then
      echo "‚úÖ –ü–ª–∞–≥–∏–Ω: $(ls -la /usr/local/lib/slurm/spank_pyxis.so)"
    else
      echo "‚ùå –ü–ª–∞–≥–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥
    if [ -f /usr/local/share/pyxis/pyxis.conf ]; then
      echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥: $(ls -la /usr/local/share/pyxis/pyxis.conf)"
    else
      echo "‚ùå –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω"  
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫—É
    if [ -L {{ plugstack_config_dir }}/pyxis.conf ]; then
      echo "‚úÖ –°—Å—ã–ª–∫–∞: $(ls -la {{ plugstack_config_dir }}/pyxis.conf)"
    else
      echo "‚ùå –°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
    fi
    
  register: pyxis_verify
  when: inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login']
  changed_when: false

- name: "[VERIFY] –ü—Ä–æ–≤–µ—Ä–∫–∞ slurmd (—Ç–æ–ª—å–∫–æ compute)"
  shell: systemctl is-active slurmd
  register: slurmd_verify
  when: inventory_hostname in groups['slurm_compute']
  failed_when: false
  changed_when: false

# =============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# =============================================================================

- name: "[CONTAINERS] –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
  debug:
    msg: |
      ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {{ inventory_hostname }}!
      
      üì¶ Enroot: {{ enroot_verify.stdout }}
      
      {% if inventory_hostname in groups['slurm_compute'] or inventory_hostname in groups['slurm_login'] %}
      üîå Pyxis (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞):
      {{ pyxis_verify.stdout }}
      
      {% if inventory_hostname in groups['slurm_compute'] %}
      üîß slurmd: {{ slurmd_verify.stdout | default('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') }}
      {% endif %}
      {% endif %}
      
      üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
      - make install (—Å–∏—Å—Ç–µ–º–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞)  
      - –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥ —á–µ—Ä–µ–∑ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
      - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ compute –ò login —É–∑–ª–∞—Ö
      
      üöÄ –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤!