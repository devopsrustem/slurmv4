# roles/containers/templates/enroot.conf.j2
#
# Enroot Configuration File
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Cluster: {{ slurm_cluster_name | default('hpc-cluster') }}
#

# =============================================================================
# ОСНОВНЫЕ ПУТИ
# =============================================================================

# Корневая директория данных Enroot
ENROOT_DATA_PATH {{ enroot_data_dir }}

# Кеш для образов
ENROOT_CACHE_PATH {{ enroot_cache_dir }}

# Временная директория
ENROOT_TEMP_PATH {{ enroot_temp_dir }}

# Runtime директория
ENROOT_RUNTIME_PATH {{ enroot_runtime_path }}

# =============================================================================
# ПОЛЬЗОВАТЕЛЬСКИЕ НАСТРОЙКИ (как в продакшене - для всех пользователей)
# =============================================================================

# Разрешить всем пользователям создавать контейнеры
ENROOT_ALLOW_SUPERUSER yes

# Максимальное количество контейнеров на пользователя
ENROOT_MAX_CONTAINERS {{ enroot_max_containers_per_user }}

# =============================================================================
# МОНТИРОВАНИЕ И BIND MOUNTS
# =============================================================================

# Автоматические bind mounts для HPC
{% for mount in enroot_bind_mounts %}
ENROOT_MOUNT_HOME {{ mount }}
{% endfor %}

# Монтировать /tmp в контейнер
{% if enroot_mount_tmp %}
ENROOT_MOUNT_TMP yes
{% else %}
ENROOT_MOUNT_TMP no
{% endif %}

# =============================================================================
# БЕЗОПАСНОСТЬ ДЛЯ HPC
# =============================================================================

# Разрешить privileged контейнеры (нужно для HPC + GPU)
{% if enroot_allow_privileged %}
ENROOT_ALLOW_PRIVILEGED yes
{% else %}
ENROOT_ALLOW_PRIVILEGED no
{% endif %}

# Разрешить setuid в контейнерах
{% if enroot_allow_setuid %}
ENROOT_ALLOW_SETUID yes
{% else %}
ENROOT_ALLOW_SETUID no
{% endif %}

# Ограничить доступ к /dev
{% if enroot_restrict_dev %}
ENROOT_RESTRICT_DEV yes
{% else %}
ENROOT_RESTRICT_DEV no
{% endif %}

# =============================================================================
# GPU ПОДДЕРЖКА
# =============================================================================

# Включить NVIDIA GPU поддержку
{% if enroot_gpu_support %}
ENROOT_MOUNT_NVIDIA yes
{% else %}
ENROOT_MOUNT_NVIDIA no
{% endif %}

# =============================================================================
# РЕСУРСЫ И ЛИМИТЫ
# =============================================================================

# Максимальное количество процессоров
ENROOT_MAX_PROCESSORS {{ enroot_max_processors }}

# Максимальный объем памяти
ENROOT_MAX_MEMORY {{ enroot_max_memory }}

# =============================================================================
# ЛОГИРОВАНИЕ
# =============================================================================

# Уровень логирования (ERROR, WARN, INFO, DEBUG)
ENROOT_LOG_LEVEL {{ enroot_log_level }}

# =============================================================================
# ОБРАЗЫ И REGISTRY
# =============================================================================

# Поддержка SquashFS образов
{% if container_squashfs_support %}
ENROOT_SQUASH_OPTIONS -comp gzip -noappend
{% endif %}

# Настройки сжатия
ENROOT_GZIP_PROGRAM pigz
ENROOT_ZSTD_OPTIONS -1

# =============================================================================
# HOOKS И PLUGINS
# =============================================================================

# Путь к дополнительным hooks
ENROOT_HOOKS_PATH {{ enroot_config_dir }}/hooks.d

# =============================================================================
# ADVANCED SETTINGS
# =============================================================================

# SSL сертификаты для registry доступа
ENROOT_SSL_VERIFY yes

# Таймаут для операций с образами
ENROOT_CONNECT_TIMEOUT 30
ENROOT_TRANSFER_TIMEOUT 0

# Временная файловая система для /tmp в контейнере
ENROOT_TMPFS_SIZE 16g

# =============================================================================
# FOOTER
# =============================================================================
#
# Enroot configuration for {{ slurm_cluster_name | default('hpc-cluster') }}
# Node: {{ inventory_hostname }}
# Generated: {{ ansible_date_time.iso8601 }}
# HPC optimized with GPU support: {{ enroot_gpu_support | ternary('enabled', 'disabled') }}
#