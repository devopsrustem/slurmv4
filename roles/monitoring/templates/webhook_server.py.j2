from flask import Flask, request, abort
import subprocess
import os
import datetime

app = Flask(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
EXPECTED_TOKEN = "{{ cluster_poweroff_webhook_token | default('7b54a1cfd7db43452') }}"
STATE_FILE = "/tmp/cluster_shutdown.lock"
LOG_FILE = "/var/log/cluster_shutdown.log"
SCRIPT_PATH = "/usr/local/bin/shutdown_cluster.sh"
TARGET_ALERT = 'CLUSTER-POWEROFF'

def log_event(message):
    timestamp = datetime.datetime.now().strftime("%a %b %e %I:%M:%S %p MSK %Y")
    with open(LOG_FILE, "a") as logf:
        logf.write(f"{timestamp} {message}\n")

def shutdown_already_triggered():
    return os.path.exists(STATE_FILE)

@app.route("/alert", methods=["POST"])
def alertmanager_webhook():
    token = request.args.get("token")
    if token != EXPECTED_TOKEN:
        log_event("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞")
        abort(403)

    data = request.get_json()
    if not data or "alerts" not in data:
        log_event("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç Alertmanager")
        abort(400)

    matched = False
    for alert in data.get('alerts', []):
        if alert['labels'].get('alertname') == TARGET_ALERT:
            matched = True
            break

    if not matched:
        log_event("‚ÑπÔ∏è –ü–æ–ª—É—á–µ–Ω –Ω–µ—Ü–µ–ª–µ–≤–æ–π –∞–ª–µ—Ä—Ç, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")
        return "Alert ignored", 200

    if shutdown_already_triggered():
        log_event("‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ ‚Äî –∫–ª–∞—Å—Ç–µ—Ä —É–∂–µ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è")
        return "Already triggered", 200

    # –°–æ–∑–¥–∞–µ–º lock-—Ñ–∞–π–ª
    open(STATE_FILE, "w").close()

    try:
        log_event(f"üîî –ü–æ–ª—É—á–µ–Ω –∞–ª–µ—Ä—Ç '{TARGET_ALERT}' ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –æ—Ç –∏–º–µ–Ω–∏ {{ cluster_poweroff_user | default('master') }}")
        subprocess.Popen(["sudo", "-u", "{{ cluster_poweroff_user | default('master') }}", SCRIPT_PATH])
        return "Cluster shutdown initiated", 200
    except Exception as e:
        log_event(f"‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è: {e}")
        if os.path.exists(STATE_FILE):
            os.remove(STATE_FILE)
        abort(500)

if __name__ == "__main__":
    app.run(host="{{ cluster_poweroff_webhook_host | default('0.0.0.0') }}", port={{ cluster_poweroff_webhook_port | default('5001') }})
    