groups:
    - name: default
      rules:
      - alert: InstanceDown
        expr: up == 0
        for: {{ alert_instance_down_for | default('5m') }}
        labels:
          severity: critical
        annotations:
          summary: {% raw %}"{{ $labels.job }} job has been down > {% endraw %}{{ alert_instance_down_for | default('5m') }}{% raw %} on üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"{{ $labels.job }} job has been down > {% endraw %}{{ alert_instance_down_for | default('5m') }}{% raw %} on üî•{{ $labels.instance }}"{% endraw %}

#Alerts fo MSU-Argo-tech

   #–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê –í –¶–û–î–ï
    - name: CLUSTER-POWEROFF
      rules:
      - alert: CLUSTER-POWEROFF
        expr: avg (ipmi_temperature_celsius {name="Inlet Temp"}) > {{ cluster_poweroff_temp_threshold | default('45') }}
        for: {{ cluster_poweroff_wait_time | default('1h') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî• !!!–ö–û–ù–î–ò–¶–ò–û–ù–ï–†–´ –ù–ï –†–ê–ë–û–¢–ê–Æ–¢!!! –°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞ –≤–æ–∑–¥—É—Ö–∞ {{ humanize $value }}¬∞C. –ö–õ–ê–°–¢–ï–† –ë–£–î–ï–¢ –í–´–ö–õ–Æ–ß–ï–ù –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò!üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•"{% endraw %}
          description: {% raw %}"üî•üî•üî•üî•üî•üî•üî•üî• !!–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç!!! –°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞ –≤–æ–∑–¥—É—Ö–∞ {{ humanize $value }}¬∞C. –ö–ª–∞—Å—Ç–µ—Ä –±—É–¥–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! üî•üî•üî•üî•üî•üî•üî•üî•"{% endraw %}


    - name: quantile
      rules:
      - alert: InletTemperatureIncreasing
        expr: |
          avg (quantile_over_time(0.9, ipmi_temperature_celsius{name="Inlet Temp"}[1h]))
          - avg (quantile_over_time(0.1, ipmi_temperature_celsius{name="Inlet Temp"}[1h])) > {{ inlet_temp_quantile_threshold | default('3') }}
        for: 0m
        labels:
          severity: page
        annotations:
          summary: {% raw %}"üî•üî•üî•üî•üî•üî•üî•üî• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –ú–∞—à –∑–∞–ª–µ —Ä–∞—Å—Ç—ë—Ç –Ω–∞ {{ humanize $value }}, –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ üî•üî•üî•üî•üî•üî•üî•üî•"{% endraw %}
          description: {% raw %}"üî•üî•üî•üî•üî•üî•üî•üî• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ Inlet Temp –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å –Ω–∞ {{ humanize $value }}¬∞C –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å üî•üî•üî•üî•üî•üî•üî•üî•"{% endraw %}

    - name: avg
      rules:
      - alert: InletTemperatureRising
        expr: |
          avg(ipmi_temperature_celsius{name="Inlet Temp"})
          - avg(ipmi_temperature_celsius{name="Inlet Temp"} offset 1h) > {{ inlet_temp_rise_threshold | default('3') }}
        for: 0m
        labels:
          severity: page
        annotations:
          summary: {% raw %}"üî•üî•üî•üî•üî•üî•üî•üî• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞ –≤—Ö–æ–¥–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ {{ humanize $value }}¬∞C üî•üî•üî•üî•üî•üî•üî•üî•"{% endraw %}
          description: {% raw %}"üî•üî•üî•üî•üî•üî•üî•üî• –í –º–∞—à.–∑–∞–ª–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–Ω—è–ª–∞—Å—å –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 0.1 ¬∞C –∑–∞ —á–∞—Å üî•üî•üî•üî•üî•üî•üî•üî•"{% endraw %}


   #SLURM
      - alert: slurm_nodes_comp
        expr: slurm_nodes_comp > 0
        for: {{ slurm_alert_wait_time | default('10m') }}
        labels:
          severity: page
        annotations:
          summary: "NODE(S) IS COMPLEATING MORE THEN {{ slurm_alert_wait_time | default('10m') }}"
          description: "pay attention ON SLURM NODES"

      - alert: slurm_nodes_down
        expr: slurm_nodes_down > 0
        for: {{ slurm_alert_wait_time | default('10m') }}
        labels:
          severity: page
        annotations:
          summary: "NODE(S) IS DOWN MORE THEN {{ slurm_alert_wait_time | default('10m') }}"
          description: "pay attention ON SLURM NODES"

      - alert: slurm_nodes_fail
        expr: slurm_nodes_fail > 0
        for: {{ slurm_alert_wait_time | default('10m') }}
        labels:
          severity: page
        annotations:
          summary: "NODE(S) IS FAIL MORE THEN {{ slurm_alert_wait_time | default('10m') }}"
          description: "pay attention ON SLURM NODES"

      - alert: slurm_nodes_err
        expr: slurm_nodes_err > 0
        for: {{ slurm_alert_wait_time | default('10m') }}
        labels:
          severity: page
        annotations:
          summary: "NODE(S) IS ERROR MORE THEN {{ slurm_alert_wait_time | default('10m') }}"
          description: "pay attention ON SLURM NODES"


   #ALL_TEMPERATURE

      - alert: CHIP_IS_HOT
        expr: node_hwmon_temp_celsius > {{ chip_hot_threshold | default('90') }}
        for: {{ chip_hot_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.chip }} IS VERY HOT üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"{{ $labels.chip }} ON {{ $labels.instance }} is MORE {% endraw %}{{ chip_hot_threshold | default('90') }}{% raw %} DEGREES"{% endraw %}


   #filesystem

      - alert: READ ONLY FILE SYSTEM
        expr: node_filesystem_readonly {job!="sfa-node-exp"}  == 1
        for: {{ filesystem_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.device }} IS READ ONLY ON üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"FILE SYSTEM {{ $labels.device }} is NOT writeble"{% endraw %}

      - alert: READ ONLY LUSTRE FILE SYSTEM
        expr: count (node_filesystem_readonly {fstype="lustre", job="sfa-node-exp"} >0) != {{ lustre_expected_drives | default('95') }}
        for: {{ filesystem_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: "‚≠êÔ∏èPROBLEM WITH LUSTRE DRIVE(s)‚≠êÔ∏è"
          description: "‚≠êPROBLEM WITH LUSTRE DRIVE(s)‚≠ê"

      - alert: low_disk_space
        expr: ((node_filesystem_size_bytes{device!~"(rootfs|tmpfs|/dev/fuse)"} - node_filesystem_avail_bytes{device!~"(rootfs|tmpfs|/dev/fuse)"}) / node_filesystem_size_bytes{device!~"(rootfs|tmpfs)"}) *100 > {{ disk_space_threshold | default('90') }}
        for: {{ filesystem_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.device }} IS LOW DISK SPACE ON üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"DISK SPACE ON {{ $labels.instance }} üî•{{ $labels.device }} is LESS then {% endraw %}{{ disk_space_threshold | default('90') }}%"

   #IPMI

    - name: ipmi
      rules:
      - alert: –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–æ–∫–æ–≤ –ø–∏—Ç–∞–Ω–∏—è –∏ –±–∞—Ç–∞—Ä–µ–π–∫–∏
        expr: ipmi_sensor_state == 2
        for: {{ ipmi_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.name }} : Ther is NO power on üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"{{ $labels.name }} : Ther is NO power on üî•{{ $labels.instance }}"{% endraw %}

      - alert: ipmi_chassis_power_state
        expr: ipmi_chassis_power_state{job="ipmi_exporter"} == 0
        for: {{ ipmi_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"Chassis Power State OFF üî•{{ $labels.instance }}"{% endraw %}

      - alert: ipmi_up
        expr: ipmi_up{job="ipmi_exporter"} == 0
        for: {{ ipmi_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"IPMI does not collect sensors value on üî•{{ $labels.instance }}"{% endraw %}

      - alert: –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫—É–ª–ª–µ—Ä–æ–≤
        expr: ipmi_fan_speed_state  == 2
        for: {{ ipmi_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.name }} speed is 0 rpm on node üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"Fan {{ $labels.name }} is NOT working"{% endraw %}

      - alert: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–µ–Ω—Å–æ—Ä–æ–≤ IPMI
        expr: ipmi_temperature_state  == 2
        for: {{ ipmi_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.name }} is CRITICAL on node üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"{{ $labels.name }} is CRITICAL"{% endraw %}

      - alert: –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
        expr: ipmi_voltage_state  == 2
        for: {{ ipmi_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.name }} is CRITICAL on node üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"{{ $labels.name }} is CRITICAL"{% endraw %}
   #RAM
      - alert: –û–±—ä–µ–º –û–ó–£
        expr: node_memory_MemTotal_bytes {job="cluster", instance!~"ufm.*"} < {{ expected_ram_bytes | default('2164301000000') }}
        for: {{ ram_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"RAM is not 2TiB on node üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"RAM is not 2TiB on node üî•{{ $labels.instance }}"{% endraw %}
   #network
      - alert: –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
        expr: node_network_up{device=~"{{ network_interfaces_regex | default('ens.+|enp.+|bond0') }}", instance!~"ufm.*"} == 0
        for: {{ network_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.device }} is DOWN on node üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"{{ $labels.device }} is DOWN on node üî•{{ $labels.instance }}"{% endraw %}
   #IB
      - alert: –°–æ—Å—Ç–æ—è–Ω–∏–µ INFINIBAND
        expr: node_infiniband_state_id {instance!~"ufm.*"} == 1
        for: {{ ib_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"{{ $labels.device }} is DOWN on node üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"{{ $labels.device }} is DOWN on node üî•{{ $labels.instance }}"{% endraw %}

      - alert: UFM-NETWORK
        expr: count (node_infiniband_info {instance=~"(cn.*)"}) by (instance) != {{ expected_ib_cards | default('11') }}
        for: {{ ib_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"üî•–ù–ï–ò–°–ü–†–ê–í–ù–ê –û–î–ù–ê –ò–ó –ö–ê–†–¢ IB –ù–ê üî•{{ $labels.instance }}"{% endraw %}
          description: {% raw %}"üî•–ù–ï–ò–°–ü–†–ê–í–ù–ê –û–î–ù–ê –ò–ó –ö–ê–†–¢ IB –ù–ê üî•{{ $labels.instance }}"{% endraw %}

      - alert: PCIE_Link_Downgraded
        expr: pcie_link_status == 0
        for: {{ pcie_alert_wait_time | default('10m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"PCIe Link DOWNGRADE on {{ $labels.instance }} HCA {{ $labels.rdma }} Serial: {{ $labels.serial }}"{% endraw %}
          description: >
            {% raw %}PCIe link on device {{ $labels.device }} ({{ $labels.name }}, RDMA: {{ $labels.rdma }})
            is operating below its maximum width ({{ $labels.cap }} ‚Üí {{ $labels.sta }}).
            Host: {{ $labels.instance }}. Serial: {{ $labels.serial }}{% endraw %}


   #UFM

      - alert: UFM-COMPUTE-NETWORK
        expr: count (switch_current {job="ufm", node_description!~"cn(.*)"}) != {{ ufm_compute_expected_ports | default('2032') }}
        for: {{ ufm_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: "üî•–ò–ó–ú–ï–ù–ò–õ–û–°–¨ –ö–û–õ–ò–ß–ï–°–¢–í–û –ê–ö–¢–ò–í–ù–´–• –ü–û–†–¢–û–í COMPUTE –°–ï–¢–òüî•"
          description: "üî•–ò–ó–ú–ï–ù–ò–õ–û–°–¨ –ö–û–õ–ò–ß–ï–°–¢–í–û –ê–ö–¢–ò–í–ù–´–• –ü–û–†–¢–û–í COMPUTE –°–ï–¢–òüî•"

      - alert: UFM-COMPUTE-NET-DOWN-PORTS
        expr: count (switch_current {job="ufm", node_description!~"cn(.*)"}) by (node_description) !={{ ufm_compute_allowed_ports | default('33') }} !={{ ufm_compute_allowed_ports_alt1 | default('34') }} !={{ ufm_compute_allowed_ports_alt2 | default('41') }} !={{ ufm_compute_allowed_ports_alt3 | default('52') }} !={{ ufm_compute_allowed_ports_alt4 | default('1') }} !={{ ufm_compute_allowed_ports_alt5 | default('21') }}
        for: {{ ufm_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"üî•DOWN ports on switch üî•{{ $labels.node_description }}"{% endraw %}
          description: {% raw %}"üî•DOWN ports on switch üî•{{ $labels.node_description }}"{% endraw %}

##### –Ω–µ —É—á—Ç–µ–Ω—ã 2 –ø–æ—Ä—Ç–∞ sl3:26 –∏ sl4:26   
      - alert: UFM-STORAGE-NETWORK
        expr: count (switch_current {job="ufm-sn"}) != {{ ufm_storage_expected_ports | default('772') }}
        for: {{ ufm_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: "üî•–ò–ó–ú–ï–ù–ò–õ–û–°–¨ –ö–û–õ–ò–ß–ï–°–¢–í–û –ê–ö–¢–ò–í–ù–´–• –ü–û–†–¢–û–í STORAGE –°–ï–¢–òüî•"
          description: "üî•–ò–ó–ú–ï–ù–ò–õ–û–°–¨ –ö–û–õ–ò–ß–ï–°–¢–í–û –ê–ö–¢–ò–í–ù–´–• –ü–û–†–¢–û–í STORAGE –°–ï–¢–òüî•"


   #UFM-SWITCHES

      - alert: –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ –Ω–∞ —Å–≤–∏—Ç—á–∞—Ö Infiniband
        expr: iblinkinfo_physical_state_id !=3 !=5
        for: {{ ufm_switch_alert_wait_time | default('1m') }}
        labels:
          severity: page
        annotations:
          summary: {% raw %}"üî• {{ $labels.src_switch }} port {{ $labels.src_port }} is DOWN"{% endraw %}
          description: {% raw %}"üî• {{ $labels.src_switch }} port {{ $labels.src_port }} is DOWN"{% endraw %}

     #SM

      - alert: SubnetManagerDown
        expr: infiniband_sm_state == 0
        for: {{ sm_alert_wait_time | default('2m') }}
        labels:
          severity: critical
        annotations:
          summary: {% raw %}"‚ùå ‚ùå ‚ùå Subnet Manager is DOWN on {{ $labels.instance }} ‚ùå ‚ùå ‚ùå"{% endraw %}
          description: >
            {% raw %}Subnet Manager (SM) reported state DOWN (0) on host {{ $labels.instance }}.
            Possible cause: SM is not running or Infiniband fabric is unreachable.{% endraw %}