# roles/login_nodes/tasks/main.yml
---
# –†–æ–ª—å: login_nodes - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Login —É–∑–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

- name: "[SLURM-LOGIN] –ù–∞—á–∞–ª–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Slurm Login —É–∑–ª–∞"
  debug:
    msg: |
      Configuring Slurm Login node: {{ inventory_hostname }}
      Master: {{ master_nodes_host }}
      Setting up user access to cluster

# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ü–ê–ö–ï–¢–û–í –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
# =============================================================================

- name: "[SLURM-LOGIN] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  apt:
    name: "{{ login_node_packages }}"
    state: present
    update_cache: yes
  tags:
    - packages

# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê SLURM –ö–õ–ò–ï–ù–¢–°–ö–ò–• –ö–û–ú–ê–ù–î
# =============================================================================

- name: "[SLURM-LOGIN] –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Slurm"
  file:
    path: "{{ slurm_install_prefix }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - install

- name: "[SLURM-LOGIN] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Slurm –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –∏–∑ NFS"
  shell: |
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    mkdir -p {{ slurm_install_prefix }}/bin
    mkdir -p {{ slurm_install_prefix }}/lib
    mkdir -p {{ slurm_install_prefix }}/share
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ù–ï –¥–µ–º–æ–Ω—ã)
    cp -r {{ nfs_slurm_path }}/bin/* {{ slurm_install_prefix }}/bin/
    cp -r {{ nfs_slurm_path }}/lib/* {{ slurm_install_prefix }}/lib/
    cp -r {{ nfs_slurm_path }}/share/* {{ slurm_install_prefix }}/share/
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
    chown -R root:root {{ slurm_install_prefix }}
    chmod -R 755 {{ slurm_install_prefix }}/bin
    
    echo "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ $(ls {{ slurm_install_prefix }}/bin | wc -l) –∫–æ–º–∞–Ω–¥"
  register: client_install
  tags:
    - install

- name: "[SLURM-LOGIN] –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤"
  debug:
    var: client_install.stdout_lines
  tags:
    - install

# =============================================================================
# –°–û–ó–î–ê–ù–ò–ï –°–ò–ú–í–û–õ–ò–ß–ï–°–ö–ò–• –°–°–´–õ–û–ö
# =============================================================================

- name: "[SLURM-LOGIN] –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è Slurm –∫–æ–º–∞–Ω–¥"
  file:
    src: "{{ slurm_install_prefix }}/bin/{{ item }}"
    dest: "/usr/bin/{{ item }}"
    state: link
    force: yes
  loop: "{{ slurm_client_commands }}"
  tags:
    - links

- name: "[SLURM-LOGIN] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–≥–æ –∫–µ—à–∞"
  shell: ldconfig
  tags:
    - links

# =============================================================================
# –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–• –§–ê–ô–õ–û–í
# =============================================================================

- name: "[SLURM-LOGIN] –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ NFS"
  wait_for:
    path: "{{ nfs_config_path }}/{{ item }}"
    timeout: 30
  loop: "{{ slurm_config_files }}"
  tags:
    - config

- name: "[SLURM-LOGIN] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ NFS"
  copy:
    src: "{{ nfs_config_path }}/{{ item }}"
    dest: "{{ slurm_config_dir }}/{{ item }}"
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
    backup: yes
  loop: "{{ slurm_config_files }}"
  tags:
    - config

# =============================================================================
# –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–• –î–ò–†–ï–ö–¢–û–†–ò–ô
# =============================================================================

- name: "[SLURM-LOGIN] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop: "{{ user_directories }}"
  tags:
    - directories

# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–û–ì–û –û–ö–†–£–ñ–ï–ù–ò–Ø
# =============================================================================

- name: "[SLURM-LOGIN] –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è Slurm –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  copy:
    dest: /etc/profile.d/slurm.sh
    mode: '0644'
    content: |
      # Slurm environment for users
      # Generated by Ansible
      
      # Slurm environment variables
      {% for var, value in slurm_env_vars.items() %}
      export {{ var }}="{{ value }}"
      {% endfor %}
      
      # Slurm aliases for convenience
      alias sq='squeue'
      alias si='sinfo'
      alias sj='squeue -u $USER'
      alias scan='scancel'
      
      # Show cluster info on login
      if [ -t 1 ] && command -v sinfo >/dev/null 2>&1; then
        echo "### {{ slurm_cluster_name | upper }} HPC Cluster Status: ###"
        sinfo --summarize 2>/dev/null || echo "Cluster information unavailable"
        echo ""
        echo "NODES(A/I/O/T) –≤ –≤—ã–≤–æ–¥–µ sinfo –æ–∑–Ω–∞—á–∞–µ—Ç:"
        echo "A = Allocated - —É–∑–ª—ã, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–Ω—è—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è–º–∏"
        echo "I = Idle - —Å–≤–æ–±–æ–¥–Ω—ã–µ —É–∑–ª—ã, –≥–æ—Ç–æ–≤—ã–µ –∫ —Ä–∞–±–æ—Ç–µ"
        echo "O = Other - —É–∑–ª—ã –≤ –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö (drain, down, etc.)"
        echo "T = Total - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤"
        echo ""
        echo "üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
        echo "   ‚Ä¢ Slurm-web:    http://10.36.80.9:5011   - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞"
        echo "   ‚Ä¢ Grafana:      http://10.36.80.11:3000  - –î–∞—à–±–æ—Ä–¥—ã"
        echo "   ‚Ä¢ Prometheus:   http://10.36.80.11:9090  - –ú–µ—Ç—Ä–∏–∫–∏"
        echo ""
      fi
  when: slurm_user_profile
  tags:
    - environment

- name: "[SLURM-LOGIN] Bash completion –¥–ª—è Slurm –∫–æ–º–∞–Ω–¥"
  copy:
    dest: /etc/bash_completion.d/slurm
    mode: '0644'
    content: |
      # Slurm bash completion
      # Basic completion for common Slurm commands
      
      _slurm_partitions() {
        local partitions
        partitions=$(sinfo -h -o '%P' 2>/dev/null | sort -u)
        COMPREPLY=($(compgen -W "$partitions" -- "$cur"))
      }
      
      _slurm_nodes() {
        local nodes
        nodes=$(sinfo -h -o '%N' 2>/dev/null | sort -u)
        COMPREPLY=($(compgen -W "$nodes" -- "$cur"))
      }
      
      # Basic completion for srun
      _srun() {
        local cur prev
        COMPREPLY=()
        cur="${COMP_WORDS[COMP_CWORD]}"
        prev="${COMP_WORDS[COMP_CWORD-1]}"
        
        case $prev in
          -p|--partition)
            _slurm_partitions
            return 0
            ;;
          -w|--nodelist)
            _slurm_nodes
            return 0
            ;;
        esac
        
        if [[ $cur == -* ]]; then
          COMPREPLY=($(compgen -W "-p --partition -N -_nodes -n --ntasks -t --time -J --job-name" -- "$cur"))
        fi
      }
      
      complete -F _srun srun
      complete -F _srun sbatch
      complete -F _srun salloc
  when: slurm_completion
  tags:
    - environment

# =============================================================================
# SSH –ù–ê–°–¢–†–û–ô–ö–ò (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
# =============================================================================

- name: "[SLURM-LOGIN] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: yes
  loop:
    - { regexp: '^#?MaxSessions', line: 'MaxSessions {{ ssh_max_sessions }}' }
    - { regexp: '^#?PrintMotd', line: 'PrintMotd yes' }
    - { regexp: '^#?Banner', line: 'Banner /etc/ssh/banner' }
  when: ssh_allow_users
  notify: restart ssh
  tags:
    - ssh

- name: "[SLURM-LOGIN] –°–æ–∑–¥–∞–Ω–∏–µ SSH banner"
  copy:
    dest: /etc/ssh/banner
    mode: '0644'
    content: |
      ================================================================================
      
         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
         ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïë
            ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïë
            ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïë
            ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë
            ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïù
      
      ================================================================================
      
      Welcome to {{ inventory_hostname }} - {{ slurm_cluster_name }} HPC Cluster Login Node
      
      üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
        ‚Ä¢ Slurm-web:     http://10.36.80.9:5011   - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
        ‚Ä¢ Grafana:       http://10.36.80.11:3000  - –î–∞—à–±–æ—Ä–¥—ã
        ‚Ä¢ Prometheus:    http://10.36.80.11:9090  - –ú–µ—Ç—Ä–∏–∫–∏
        ‚Ä¢ Alertmanager:  http://10.36.80.11:9093  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      
      üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–∑–ª–æ–≤:
        ‚Ä¢ Node Exporter:  –ø–æ—Ä—Ç 9100 (–≤—Å–µ —É–∑–ª—ã)
        ‚Ä¢ DCGM Exporter:  –ø–æ—Ä—Ç 9400 (compute —É–∑–ª—ã)
        ‚Ä¢ Slurm Exporter: –ø–æ—Ä—Ç 8080 (master —É–∑–µ–ª)
      
      üíª –ö–æ–º–∞–Ω–¥—ã Slurm:
        sinfo     - View cluster status  
        squeue    - View job queue
        sbatch    - Submit batch job
        srun      - Run interactive job
        scancel   - Cancel job
        
      üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∞–ª–∏–∞—Å—ã:
        sq        - squeue
        si        - sinfo  
        sj        - squeue -u $USER
        
      ================================================================================
  when: ssh_allow_users
  tags:
    - ssh

# =============================================================================
# –ü–†–û–í–ï–†–ö–ê –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò
# =============================================================================

- name: "[SLURM-LOGIN] –¢–µ—Å—Ç Slurm –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥"
  shell: |
    echo "=== –¢–ï–°–¢ SLURM –ö–û–ú–ê–ù–î ==="
    echo "sinfo version: $(/usr/bin/sinfo --version)"
    echo "Cluster ping:"
    /usr/bin/scontrol ping 2>&1 || echo "–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–æ–∂–∏–¥–∞–µ–º–æ –Ω–∞ login —É–∑–ª–µ)"
    echo "Cluster info:"
    /usr/bin/sinfo --summarize 2>&1 || echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
  register: slurm_test
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: "[SLURM-LOGIN] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
  debug:
    var: slurm_test.stdout_lines
  tags:
    - verify

# =============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# =============================================================================

- name: "[SLURM-LOGIN] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Login —É–∑–ª–∞"
  debug:
    msg: |
      Slurm Login node {{ inventory_hostname }} configured successfully.
      Master: {{ master_nodes_host }}
      User directories: {{ user_directories | join(', ') }}
      Slurm commands available in {{ slurm_install_prefix }}/bin