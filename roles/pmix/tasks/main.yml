# roles/pmix/tasks/main.yml - PMIx installation and configuration
---
- name: Check if PMIx is already installed
  stat:
    path: "{{ pmix_prefix }}/bin/pmix_info"
  register: pmix_installed

- name: Skip PMIx build if already installed
  debug:
    msg: "PMIx already installed at {{ pmix_prefix }}"
  when: pmix_installed.stat.exists and not pmix_force_rebuild

- name: Install PMIx build dependencies
  package:
    name:
      - build-essential
      - autoconf
      - automake
      - libtool
      - flex
      - libevent-dev
      - libhwloc-dev
      - zlib1g-dev
    state: present
  when: not pmix_installed.stat.exists or pmix_force_rebuild

- name: Create PMIx build directory
  file:
    path: "{{ pmix_build_dir }}"
    state: directory
  when: not pmix_installed.stat.exists or pmix_force_rebuild

- name: Download PMIx source
  get_url:
    url: "https://github.com/openpmix/openpmix/releases/download/v{{ pmix_version }}/pmix-{{ pmix_version }}.tar.gz"
    dest: "{{ pmix_build_dir }}/pmix-{{ pmix_version }}.tar.gz"
  when: not pmix_installed.stat.exists or pmix_force_rebuild

- name: Extract PMIx source
  unarchive:
    src: "{{ pmix_build_dir }}/pmix-{{ pmix_version }}.tar.gz"
    dest: "{{ pmix_build_dir }}"
    remote_src: yes
    extra_opts:
      - --strip-components=1
  when: not pmix_installed.stat.exists or pmix_force_rebuild

- name: Configure PMIx
  command: >
    ./configure --prefix={{ pmix_prefix }}
    --enable-shared
    --disable-static
  args:
    chdir: "{{ pmix_build_dir }}"
    creates: "{{ pmix_build_dir }}/pmix-{{ pmix_version }}/Makefile"
  when: not pmix_installed.stat.exists or pmix_force_rebuild

- name: Build PMIx
  shell: "make -j$(nproc) > build.log 2>&1"
  args:
    chdir: "{{ pmix_build_dir }}"
  when: not pmix_installed.stat.exists or pmix_force_rebuild

- name: Install PMIx
  shell: "make -j$(nproc) install >> build.log 2>&1"
  args:
    chdir: "{{ pmix_build_dir }}"
  when: not pmix_installed.stat.exists or pmix_force_rebuild

- name: Add PMIx to library path
  lineinfile:
    path: /etc/ld.so.conf.d/pmix.conf
    line: "{{ pmix_prefix }}/lib"
    create: yes
  notify: update ldconfig

- name: Add PMIx to PATH
  lineinfile:
    path: /etc/environment
    regexp: '^PATH='
    line: 'PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:{{ pmix_prefix }}/bin"'
    backup: yes

- name: Update ldconfig
  command: ldconfig

- name: Cleanup build directory
  file:
    path: "{{ pmix_build_dir }}"
    state: absent