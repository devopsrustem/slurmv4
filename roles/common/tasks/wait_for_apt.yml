# roles/common/tasks/wait_for_apt.yml - Disable unattended-upgrades for HPC
---
- name: "Stop unattended-upgrades service"
  systemd:
    name: unattended-upgrades
    state: stopped
    enabled: no
  ignore_errors: yes

- name: "Kill any running unattended-upgrades processes"
  shell: pkill -f unattended-upgr
  failed_when: false
  changed_when: false

- name: "Disable unattended-upgrades configuration"
  lineinfile:
    path: /etc/apt/apt.conf.d/20auto-upgrades
    regexp: '^APT::Periodic::Unattended-Upgrade'
    line: 'APT::Periodic::Unattended-Upgrade "0";'
    create: yes

- name: "Wait for apt lock to be released"
  shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
      echo "Waiting for apt lock..."
      sleep 5
    done
  changed_when: false