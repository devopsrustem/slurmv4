# roles/common/tasks/wait_for_apt.yml - Remove unattended-upgrades for HPC
---
- name: "Check if unattended-upgrades package is installed"
  package_facts:
    manager: apt

- name: "Remove unattended-upgrades package completely"
  apt:
    name: unattended-upgrades
    state: absent
    purge: yes
  when: "'unattended-upgrades' in ansible_facts.packages"



- name: "Wait for apt lock to be released"
  shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
      echo "Waiting for apt lock..."
      sleep 5
    done
  changed_when: false