# =============================================================================
# MUNGE УСТАНОВКА И НАСТРОЙКА (АЛЬТЕРНАТИВНАЯ ВЕРСИЯ)
# =============================================================================

- name: "[COMMON] Установка MUNGE"
  apt:
    name: 
      - munge
      - libmunge-dev
    state: present
  tags:
    - munge

- name: "[COMMON] Остановка MUNGE перед настройкой"
  systemd:
    name: munge
    state: stopped
    enabled: no
  tags:
    - munge

- name: "[COMMON] Создание MUNGE ключа на master узле"
  command:
    cmd: /usr/sbin/create-munge-key
    creates: /etc/munge/munge.key
  when: inventory_hostname in groups['slurm_master']
  tags:
    - munge

- name: "[COMMON] Настройка прав доступа MUNGE директорий"
  file:
    path: "{{ item.path }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
    state: directory
  loop:
    - { path: /etc/munge, owner: munge, group: munge, mode: '0700' }
    - { path: /var/log/munge, owner: munge, group: munge, mode: '0700' }
    - { path: /var/lib/munge, owner: munge, group: munge, mode: '0700' }
    - { path: /run/munge, owner: munge, group: munge, mode: '0755' }
  tags:
    - munge

# АЛЬТЕРНАТИВНОЕ решение - каждый узел читает ключ с мастера напрямую
- name: "[COMMON] Получение MUNGE ключа с мастера"
  slurp:
    src: /etc/munge/munge.key
  register: munge_key_from_master
  delegate_to: "{{ groups['slurm_master'][0] }}"
  when: inventory_hostname not in groups['slurm_master']
  tags:
    - munge

- name: "[COMMON] Создание MUNGE ключа на остальных узлах"
  copy:
    content: "{{ munge_key_from_master.content | b64decode }}"
    dest: /etc/munge/munge.key
    owner: munge
    group: munge
    mode: '0400'
  when: inventory_hostname not in groups['slurm_master']
  tags:
    - munge

- name: "[COMMON] Настройка прав доступа на ключ MUNGE (мастер)"
  file:
    path: /etc/munge/munge.key
    owner: munge
    group: munge
    mode: '0400'
  when: inventory_hostname in groups['slurm_master']
  tags:
    - munge

- name: "[COMMON] Запуск и включение MUNGE"
  systemd:
    name: munge
    state: started
    enabled: yes
    daemon_reload: yes
  tags:
    - munge

- name: "[COMMON] Проверка работы MUNGE"
  command: munge -n
  register: munge_test
  changed_when: false
  tags:
    - munge
    - verify

- name: "[COMMON] Результат проверки MUNGE"
  debug:
    msg: "MUNGE работает корректно на {{ inventory_hostname }}"
  when: munge_test.rc == 0
  tags:
    - munge
    - verify