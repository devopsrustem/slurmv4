# roles/common/tasks/main.yml
---
# –†–æ–ª—å: common - –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö —É–∑–ª–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞
# Ubuntu 24.04 + Slurm 25.05.1

- name: "[COMMON] –ù–∞—á–∞–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ common"
  debug:
    msg: "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ {{ inventory_hostname }}"

# =============================================================================
# –ë–ê–ó–û–í–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê –°–ò–°–¢–ï–ú–´
# =============================================================================

- name: "[COMMON] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ apt cache"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: 
    - system
    - packages

- name: "[COMMON] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤"
  apt:
    name: "{{ common_base_packages }}"
    state: present
  tags: 
    - system
    - packages

- name: "[COMMON] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ timezone"
  timezone:
    name: "{{ timezone }}"
  tags: 
    - system

- name: "[COMMON] –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ hostname resolution –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞"
  lineinfile:
    path: /etc/hosts
    line: "{{ item.ip }} {{ item.hostname }}"
    regexp: "^{{ item.ip }}.*{{ item.hostname }}"
  loop:
    - { ip: "10.20.90.166", hostname: "sm01" }
    - { ip: "10.20.90.161", hostname: "sm02" }
    - { ip: "10.20.90.167", hostname: "cn01" }
    - { ip: "10.20.90.168", hostname: "cn02" }
  tags:
    - system
    - network

- name: "[COMMON] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è slurm"
  user:
    name: "{{ slurm_user }}"
    uid: "{{ slurm_uid }}"
    system: yes
    shell: /bin/false
    home: /var/lib/slurm
    create_home: yes
  tags:
    - users

# =============================================================================
# MUNGE –£–°–¢–ê–ù–û–í–ö–ê –ò –ù–ê–°–¢–†–û–ô–ö–ê
# =============================================================================

- name: "[COMMON] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MUNGE"
  apt:
    name: 
      - munge
      - libmunge-dev
    state: present
  tags:
    - munge

- name: "[COMMON] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ MUNGE –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π"
  systemd:
    name: munge
    state: stopped
    enabled: no
  tags:
    - munge

- name: "[COMMON] –°–æ–∑–¥–∞–Ω–∏–µ MUNGE –∫–ª—é—á–∞ –Ω–∞ master —É–∑–ª–µ"
  command:
    cmd: /usr/sbin/create-munge-key
    creates: /etc/munge/munge.key
  when: inventory_hostname in groups['slurm_master']
  tags:
    - munge

- name: "[COMMON] –ü–æ–ª—É—á–µ–Ω–∏–µ MUNGE –∫–ª—é—á–∞ —Å master —É–∑–ª–∞"
  slurp:
    src: /etc/munge/munge.key
  register: munge_key
  when: inventory_hostname in groups['slurm_master']
  tags:
    - munge

- name: "[COMMON] –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ MUNGE –∫–ª—é—á–∞ –Ω–∞ –≤—Å–µ —É–∑–ª—ã"
  copy:
    content: "{{ hostvars[groups['slurm_master'][0]]['munge_key']['content'] | b64decode }}"
    dest: /etc/munge/munge.key
    owner: munge
    group: munge
    mode: '0400'
  when: inventory_hostname not in groups['slurm_master']
  tags:
    - munge

- name: "[COMMON] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ MUNGE"
  file:
    path: "{{ item.path }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
    state: directory
  loop:
    - { path: /etc/munge, owner: munge, group: munge, mode: '0700' }
    - { path: /var/log/munge, owner: munge, group: munge, mode: '0700' }
    - { path: /var/lib/munge, owner: munge, group: munge, mode: '0700' }
    - { path: /run/munge, owner: munge, group: munge, mode: '0755' }
  tags:
    - munge

- name: "[COMMON] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –∫–ª—é—á MUNGE"
  file:
    path: /etc/munge/munge.key
    owner: munge
    group: munge
    mode: '0400'
  tags:
    - munge

- name: "[COMMON] –ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ MUNGE"
  systemd:
    name: munge
    state: started
    enabled: yes
    daemon_reload: yes
  tags:
    - munge

- name: "[COMMON] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã MUNGE"
  command: munge -n
  register: munge_test
  changed_when: false
  tags:
    - munge
    - verify

- name: "[COMMON] –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ MUNGE"
  debug:
    msg: "MUNGE —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ {{ inventory_hostname }}"
  when: munge_test.rc == 0
  tags:
    - munge
    - verify

# =============================================================================
# HWLOC –£–°–¢–ê–ù–û–í–ö–ê
# =============================================================================

- name: "[COMMON] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HWLOC"
  apt:
    name:
      - hwloc
      - libhwloc-dev
    state: present
  tags:
    - hwloc

- name: "[COMMON] –ü—Ä–æ–≤–µ—Ä–∫–∞ HWLOC"
  command: lstopo --version
  register: hwloc_version
  changed_when: false
  tags:
    - hwloc
    - verify

- name: "[COMMON] –í–µ—Ä—Å–∏—è HWLOC"
  debug:
    msg: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è HWLOC: {{ hwloc_version.stdout }}"
  tags:
    - hwloc
    - verify

# =============================================================================
# NFS –ù–ê–°–¢–†–û–ô–ö–ê
# =============================================================================

# NFS Server (—Ç–æ–ª—å–∫–æ –Ω–∞ master —É–∑–ª–µ)
- name: "[COMMON] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS server –Ω–∞ master"
  apt:
    name:
      - nfs-kernel-server
      - nfs-common
    state: present
  when: inventory_hostname in groups['nfs_server']
  tags:
    - nfs
    - nfs-server

# roles/common/tasks/main.yml

- name: "[COMMON] –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ NFS"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /home
    - /sw
  when: inventory_hostname in groups['nfs_server']
  tags:
    - nfs
    - nfs-server

- name: "[COMMON] –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–æ–≤"
  lineinfile:
    path: /etc/exports
    regexp: "^{{ item }}.*"
    state: absent
  loop:
    - /home
    - /sw
  when: inventory_hostname in groups['nfs_server']
  tags:
    - nfs
    - nfs-server

- name: "[COMMON] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ NFS —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ IP"
  lineinfile:
    path: /etc/exports
    line: "{{ item.path }} {{ item.client_ip }}({{ nfs_export_options }})"
    create: yes
  loop:
    - { path: /home, client_ip: "10.20.90.161" }  # sm02
    - { path: /home, client_ip: "10.20.90.167" }  # cn01  
    - { path: /home, client_ip: "10.20.90.168" }  # cn02
    - { path: /sw, client_ip: "10.20.90.161" }    # sm02
    - { path: /sw, client_ip: "10.20.90.167" }    # cn01
    - { path: /sw, client_ip: "10.20.90.168" }    # cn02
  when: inventory_hostname in groups['nfs_server']
  notify: 
    - restart nfs-server
    - reload nfs-exports
  tags:
    - nfs
    - nfs-server

- name: "[COMMON] –ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ NFS server"
  systemd:
    name: nfs-kernel-server
    state: started
    enabled: yes
  when: inventory_hostname in groups['nfs_server']
  tags:
    - nfs
    - nfs-server

- name: "[COMMON] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–æ–≤ NFS"
  command: exportfs -ra
  when: inventory_hostname in groups['nfs_server']
  tags:
    - nfs
    - nfs-server

- name: "[COMMON] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–æ–≤"
  command: exportfs -v
  register: nfs_exports_check
  when: inventory_hostname in groups['nfs_server']
  tags:
    - nfs
    - nfs-server

- name: "[COMMON] –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç—ã"
  debug:
    var: nfs_exports_check.stdout_lines
  when: inventory_hostname in groups['nfs_server']
  tags:
    - nfs
    - nfs-server

# NFS Client (–Ω–∞ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É–∑–ª–∞—Ö)
- name: "[COMMON] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS client"
  apt:
    name: nfs-common
    state: present
  when: inventory_hostname in groups['nfs_client']
  tags:
    - nfs
    - nfs-client

- name: "[COMMON] –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–µ–∫ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è NFS"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /sw
  when: inventory_hostname in groups['nfs_client']
  tags:
    - nfs
    - nfs-client

- name: "[COMMON] –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NFS shares"
  mount:
    path: "{{ item.path }}"
    src: "sm01:{{ item.src }}"
    fstype: nfs
    opts: "{{ nfs_mount_options }}"
    state: mounted
  loop:
    - { path: /home, src: /home }
    - { path: /sw, src: /sw }
  when: inventory_hostname in groups['nfs_client']
  tags:
    - nfs
    - nfs-client

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MariaDB –Ω–∞ master
- name: "[COMMON] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MariaDB"
  apt:
    name:
      - mariadb-server
      - mariadb-client  
      - python3-pymysql
    state: present
  when: inventory_hostname in groups['slurm_master']
  tags:
    - mariadb

- name: "[COMMON] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ python3-pymysql –¥–ª—è Ansible mysql –º–æ–¥—É–ª–µ–π"
  apt:
    name: python3-pymysql
    state: present
  when: inventory_hostname in groups['slurm_master']
  tags: mariadb

# =============================================================================
# –ë–ê–ó–û–í–´–ï –î–ò–†–ï–ö–¢–û–†–ò–ò SLURM
# =============================================================================

- name: "[COMMON] –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π Slurm"
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: /var/log/slurm, owner: slurm, group: slurm, mode: '0755' }
    - { path: /var/spool/slurm, owner: slurm, group: slurm, mode: '0755' }
    - { path: /var/spool/slurm/ctld, owner: slurm, group: slurm, mode: '0755' }
    - { path: /var/spool/slurm/d, owner: slurm, group: slurm, mode: '0755' }
    - { path: /etc/slurm, owner: root, group: root, mode: '0755' }
    - { path: /var/lib/slurm, owner: slurm, group: slurm, mode: '0755' }
  tags:
    - slurm
    - directories

- name: "[COMMON] –†–æ–ª—å common –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
  debug:
    msg: "‚úÖ –£–∑–µ–ª {{ inventory_hostname }} –≥–æ—Ç–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Slurm"
  tags:
    - verify