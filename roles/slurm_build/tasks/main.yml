# roles/slurm_build/tasks/main.yml
---
# –†–æ–ª—å: slurm_build - –∫–æ–º–ø–∏–ª—è—Ü–∏—è Slurm 25.05.1 —Å JWT –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
# Ubuntu 24.04 

- name: "[SLURM_BUILD] –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ Slurm"
  debug:
    msg: "üîß –°–±–æ—Ä–∫–∞ Slurm {{ slurm_version }} —Å JWT –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–∞ {{ inventory_hostname }}"

# =============================================================================
# –ü–û–î–ì–û–¢–û–í–ö–ê –ö –°–ë–û–†–ö–ï (–¢–û–õ–¨–ö–û –ù–ê MASTER)
# =============================================================================

- name: "[SLURM_BUILD] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Å–±–æ—Ä–∫–∏"
  apt:
    name: "{{ slurm_build_dependencies }}"
    state: present
  when: inventory_hostname in groups['slurm_master']
  tags:
    - dependencies

- name: "[SLURM_BUILD] –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏"
  file:
    path: "{{ slurm_build_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: inventory_hostname in groups['slurm_master']
  tags:
    - download
    - build

- name: "[SLURM_BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤"
  stat:
    path: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}.tar.bz2"
  register: slurm_tarball
  when: inventory_hostname in groups['slurm_master']
  tags:
    - download

- name: "[SLURM_BUILD] –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Slurm {{ slurm_version }}"
  get_url:
    url: "{{ slurm_download_url }}"
    dest: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}.tar.bz2"
    mode: '0644'
    timeout: 300
  when: 
    - inventory_hostname in groups['slurm_master']
    - not slurm_tarball.stat.exists
  tags:
    - download

- name: "[SLURM_BUILD] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Slurm"
  unarchive:
    src: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}.tar.bz2"
    dest: "{{ slurm_build_dir }}"
    remote_src: yes
    creates: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}"
  when: inventory_hostname in groups['slurm_master']
  tags:
    - build

# =============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –°–ë–û–†–ö–ê
# =============================================================================

- name: "[SLURM_BUILD] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏ Slurm —Å JWT –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π"
  shell: |
    cd {{ slurm_build_dir }}/slurm-{{ slurm_version }}
    ./configure \
      --prefix={{ slurm_install_prefix }} \
      --sysconfdir=/etc/slurm \
      --enable-mysql \
      --with-mysql_config=/usr/bin \
      --with-munge \
      --with-hwloc \
      --with-json \
      --with-ssl \
      --with-jwt \
      --enable-multiple-scontrollers \
      --enable-pam \
      --with-pam_dir=/lib/x86_64-linux-gnu/security/ \
      --with-pmix \
      --with-systemd \
      --enable-slurmrestd \
      --enable-debug \
      --enable-developer
  args:
    chdir: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}"
    creates: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}/config.log"
  when: inventory_hostname in groups['slurm_master']
  register: slurm_configure
  tags:
    - build

- name: "[SLURM_BUILD] –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
  debug:
    var: slurm_configure.stdout_lines
  when: 
    - inventory_hostname in groups['slurm_master']
    - slurm_configure.changed
  tags:
    - build

- name: "[SLURM_BUILD] –ö–æ–º–ø–∏–ª—è—Ü–∏—è Slurm (—ç—Ç–æ –∑–∞–π–º–µ—Ç –≤—Ä–µ–º—è...)"
  shell: |
    cd {{ slurm_build_dir }}/slurm-{{ slurm_version }}
    make -j$(nproc)
  args:
    chdir: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}"
    creates: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}/src/slurmctld/slurmctld"
  when: inventory_hostname in groups['slurm_master']
  register: slurm_compile
  tags:
    - build

- name: "[SLURM_BUILD] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Slurm –Ω–∞ master"
  shell: |
    cd {{ slurm_build_dir }}/slurm-{{ slurm_version }}
    make install
  args:
    chdir: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}"
    creates: "{{ slurm_install_prefix }}/sbin/slurmctld"
  when: inventory_hostname in groups['slurm_master']
  register: slurm_install
  tags:
    - build

- name: "[SLURM_BUILD] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ development —Ñ–∞–π–ª–æ–≤ (headers –¥–ª—è Pyxis)"
  shell: |
    cd {{ slurm_build_dir }}/slurm-{{ slurm_version }}
    # –ö–æ–ø–∏—Ä—É–µ–º headers –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ
    mkdir -p {{ slurm_install_prefix }}/include/slurm
    cp -r slurm/*.h {{ slurm_install_prefix }}/include/slurm/
    # –ö–æ–ø–∏—Ä—É–µ–º –≥–ª–∞–≤–Ω—ã–π header –∏–∑ src
    cp src/slurmd/slurmd.h {{ slurm_install_prefix }}/include/slurm/ 2>/dev/null || true
    echo "Headers —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ {{ slurm_install_prefix }}/include/slurm/"
  args:
    chdir: "{{ slurm_build_dir }}/slurm-{{ slurm_version }}"
    creates: "{{ slurm_install_prefix }}/include/slurm/spank.h"
  when: inventory_hostname in groups['slurm_master']
  register: slurm_dev_install
  tags:
    - build
    - dev

# =============================================================================
# –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–ï –ù–ê –í–°–ï –£–ó–õ–´
# =============================================================================

- name: "[SLURM_BUILD] –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Slurm –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö"
  file:
    path: "{{ slurm_install_prefix }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - distribute

- name: "[SLURM_BUILD] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ /sw –Ω–∞ NFS —Å–µ—Ä–≤–µ—Ä–µ"
  file:
    path: "/sw"
    owner: root
    group: root
    mode: '0755'
    state: directory
  when: inventory_hostname in groups['slurm_master']
  tags:
    - distribute

- name: "[SLURM_BUILD] –ü–†–û–°–¢–û–ï –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ NFS (–° –î–ï–¢–ê–õ–¨–ù–´–ú –õ–û–ì–ò–†–û–í–ê–ù–ò–ï–ú)"
  shell: |
    set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
    echo "=== –ù–∞—á–∞–ª–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ==="
    
    # –•–ê–†–î–ö–û–î –ü–£–¢–ò - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    SLURM_PATH="/opt/slurm"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º $SLURM_PATH:"
    ls -la $SLURM_PATH/
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ë–ï–ó —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–æ–∫
    echo "=== –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ==="
    rm -rf /sw/slurm-temp
    mkdir -p /sw/slurm-temp
    mkdir -p /sw/slurm-temp/bin
    mkdir -p /sw/slurm-temp/sbin
    mkdir -p /sw/slurm-temp/lib
    mkdir -p /sw/slurm-temp/share
    mkdir -p /sw/slurm-temp/include
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    echo "=== –ö–æ–ø–∏—Ä—É–µ–º bin ==="
    cp -r $SLURM_PATH/bin/* /sw/slurm-temp/bin/
    echo "bin: —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ $(ls /sw/slurm-temp/bin | wc -l) —Ñ–∞–π–ª–æ–≤"
    
    echo "=== –ö–æ–ø–∏—Ä—É–µ–º sbin ==="
    cp -r $SLURM_PATH/sbin/* /sw/slurm-temp/sbin/
    echo "sbin: —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ $(ls /sw/slurm-temp/sbin | wc -l) —Ñ–∞–π–ª–æ–≤"
    
    echo "=== –ö–æ–ø–∏—Ä—É–µ–º lib ==="
    cp -r $SLURM_PATH/lib/* /sw/slurm-temp/lib/
    echo "lib: —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ $(ls /sw/slurm-temp/lib | wc -l) —Ñ–∞–π–ª–æ–≤"
    
    echo "=== –ö–æ–ø–∏—Ä—É–µ–º share ==="
    cp -r $SLURM_PATH/share/* /sw/slurm-temp/share/
    echo "share: —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ $(ls /sw/slurm-temp/share | wc -l) —Ñ–∞–π–ª–æ–≤"
    
    # –ö–æ–ø–∏—Ä—É–µ–º headers –¥–ª—è dev (–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø PYXIS!)
    echo "=== –ö–æ–ø–∏—Ä—É–µ–º include (headers) ==="
    if [ -d $SLURM_PATH/include ]; then
      cp -r $SLURM_PATH/include/* /sw/slurm-temp/include/
      echo "include: —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ $(find /sw/slurm-temp/include -name '*.h' | wc -l) header —Ñ–∞–π–ª–æ–≤"
    else
      echo "WARNING: headers –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ $SLURM_PATH/include"
    fi
    
    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è
    echo "=== –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ ==="
    mv /sw/slurm-temp /sw/slurm-final
    
    echo "=== –ì–û–¢–û–í–û! ==="
    ls -la /sw/slurm-final/bin/sinfo
  when: inventory_hostname in groups['slurm_master']
  register: nfs_copy_result
  tags:
    - distribute

# - name: "[SLURM_BUILD] –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ NFS"
#   wait_for:
#     path: "/sw/slurm-final/bin/sinfo"
#     timeout: 30
#   when: inventory_hostname not in groups['slurm_master']
#   tags:
#     - distribute

- name: "[SLURM_BUILD] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Slurm –Ω–∞ –≤—Å–µ —É–∑–ª—ã –∏–∑ NFS"
  shell: |
    cp -r /sw/slurm-final/* {{ slurm_install_prefix }}/
    chown -R root:root {{ slurm_install_prefix }}
    chmod -R 755 {{ slurm_install_prefix }}/bin {{ slurm_install_prefix }}/sbin
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ headers
    if [ -d {{ slurm_install_prefix }}/include ]; then
      chmod -R 644 {{ slurm_install_prefix }}/include
      echo "Headers —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ {{ slurm_install_prefix }}/include"
    fi
  when: inventory_hostname not in groups['slurm_master']
  tags:
    - distribute

# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –ò –°–ò–°–¢–ï–ú–ù–´–• –§–ê–ô–õ–û–í
# =============================================================================

- name: "[SLURM_BUILD] –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ Slurm"
  file:
    src: "{{ slurm_install_prefix }}/bin/{{ item }}"
    dest: "/usr/bin/{{ item }}"
    state: link
    force: yes
  loop:
    - sinfo
    - squeue
    - scancel
    - sbatch
    - salloc
    - srun
    - sacct
    - scontrol
    - sprio
    - smap
    - sdiag
    - sstat
    - sreport
    - sacctmgr
    - sattach
    - sbcast
    - sshare
    - sview
  tags:
    - links

- name: "[SLURM_BUILD] –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–µ–º–æ–Ω–æ–≤ Slurm"
  file:
    src: "{{ slurm_install_prefix }}/sbin/{{ item }}"
    dest: "/usr/sbin/{{ item }}"
    state: link
    force: yes
  loop:
    - slurmctld
    - slurmd
    - slurmdbd
    - slurmrestd
    - slurmstepd
  tags:
    - links

- name: "[SLURM_BUILD] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–≥–æ –∫–µ—à–∞"
  shell: ldconfig
  tags:
    - links

# =============================================================================
# –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò
# =============================================================================

- name: "[SLURM_BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Slurm (–±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –¥–µ–º–æ–Ω—É)"
  command: "{{ slurm_install_prefix }}/bin/sinfo -V"
  register: slurm_version_check
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: "[SLURM_BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ JWT"
  shell: "{{ slurm_install_prefix }}/sbin/slurmctld -V 2>&1 | grep -i jwt || echo 'JWT support check'"
  register: jwt_check
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: "[SLURM_BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ GPU/NVIDIA"
  shell: "{{ slurm_install_prefix }}/bin/scontrol show config 2>&1 | grep -i gres || echo 'GRES support available'"
  register: gpu_check
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: "[SLURM_BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ MySQL"
  shell: "{{ slurm_install_prefix }}/sbin/slurmctld -V 2>&1 | grep -i mysql || echo 'MySQL support check'"
  register: mysql_check
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: "[SLURM_BUILD] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏"
  debug:
    msg: |
      ‚úÖ Slurm —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {{ inventory_hostname }}
      üìã –í–µ—Ä—Å–∏—è: {{ slurm_version_check.stdout }}
      üîê JWT –ø–æ–¥–¥–µ—Ä–∂–∫–∞: {{ jwt_check.stdout }}
      üéÆ GPU –ø–æ–¥–¥–µ—Ä–∂–∫–∞: {{ gpu_check.stdout }}
      üíæ MySQL –ø–æ–¥–¥–µ—Ä–∂–∫–∞: {{ mysql_check.stdout }}
      üìç –ü—É—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏: {{ slurm_install_prefix }}
      üîó –ö–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ /usr/bin/, –¥–µ–º–æ–Ω—ã –≤ /usr/sbin/
  tags:
    - verify

- name: "[SLURM_BUILD] –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
  debug:
    msg: "üéâ Slurm {{ slurm_version }} —Å JWT –≥–æ—Ç–æ–≤ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –Ω–∞ {{ inventory_hostname }}"

# =============================================================================
# –û–ß–ò–°–¢–ö–ê (—Ç–æ–ª—å–∫–æ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É —Ç–µ–≥—É)
# =============================================================================

- name: "[SLURM_BUILD] –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ NFS"
  file:
    path: "/sw/slurm-final"
    state: absent
  when: inventory_hostname in groups['slurm_master']
  tags:
    - cleanup