# roles/slurm_build/tasks/main.yml
---
# –†–æ–ª—å: slurm_build - –∫–æ–º–ø–∏–ª—è—Ü–∏—è Slurm 25.05.1 —Å JWT –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π

- name: "[SLURM_BUILD] –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ Slurm"
  debug:
    msg: "üîß –°–±–æ—Ä–∫–∞ Slurm –Ω–∞ {{ inventory_hostname }}"

# –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ß–ï–†–ï–ó NFS - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
- name: "[SLURM_BUILD] –ü–†–û–°–¢–û–ï –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ NFS"
  shell: |
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    rm -rf /sw/slurm-final
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ë–ï–ó —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–æ–∫
    mkdir -p /sw/slurm-final
    mkdir -p /sw/slurm-final/bin
    mkdir -p /sw/slurm-final/sbin
    mkdir -p /sw/slurm-final/lib
    mkdir -p /sw/slurm-final/share
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
    cp -r {{ slurm_install_prefix }}/bin/* /sw/slurm-final/bin/
    cp -r {{ slurm_install_prefix }}/sbin/* /sw/slurm-final/sbin/
    cp -r {{ slurm_install_prefix }}/lib/* /sw/slurm-final/lib/
    cp -r {{ slurm_install_prefix }}/share/* /sw/slurm-final/share/
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º
    echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢ –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø ==="
    ls -la /sw/slurm-final/
    echo "bin: $(ls /sw/slurm-final/bin | wc -l) —Ñ–∞–π–ª–æ–≤"
    echo "sbin: $(ls /sw/slurm-final/sbin | wc -l) —Ñ–∞–π–ª–æ–≤"
  when: inventory_hostname in groups['slurm_master']
  tags:
    - distribute

- name: "[SLURM_BUILD] –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ NFS"
  wait_for:
    path: "/sw/slurm-final/bin/sinfo"
    timeout: 30
  when: inventory_hostname not in groups['slurm_master']
  tags:
    - distribute

- name: "[SLURM_BUILD] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Slurm –Ω–∞ –≤—Å–µ —É–∑–ª—ã –∏–∑ NFS"
  shell: |
    cp -r /sw/slurm-final/* {{ slurm_install_prefix }}/
    chown -R root:root {{ slurm_install_prefix }}
    chmod -R 755 {{ slurm_install_prefix }}/bin {{ slurm_install_prefix }}/sbin
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –Ω–∞ {{ inventory_hostname }}"
  when: inventory_hostname not in groups['slurm_master']
  tags:
    - distribute

- name: "[SLURM_BUILD] –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫"
  file:
    src: "{{ slurm_install_prefix }}/bin/{{ item }}"
    dest: "/usr/bin/{{ item }}"
    state: link
    force: yes
  loop:
    - sinfo
    - squeue
    - sbatch
    - srun
  tags:
    - links

- name: "[SLURM_BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Slurm"
  command: "/usr/bin/sinfo -V"
  register: slurm_version_check
  changed_when: false
  failed_when: false
  tags:
    - verify

- name: "[SLURM_BUILD] –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
  debug:
    msg: "‚úÖ Slurm —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {{ slurm_version_check.stdout | default('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏') }}"
  tags:
    - verify