---
- name: "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞŸĞ£Ğ¢Ğ•Ğ™ ENROOT"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ” Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… Ğ¿ÑƒÑ‚ĞµĞ¹ enroot"
      shell: |
        echo "=== Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ ĞŸĞ£Ğ¢Ğ•Ğ™ ENROOT ==="
        echo "ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²:"
        find /var -name "*hello-world*" 2>/dev/null || echo "ĞĞ±Ñ€Ğ°Ğ·Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
        echo ""
        
        echo "Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ /var/cache/enroot:"
        ls -la /var/cache/enroot/ 2>/dev/null || echo "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿ÑƒÑÑ‚Ğ°"
        echo ""
        
        echo "Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ /var/lib/enroot:"
        ls -la /var/lib/enroot/ 2>/dev/null || echo "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿ÑƒÑÑ‚Ğ°"
        echo ""
        
        echo "Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ enroot:"
        cat /etc/enroot/enroot.conf
        
      register: paths_diag
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸"
      debug:
        var: paths_diag.stdout_lines
        
    - name: "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ enroot Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¼Ğ¸ Ğ¿ÑƒÑ‚ÑĞ¼Ğ¸"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ubuntu 24.04
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_TEMP_PATH /tmp
          
          # User namespaces
          ENROOT_REMAP_ROOT yes
          
          # Bind mounts
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ (Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•!)
          ENROOT_RUNTIME_PATH_STRATEGY user
          
          # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
          ENROOT_ROOTFS_WRITABLE yes
          ENROOT_ALLOW_SETUID yes
          ENROOT_ALLOW_PRIVILEGED yes
          ENROOT_RESTRICT_DEV no
          
          # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ
          ENROOT_SQUASH_OPTIONS -comp gzip
        owner: root
        group: root
        mode: '0644'
        
    - name: "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ´Ğ»Ñ enroot"
      shell: |
        echo "=== Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¬Ğ¡ĞšĞ˜Ğ¥ Ğ”Ğ˜Ğ Ğ•ĞšĞ¢ĞĞ Ğ˜Ğ™ ==="
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ master
        mkdir -p /var/cache/enroot/master
        mkdir -p /var/lib/enroot/master  
        mkdir -p /run/enroot/master
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ master
        chown -R master:master /var/cache/enroot/master
        chown -R master:master /var/lib/enroot/master
        chown -R master:master /run/enroot/master
        
        # ĞŸÑ€Ğ°Ğ²Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        chmod 1777 /var/cache/enroot /run/enroot
        chmod 755 /var/lib/enroot
        
        echo "âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹"
        echo "Cache: /var/cache/enroot/master"
        echo "Data: /var/lib/enroot/master"  
        echo "Runtime: /run/enroot/master"
        
      register: user_dirs
      
    - name: "ğŸ”§ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ - Ğ²ÑĞµ Ğ² Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½ĞµĞ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ - Ğ² Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½ĞµĞ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
          ENROOT_DATA_PATH $HOME/.local/share/enroot
          ENROOT_CACHE_PATH $HOME/.cache/enroot
          ENROOT_RUNTIME_PATH /tmp/enroot-$USER
          ENROOT_TEMP_PATH /tmp
          
          # User namespaces  
          ENROOT_REMAP_ROOT yes
          
          # Bind mounts
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
          ENROOT_ROOTFS_WRITABLE yes
          ENROOT_ALLOW_SETUID yes  
          ENROOT_ALLOW_PRIVILEGED yes
          ENROOT_RESTRICT_DEV no
          
          # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ
          ENROOT_SQUASH_OPTIONS -comp gzip
        owner: root
        group: root
        mode: '0644'
        
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹"
      debug:
        var: user_dirs.stdout_lines

- name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ ĞŸĞ£Ğ¢Ğ•Ğ™"
  hosts: slurm_compute
  become: false
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ enroot Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¿ÑƒÑ‚ÑĞ¼Ğ¸"
      shell: |
        echo "=== Ğ¢Ğ•Ğ¡Ğ¢ ENROOT Ğ¡ ĞĞĞ’Ğ«ĞœĞ˜ ĞŸĞ£Ğ¢Ğ¯ĞœĞ˜ ==="
        echo "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: $(whoami)"
        echo ""
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
        mkdir -p ~/.local/share/enroot ~/.cache/enroot
        
        echo "1. ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²:"
        rm -rf ~/.cache/enroot/* ~/.local/share/enroot/* 2>/dev/null || true
        echo ""
        
        echo "2. ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚:"
        timeout 60 enroot import docker://hello-world 2>&1
        echo ""
        
        echo "3. Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²:"
        enroot list 2>&1
        echo ""
        
        echo "4. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 30 enroot create hello-world 2>&1
        echo ""
        
        echo "5. Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 30 enroot start hello-world echo "ENROOT PATHS FIXED!" 2>&1
        
      register: paths_test
      failed_when: false
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ‚ĞµÑÑ‚Ğ° Ğ¿ÑƒÑ‚ĞµĞ¹"
      debug:
        var: paths_test.stdout_lines

- name: "ğŸ§ª Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢ SLURM"
  hosts: slurm_master
  become: false
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ slurm Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿ÑƒÑ‚ĞµĞ¹"
      shell: |
        echo "=== Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢ SLURM ==="
        timeout 60 srun --container-image=docker://hello-world ls 2>&1
      register: final_slurm_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢"
      debug:
        msg: |
          {{ final_slurm_test.stdout }}
          
          {% if 'Hello from Docker' in final_slurm_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ Ğ•Ğ¨Ğ•ĞĞ! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'ENROOT PATHS FIXED!' in hostvars[groups['slurm_compute'][0]]['paths_test']['stdout'] %}
          ğŸ‰ ENROOT Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ±Ñ‹Ğ»Ğ° Ğ² Ğ¿ÑƒÑ‚ÑÑ…, Ğ½Ğµ Ğ² capabilities!
          {% else %}
          ğŸ’¡ ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ñ‚ĞµÑÑ‚ Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸ĞµĞ¹
          {% endif %}