# fix_permissions.yml
---
- name: "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞŸĞ ĞĞ’ Ğ”ĞĞ¡Ğ¢Ğ£ĞŸĞ ENROOT"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ”§ Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Enroot"
      shell: |
        echo "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞŸĞ ĞĞ’ Ğ”ĞĞ¡Ğ¢Ğ£ĞŸĞ ENROOT ĞĞ {{ inventory_hostname }}"
        
        # ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Enroot Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
        echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° /run/enroot..."
        mkdir -p /run/enroot
        chmod 1777 /run/enroot  # sticky bit ĞºĞ°Ğº Ñƒ /tmp
        
        echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° /var/lib/enroot..."
        mkdir -p /var/lib/enroot
        chmod 755 /var/lib/enroot
        
        echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° /var/cache/enroot..."
        mkdir -p /var/cache/enroot  
        chmod 1777 /var/cache/enroot  # Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¸ ĞºĞµÑˆĞ¸
        
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²:"
        ls -la /run/ | grep enroot
        ls -la /var/lib/ | grep enroot
        ls -la /var/cache/ | grep enroot
        
        echo "âœ… ĞŸÑ€Ğ°Ğ²Ğ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° {{ inventory_hostname }}"
      register: permissions_fix
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²"
      debug:
        var: permissions_fix.stdout_lines
        
    - name: "ğŸ“ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Enroot"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Enroot Configuration
          # Generated by Ansible with correct permissions
          
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          ENROOT_ALLOW_PRIVILEGED yes
          
          # User-specific runtime directories
          ENROOT_RUNTIME_PATH_STRATEGY user
        mode: '0644'
        backup: yes

- name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯"
  hosts: slurm_compute
  become: false  # Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ Ğ£Ğ•Ğœ ĞĞ¢ ĞĞ‘Ğ«Ğ§ĞĞĞ“Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯!
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ¾Ñ‚ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"
      shell: |
        echo "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞĞ¢ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯ {{ ansible_user }} ĞĞ {{ inventory_hostname }}"
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ÑĞ¼
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº /run/enroot:"
        ls -la /run/enroot || echo "ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº /run/enroot"
        
        echo "ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¾Ğ²ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ:"
        mkdir -p /run/enroot/test-$$
        if [ $? -eq 0 ]; then
          echo "âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"
          rmdir /run/enroot/test-$$
        else
          echo "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ"
        fi
        
        echo "Ğ¢ĞµÑÑ‚ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 60 srun --container-image=docker://hello-world 2>&1 || echo "ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ñ‚ĞµÑÑ‚ Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑˆĞµĞ»"
        
      register: user_test
      failed_when: false
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ‚ĞµÑÑ‚Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"
      debug:
        msg: |
          ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞĞ¢ ĞĞ‘Ğ«Ğ§ĞĞĞ“Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯:
          {{ user_test.stdout }}
          
          {% if 'Hello from Docker' in user_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢ ĞĞ¢ ĞĞ‘Ğ«Ğ§ĞĞĞ“Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯! ğŸ‰ğŸ‰ğŸ‰
          {% elif user_test.stderr is defined and 'Permission denied' in user_test.stderr %}
          ğŸ’” Ğ’ÑĞµ ĞµÑ‰Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
          {% else %}
          âš ï¸ ĞÑƒĞ¶Ğ½Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ°
          {% endif %}

- name: "ğŸ“‹ Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞĞ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ"
  hosts: slurm_master
  become: false  # ĞĞ¢ ĞĞ‘Ğ«Ğ§ĞĞĞ“Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯
  tasks:
    - name: "ğŸ¯ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµÑÑ‚ Ñ Ğ¼Ğ°ÑÑ‚ĞµÑ€Ğ°"
      shell: |
        echo "ğŸ¯ Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ ĞĞ’ ĞĞ¢ ĞĞ‘Ğ«Ğ§ĞĞĞ“Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯"
        echo "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: $(whoami)"
        echo "Ğ£Ğ·ĞµĞ»: {{ inventory_hostname }}"
        echo ""
        echo "Ğ¢ĞµÑÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 60 srun --container-image=docker://hello-world 2>&1
        echo ""
        echo "Ğ¢ĞµÑÑ‚ Debian ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 60 srun --container-image=docker://debian:unstable-slim cat /etc/os-release 2>&1
      register: final_user_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢"
      debug:
        msg: |
          ğŸ¯ Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢:
          {{ final_user_test.stdout }}
          
          {% if 'DEBIAN_VERSION_FULL' in final_user_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ Ğ’Ğ¡Ğ Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ”Ğ›Ğ¯ ĞĞ‘Ğ«Ğ§ĞĞ«Ğ¥ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ•Ğ™! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'Hello from Docker' in final_user_test.stdout %}
          ğŸ‰ğŸ‰ Ğ‘ĞĞ—ĞĞ’Ğ«Ğ• ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢! ğŸ‰ğŸ‰
          {% else %}
          ğŸ’” Ğ•Ñ‰Ğµ ĞµÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
          
          ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ:
          sudo chmod 1777 /run/enroot /var/cache/enroot
          {% endif %}