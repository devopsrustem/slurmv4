# fix_permissions.yml
---
- name: "🔧 ИСПРАВЛЕНИЕ ПРАВ ДОСТУПА ENROOT"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "🔧 Исправление прав доступа директорий Enroot"
      shell: |
        echo "🔧 ИСПРАВЛЕНИЕ ПРАВ ДОСТУПА ENROOT НА {{ inventory_hostname }}"
        
        # Основные директории Enroot с правильными правами
        echo "Настройка /run/enroot..."
        mkdir -p /run/enroot
        chmod 1777 /run/enroot  # sticky bit как у /tmp
        
        echo "Настройка /var/lib/enroot..."
        mkdir -p /var/lib/enroot
        chmod 755 /var/lib/enroot
        
        echo "Настройка /var/cache/enroot..."
        mkdir -p /var/cache/enroot  
        chmod 1777 /var/cache/enroot  # пользователи могут создавать свои кеши
        
        echo "Проверка прав:"
        ls -la /run/ | grep enroot
        ls -la /var/lib/ | grep enroot
        ls -la /var/cache/ | grep enroot
        
        echo "✅ Права исправлены на {{ inventory_hostname }}"
      register: permissions_fix
      
    - name: "📊 Результат исправления прав"
      debug:
        var: permissions_fix.stdout_lines
        
    - name: "📝 Обновление конфигурации Enroot"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Enroot Configuration
          # Generated by Ansible with correct permissions
          
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          ENROOT_ALLOW_PRIVILEGED yes
          
          # User-specific runtime directories
          ENROOT_RUNTIME_PATH_STRATEGY user
        mode: '0644'
        backup: yes

- name: "🧪 ТЕСТ ИСПРАВЛЕНИЯ"
  hosts: slurm_compute
  become: false  # ТЕСТИРУЕМ ОТ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ!
  tasks:
    - name: "🧪 Тест контейнера от обычного пользователя"
      shell: |
        echo "🧪 ТЕСТ ОТ ПОЛЬЗОВАТЕЛЯ {{ ansible_user }} НА {{ inventory_hostname }}"
        
        # Проверяем доступ к директориям
        echo "Проверка доступа к /run/enroot:"
        ls -la /run/enroot || echo "Нет доступа к /run/enroot"
        
        echo "Попытка создать тестовую директорию:"
        mkdir -p /run/enroot/test-$$
        if [ $? -eq 0 ]; then
          echo "✅ Создание директории успешно"
          rmdir /run/enroot/test-$$
        else
          echo "❌ Не удалось создать директорию"
        fi
        
        echo "Тест базового контейнера:"
        timeout 60 srun --container-image=docker://hello-world 2>&1 || echo "Контейнер тест не прошел"
        
      register: user_test
      failed_when: false
      
    - name: "📊 Результат теста пользователя"
      debug:
        msg: |
          🧪 ТЕСТ ОТ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ:
          {{ user_test.stdout }}
          
          {% if 'Hello from Docker' in user_test.stdout %}
          🎉🎉🎉 КОНТЕЙНЕРЫ РАБОТАЮТ ОТ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ! 🎉🎉🎉
          {% elif user_test.stderr is defined and 'Permission denied' in user_test.stderr %}
          💔 Все еще проблемы с правами доступа
          {% else %}
          ⚠️ Нужна дополнительная отладка
          {% endif %}

- name: "📋 ФИНАЛЬНАЯ ПРОВЕРКА"
  hosts: slurm_master
  become: false  # ОТ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ
  tasks:
    - name: "🎯 Финальный тест с мастера"
      shell: |
        echo "🎯 ФИНАЛЬНЫЙ ТЕСТ КОНТЕЙНЕРОВ ОТ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ"
        echo "Пользователь: $(whoami)"
        echo "Узел: {{ inventory_hostname }}"
        echo ""
        echo "Тест простого контейнера:"
        timeout 60 srun --container-image=docker://hello-world 2>&1
        echo ""
        echo "Тест Debian контейнера:"
        timeout 60 srun --container-image=docker://debian:unstable-slim cat /etc/os-release 2>&1
      register: final_user_test
      failed_when: false
      
    - name: "🎉 ФИНАЛЬНЫЙ РЕЗУЛЬТАТ"
      debug:
        msg: |
          🎯 ФИНАЛЬНЫЙ ТЕСТ:
          {{ final_user_test.stdout }}
          
          {% if 'DEBIAN_VERSION_FULL' in final_user_test.stdout %}
          🎉🎉🎉 ВСЁ РАБОТАЕТ! КОНТЕЙНЕРЫ ДЛЯ ОБЫЧНЫХ ПОЛЬЗОВАТЕЛЕЙ! 🎉🎉🎉
          {% elif 'Hello from Docker' in final_user_test.stdout %}
          🎉🎉 БАЗОВЫЕ КОНТЕЙНЕРЫ РАБОТАЮТ! 🎉🎉
          {% else %}
          💔 Еще есть проблемы с правами
          
          Попробуйте вручную:
          sudo chmod 1777 /run/enroot /var/cache/enroot
          {% endif %}