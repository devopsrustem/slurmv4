# fix_cache.yml
---
- name: "🔧 ИСПРАВЛЕНИЕ ПРАВ ДОСТУПА КЕША ENROOT"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "🔧 Полное исправление директорий Enroot"
      shell: |
        echo "🔧 ИСПРАВЛЕНИЕ ENROOT ДИРЕКТОРИЙ НА {{ inventory_hostname }}"
        
        # Останавливаем все контейнеры
        pkill -f enroot || true
        
        # Удаляем старые кеши с неправильными правами
        echo "Очистка старых кешей..."
        rm -rf /var/cache/enroot/*
        rm -rf /run/enroot/*
        
        # Пересоздаем директории с правильными правами
        echo "Создание директорий с правильными правами..."
        mkdir -p /var/cache/enroot
        mkdir -p /var/lib/enroot  
        mkdir -p /run/enroot
        
        # КРИТИЧНО: права как у /tmp!
        chmod 1777 /var/cache/enroot
        chmod 1777 /run/enroot
        chmod 755 /var/lib/enroot
        
        # Проверяем результат
        echo "Проверка прав:"
        ls -la /var/cache/ | grep enroot
        ls -la /run/ | grep enroot
        ls -la /var/lib/ | grep enroot
        
        echo "✅ Права исправлены на {{ inventory_hostname }}"
      register: cache_fix
      
    - name: "📊 Результат исправления"
      debug:
        var: cache_fix.stdout_lines

- name: "🧪 НЕМЕДЛЕННЫЙ ТЕСТ"
  hosts: slurm_master
  become: false  # ОТ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ
  tasks:
    - name: "🧪 Тест после исправления кеша"
      shell: |
        echo "🧪 ТЕСТ КОНТЕЙНЕРА ПОСЛЕ ИСПРАВЛЕНИЯ КЕША"
        echo "Пользователь: $(whoami)"
        echo "Узел: {{ inventory_hostname }}"
        echo ""
        
        echo "Проверка доступа к директориям:"
        echo "/var/cache/enroot: $(ls -la /var/cache/ | grep enroot)"
        echo "/run/enroot: $(ls -la /run/ | grep enroot)"
        
        echo ""
        echo "Тест простого контейнера:"
        timeout 120 srun --container-image=docker://hello-world 2>&1
        
        echo ""
        echo "Тест Ubuntu контейнера:"
        timeout 120 srun --container-image=docker://ubuntu:22.04 ls /bin 2>&1 | head -10
        
      register: cache_test
      failed_when: false
      
    - name: "🎉 РЕЗУЛЬТАТ ТЕСТА"
      debug:
        msg: |
          🧪 ТЕСТ ПОСЛЕ ИСПРАВЛЕНИЯ КЕША:
          {{ cache_test.stdout }}
          
          {% if 'bin' in cache_test.stdout and 'bash' in cache_test.stdout %}
          🎉🎉🎉 UBUNTU КОНТЕЙНЕР РАБОТАЕТ! КЕШ ИСПРАВЛЕН! 🎉🎉🎉
          {% elif 'Hello from Docker' in cache_test.stdout %}
          🎉🎉 БАЗОВЫЕ КОНТЕЙНЕРЫ РАБОТАЮТ! 🎉🎉
          {% elif 'Permission denied' in cache_test.stdout %}
          💔 Все еще проблемы с правами
          {% else %}
          ⚠️ Проверьте вывод выше
          {% endif %}