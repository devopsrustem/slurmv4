# fix_cache.yml
---
- name: "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞŸĞ ĞĞ’ Ğ”ĞĞ¡Ğ¢Ğ£ĞŸĞ ĞšĞ•Ğ¨Ğ ENROOT"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ”§ ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Enroot"
      shell: |
        echo "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ENROOT Ğ”Ğ˜Ğ Ğ•ĞšĞ¢ĞĞ Ğ˜Ğ™ ĞĞ {{ inventory_hostname }}"
        
        # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
        pkill -f enroot || true
        
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ĞºĞµÑˆĞ¸ Ñ Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
        echo "ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞµÑˆĞµĞ¹..."
        rm -rf /var/cache/enroot/*
        rm -rf /run/enroot/*
        
        # ĞŸĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
        echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸..."
        mkdir -p /var/cache/enroot
        mkdir -p /var/lib/enroot  
        mkdir -p /run/enroot
        
        # ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ: Ğ¿Ñ€Ğ°Ğ²Ğ° ĞºĞ°Ğº Ñƒ /tmp!
        chmod 1777 /var/cache/enroot
        chmod 1777 /run/enroot
        chmod 755 /var/lib/enroot
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²:"
        ls -la /var/cache/ | grep enroot
        ls -la /run/ | grep enroot
        ls -la /var/lib/ | grep enroot
        
        echo "âœ… ĞŸÑ€Ğ°Ğ²Ğ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° {{ inventory_hostname }}"
      register: cache_fix
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
      debug:
        var: cache_fix.stdout_lines

- name: "ğŸ§ª ĞĞ•ĞœĞ•Ğ”Ğ›Ğ•ĞĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢"
  hosts: slurm_master
  become: false  # ĞĞ¢ ĞĞ‘Ğ«Ğ§ĞĞĞ“Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞµÑˆĞ°"
      shell: |
        echo "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ ĞŸĞĞ¡Ğ›Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ ĞšĞ•Ğ¨Ğ"
        echo "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: $(whoami)"
        echo "Ğ£Ğ·ĞµĞ»: {{ inventory_hostname }}"
        echo ""
        
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ÑĞ¼:"
        echo "/var/cache/enroot: $(ls -la /var/cache/ | grep enroot)"
        echo "/run/enroot: $(ls -la /run/ | grep enroot)"
        
        echo ""
        echo "Ğ¢ĞµÑÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 120 srun --container-image=docker://hello-world 2>&1
        
        echo ""
        echo "Ğ¢ĞµÑÑ‚ Ubuntu ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 120 srun --container-image=docker://ubuntu:22.04 ls /bin 2>&1 | head -10
        
      register: cache_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ Ğ¢Ğ•Ğ¡Ğ¢Ğ"
      debug:
        msg: |
          ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞĞ¡Ğ›Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ ĞšĞ•Ğ¨Ğ:
          {{ cache_test.stdout }}
          
          {% if 'bin' in cache_test.stdout and 'bash' in cache_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ UBUNTU ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ  Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! ĞšĞ•Ğ¨ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•Ğ! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'Hello from Docker' in cache_test.stdout %}
          ğŸ‰ğŸ‰ Ğ‘ĞĞ—ĞĞ’Ğ«Ğ• ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢! ğŸ‰ğŸ‰
          {% elif 'Permission denied' in cache_test.stdout %}
          ğŸ’” Ğ’ÑĞµ ĞµÑ‰Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
          {% else %}
          âš ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ²Ñ‹ÑˆĞµ
          {% endif %}