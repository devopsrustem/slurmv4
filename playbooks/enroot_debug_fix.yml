---
- name: "ğŸ” Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ Ğ˜ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ENROOT"
  hosts: slurm_compute
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ” ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° enroot"
      shell: |
        echo "=== Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ ENROOT ==="
        echo "User namespaces: $(cat /proc/sys/kernel/unprivileged_userns_clone)"
        echo "Max namespaces: $(cat /proc/sys/user/max_user_namespaces)"
        echo ""
        
        echo "ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹:"
        ls -la /var/cache/enroot /var/lib/enroot /run/enroot
        echo ""
        
        echo "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ enroot:"
        cat /etc/enroot/enroot.conf
        echo ""
        
        echo "Ğ¢ĞµÑÑ‚ enroot Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:"
        sudo -u master enroot version
        echo ""
        
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° /proc/self/ns:"
        ls -la /proc/self/ns/
        echo ""
        
        echo "Cgroups Ğ²ĞµÑ€ÑĞ¸Ñ:"
        if [ -f /sys/fs/cgroup/cgroup.controllers ]; then
          echo "cgroups v2"
        else
          echo "cgroups v1"
        fi
        
      register: enroot_diag
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸"
      debug:
        var: enroot_diag.stdout_lines
        
    - name: "ğŸ”§ Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ubuntu 24.04 cgroups v2"
      shell: |
        echo "=== Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• CGROUPS V2 ==="
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ cgroups v2 (Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ubuntu 24.04)
        if [ -f /sys/fs/cgroup/cgroup.controllers ]; then
          echo "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ cgroups v2 - Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ systemd slice Ğ´Ğ»Ñ enroot
          cat > /etc/systemd/system/enroot.slice << 'EOF'
        [Unit]
        Description=Enroot container slice
        Before=slices.target
        
        [Slice]
        MemoryAccounting=yes
        CPUAccounting=yes
        IOAccounting=yes
        TasksAccounting=yes
        EOF
          
          systemctl daemon-reload
          systemctl start enroot.slice
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ enroot ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ´Ğ»Ñ cgroups v2
          cat >> /etc/enroot/enroot.conf << 'EOF'
        
        # Ubuntu 24.04 cgroups v2 compatibility
        ENROOT_SYSTEMD_USER_SLICE=enroot.slice
        EOF
          
          echo "âœ… cgroups v2 Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¾"
        else
          echo "cgroups v1 - Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ñ‹"
        fi
        
      register: cgroups_fix
      
    - name: "ğŸ”§ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ enroot Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ñ… Ñ„Ğ¸Ñ‡"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ubuntu 24.04
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_TEMP_PATH /tmp
          
          # User namespaces (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾)
          ENROOT_REMAP_ROOT yes
          
          # Bind mounts
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # ĞœĞ˜ĞĞ˜ĞœĞĞ›Ğ¬ĞĞĞ¯ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ¬
          ENROOT_ROOTFS_WRITABLE yes
          ENROOT_ALLOW_SETUID yes
          ENROOT_ALLOW_PRIVILEGED yes
          
          # ĞĞ¢ĞšĞ›Ğ®Ğ§ĞĞ•Ğœ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞĞ«Ğ• Ğ¤Ğ˜Ğ§Ğ˜
          ENROOT_RESTRICT_DEV no
          
          # ĞŸÑ€Ğ¾ÑÑ‚ĞµĞ¹ÑˆĞ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ
          ENROOT_SQUASH_OPTIONS -comp gzip
        owner: root
        group: root
        mode: '0644'
        
    - name: "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ hook Ğ´Ğ»Ñ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼"
      copy:
        dest: /etc/enroot/hooks.d/99-ubuntu24.sh
        content: |
          #!/bin/bash
          # Ubuntu 24.04 compatibility hook
          
          # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼
          export ENROOT_FORCE_OVERRIDE=1
          export ENROOT_LOGIN_SHELL=/bin/bash
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ runtime Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
          mkdir -p "${ENROOT_RUNTIME_PATH}" 2>/dev/null || true
          
          # Ğ£Ğ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ Ñ‡Ñ‚Ğ¾ user namespaces Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹
          if [ "$(cat /proc/sys/kernel/unprivileged_userns_clone)" != "1" ]; then
            echo "WARNING: unprivileged user namespaces Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹"
          fi
        owner: root
        group: root
        mode: '0755'
        
    - name: "ğŸ”§ Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ runtime Ğ¿Ñ€Ğ°Ğ²"
      shell: |
        # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²ÑĞµ runtime Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        rm -rf /run/enroot/* /var/cache/enroot/* 2>/dev/null || true
        
        # ĞŸĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
        mkdir -p /var/lib/enroot /var/cache/enroot /run/enroot
        chmod 1777 /var/cache/enroot /run/enroot
        chmod 755 /var/lib/enroot
        
        # Ğ£Ğ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ Ñ‡Ñ‚Ğ¾ master Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ
        chown master:master /var/cache/enroot /run/enroot 2>/dev/null || true
        
        echo "Runtime Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹"
      register: runtime_fix
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹"
      debug:
        msg: |
          âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹:
          {{ cgroups_fix.stdout }}
          {{ runtime_fix.stdout }}

- name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞ Ğ¯ĞœĞĞ“Ğ ENROOT"
  hosts: slurm_compute
  become: false
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ enroot Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ (Ğ±ĞµĞ· slurm)"
      shell: |
        echo "=== Ğ¢Ğ•Ğ¡Ğ¢ ENROOT ĞĞĞŸĞ Ğ¯ĞœĞ£Ğ® ==="
        echo "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: $(whoami)"
        echo ""
        
        echo "1. Ğ¢ĞµÑÑ‚ enroot version:"
        enroot version
        echo ""
        
        echo "2. Ğ¢ĞµÑÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°:"
        timeout 60 enroot import docker://hello-world 2>&1 || echo "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑ"
        echo ""
        
        echo "3. Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²:"
        enroot list 2>&1 || echo "Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑ"
        echo ""
        
        echo "4. Ğ¢ĞµÑÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        if enroot list | grep -q hello-world; then
          timeout 30 enroot create hello-world 2>&1 || echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ"
          echo ""
          echo "5. Ğ¢ĞµÑÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°:"
          timeout 30 enroot start hello-world 2>&1 || echo "Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑ"
        else
          echo "ĞĞ±Ñ€Ğ°Ğ· hello-world Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
        fi
        
      register: direct_enroot_test
      failed_when: false
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ‚ĞµÑÑ‚Ğ° enroot"
      debug:
        var: direct_enroot_test.stdout_lines

- name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ Ğ§Ğ•Ğ Ğ•Ğ— SLURM"
  hosts: slurm_master
  become: false
  tasks:
    - name: "ğŸ§ª Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµÑÑ‚ Ñ‡ĞµÑ€ĞµĞ· slurm"
      shell: |
        echo "=== Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢ Ğ§Ğ•Ğ Ğ•Ğ— SLURM ==="
        timeout 60 srun --container-image=docker://hello-world 2>&1
      register: slurm_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ˜Ğ¢ĞĞ“ĞĞ’Ğ«Ğ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢"
      debug:
        msg: |
          {{ slurm_test.stdout }}
          
          {% if 'Hello from Docker' in slurm_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ Ğ Ğ•Ğ¨Ğ•ĞĞ! ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'couldn\'t start container' in slurm_test.stdout %}
          ğŸ’¡ ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ‚ĞµÑÑ‚Ğ° enroot Ğ²Ñ‹ÑˆĞµ
          {% else %}
          âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°
          {% endif %}