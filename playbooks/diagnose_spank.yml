# diagnose_spank.yml
---
- name: "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SPANK –ü–õ–ê–ì–ò–ù–ê"
  hosts: slurm_compute,slurm_login
  become: true
  gather_facts: false
  
  tasks:
    - name: "üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SPANK"
      shell: |
        echo "=================== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SPANK ==================="
        echo "–£–∑–µ–ª: {{ inventory_hostname }}"
        echo ""
        
        echo "1. –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í PYXIS:"
        echo "–ü–ª–∞–≥–∏–Ω /usr/local/lib/slurm/spank_pyxis.so:"
        ls -la /usr/local/lib/slurm/spank_pyxis.so 2>/dev/null || echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù"
        
        echo ""
        echo "–ö–æ–Ω—Ñ–∏–≥ /usr/local/share/pyxis/pyxis.conf:"
        ls -la /usr/local/share/pyxis/pyxis.conf 2>/dev/null || echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù"
        
        echo ""
        echo "2. –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò SLURM:"
        echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è plugstack.conf.d:"
        ls -la /etc/slurm/plugstack.conf.d/ 2>/dev/null || echo "‚ùå –î–ò–†–ï–ö–¢–û–†–ò–Ø –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢"
        
        echo ""
        echo "–°—Å—ã–ª–∫–∞ pyxis.conf:"
        ls -la /etc/slurm/plugstack.conf.d/pyxis.conf 2>/dev/null || echo "‚ùå –°–°–´–õ–ö–ê –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢"
        
        echo ""
        echo "–û—Å–Ω–æ–≤–Ω–æ–π plugstack.conf:"
        ls -la /etc/slurm/plugstack.conf 2>/dev/null || echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù"
        
        echo ""
        echo "3. –°–û–î–ï–†–ñ–ò–ú–û–ï –ö–û–ù–§–ò–ì–û–í:"
        if [ -f /etc/slurm/plugstack.conf.d/pyxis.conf ]; then
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ pyxis.conf:"
          cat /etc/slurm/plugstack.conf.d/pyxis.conf
        fi
        
        if [ -f /etc/slurm/plugstack.conf ]; then
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ plugstack.conf:"
          cat /etc/slurm/plugstack.conf
        fi
        
        echo ""
        echo "4. –ü–†–û–í–ï–†–ö–ê SLURM.CONF:"
        echo "PlugStackConfig –≤ slurm.conf:"
        grep -i plugstack /etc/slurm/slurm.conf || echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û"
        
        echo ""
        echo "5. –õ–û–ì–ò SLURMD (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
        if [ -f /var/log/slurm/slurmd.log ]; then
          echo "–ü–æ–∏—Å–∫ spank/pyxis –≤ –ª–æ–≥–∞—Ö:"
          tail -50 /var/log/slurm/slurmd.log | grep -i -E "(spank|pyxis|plugin)" || echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û"
        else
          echo "‚ùå –õ–æ–≥ —Ñ–∞–π–ª /var/log/slurm/slurmd.log –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo "Systemd –ª–æ–≥–∏:"
          journalctl -u slurmd -n 10 --no-pager | grep -i -E "(spank|pyxis|plugin)" || echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û"
        fi
        
        echo ""
        echo "6. –°–¢–ê–¢–£–° SLURMD:"
        if [ "{{ inventory_hostname in groups['slurm_compute'] }}" = "True" ]; then
          systemctl is-active slurmd || echo "‚ùå SLURMD –ù–ï –ê–ö–¢–ò–í–ï–ù"
        else
          echo "Login —É–∑–µ–ª - slurmd –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
        fi
        
        echo ""
        echo "7. –¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò –ü–õ–ê–ì–ò–ù–ê:"
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–µ—Ç –ª–∏ slurmd –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–∞–≥–∏–Ω..."
        if [ -f /usr/local/lib/slurm/spank_pyxis.so ]; then
          ldd /usr/local/lib/slurm/spank_pyxis.so | head -5 || echo "–ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏"
        fi
        
        echo "=================== –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ==================="
      register: spank_diagnosis
      
    - name: "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"
      debug:
        var: spank_diagnosis.stdout_lines

- name: "üß™ –¢–ï–°–¢ –ö–û–ú–ê–ù–î SRUN"
  hosts: slurm_master  
  become: true
  tasks:
    - name: "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ü–∏–π srun"
      shell: |
        echo "=== –ü–†–û–í–ï–†–ö–ê –û–ü–¶–ò–ô SRUN ==="
        echo "–ò—â–µ–º container-related –æ–ø—Ü–∏–∏:"
        srun --help | grep -i container || echo "‚ùå –ù–µ—Ç container –æ–ø—Ü–∏–π"
        
        echo ""
        echo "–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏ srun:"
        srun --help | head -50
        
        echo ""
        echo "=== –ü–†–û–í–ï–†–ö–ê SPANK –ù–ê MASTER ==="
        echo "PlugStackConfig –≤ slurm.conf:"
        grep -i plugstack /etc/slurm/slurm.conf || echo "‚ùå –ù–ï –ù–ê–°–¢–†–û–ï–ù–û"
      register: srun_options_test
      
    - name: "üìä –û–ø—Ü–∏–∏ srun"
      debug:
        var: srun_options_test.stdout_lines