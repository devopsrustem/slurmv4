# playbooks/rebuild_containers.yml
---
# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Slurm + Pyxis –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏

- name: "üîÑ –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–°–ë–û–†–ö–ê: Slurm + –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ"
      debug:
        msg: |
          üîÑ –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–°–ë–û–†–ö–ê SLURM + –ö–û–ù–¢–ï–ô–ù–ï–†–´
          ==========================================
          üéØ –≠—Ç–∞–ø 1: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
          üîß –≠—Ç–∞–ø 2: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Slurm —Å headers
          üê≥ –≠—Ç–∞–ø 3: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Pyxis
          ‚úÖ –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
          ==========================================

# =============================================================================
# –≠–¢–ê–ü 1: –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –§–ê–ô–õ–û–í
# =============================================================================

- name: "üßπ –≠–¢–ê–ü 1: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  tasks:
    - name: "[CLEANUP] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö headers Slurm"
      file:
        path: /opt/slurm/include
        state: absent
      when: inventory_hostname in groups['slurm_master']

    - name: "[CLEANUP] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ Pyxis"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /usr/local/src/pyxis/spank_pyxis.so
        - /etc/slurm/plugstack.conf
      when: inventory_hostname in groups['slurm_compute']

    - name: "[CLEANUP] –û—á–∏—Å—Ç–∫–∞ NFS –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"
      file:
        path: /sw/slurm-final
        state: absent
      when: inventory_hostname in groups['slurm_master']

# =============================================================================
# –≠–¢–ê–ü 2: –ü–ï–†–ï–°–ë–û–†–ö–ê SLURM –° HEADERS
# =============================================================================

- name: "üîß –≠–¢–ê–ü 2: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Slurm —Å headers"
  hosts: slurm_master
  become: true
  gather_facts: true
  tasks:
    - name: "[REBUILD] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ Slurm"
      debug:
        msg: |
          üîß –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Slurm –Ω–∞ {{ inventory_hostname }}
          üìÅ –ë—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã headers –≤ /opt/slurm/include/
          üì¶ –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ NFS –Ω–∞ –≤—Å–µ —É–∑–ª—ã

  roles:
    - slurm_build

  post_tasks:
    - name: "[REBUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ headers"
      stat:
        path: /opt/slurm/include/slurm/spank.h
      register: headers_check

    - name: "[REBUILD] –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ headers"
      debug:
        msg: |
          üìÅ Headers –≤ /opt/slurm/include: {{ headers_check.stat.exists | ternary('‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç') }}
          {% if headers_check.stat.exists %}
          üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ header —Ñ–∞–π–ª–æ–≤: {{ (ansible_facts.get('find_headers', {}).get('matched', 0)) }}
          {% endif %}

    - name: "[REBUILD] –ü–æ–¥—Å—á–µ—Ç header —Ñ–∞–π–ª–æ–≤"
      find:
        paths: /opt/slurm/include
        patterns: "*.h"
        recurse: yes
      register: find_headers

    - name: "[REBUILD] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ headers"
      debug:
        msg: |
          üìä –ù–∞–π–¥–µ–Ω–æ {{ find_headers.matched }} header —Ñ–∞–π–ª–æ–≤
          üìÅ –ì–æ—Ç–æ–≤–æ –∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ Pyxis

# =============================================================================
# –≠–¢–ê–ü 3: –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–ï –ù–ê –í–°–ï –£–ó–õ–´
# =============================================================================

- name: "üì¶ –≠–¢–ê–ü 3: –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Slurm –Ω–∞ –≤—Å–µ —É–∑–ª—ã"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  tasks:
    - name: "[DISTRIBUTE] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Slurm –∏–∑ NFS"
      shell: |
        cp -r /sw/slurm-final/* /opt/slurm/
        chown -R root:root /opt/slurm
        chmod -R 755 /opt/slurm/bin /opt/slurm/sbin
        if [ -d /opt/slurm/include ]; then
          chmod -R 644 /opt/slurm/include
          echo "Headers —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã: $(find /opt/slurm/include -name '*.h' | wc -l) —Ñ–∞–π–ª–æ–≤"
        fi
      register: distribute_result
      when: inventory_hostname not in groups['slurm_master']

    - name: "[DISTRIBUTE] –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è"
      debug:
        var: distribute_result.stdout_lines
      when: inventory_hostname not in groups['slurm_master']

# =============================================================================
# –≠–¢–ê–ü 4: –ü–ï–†–ï–°–ë–û–†–ö–ê PYXIS
# =============================================================================

- name: "üê≥ –≠–¢–ê–ü 4: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Pyxis —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ headers"
  hosts: slurm_compute
  become: true
  gather_facts: false
  tasks:
    - name: "[PYXIS] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ Pyxis"
      debug:
        msg: |
          üê≥ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Pyxis –Ω–∞ {{ inventory_hostname }}
          üìÅ –ò—Å–ø–æ–ª—å–∑—É–µ–º headers –∏–∑ /opt/slurm/include/
          üéØ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: /usr/local/src/pyxis/spank_pyxis.so

    - name: "[PYXIS] –ü—Ä–æ–≤–µ—Ä–∫–∞ headers –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π"
      stat:
        path: /opt/slurm/include/slurm/spank.h
      register: spank_header_check

    - name: "[PYXIS] –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç headers"
      fail:
        msg: "‚ùå Headers –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ /opt/slurm/include/slurm/spank.h"
      when: not spank_header_check.stat.exists

  roles:
    - containers

  post_tasks:
    - name: "[PYXIS] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏"
      stat:
        path: /usr/local/src/pyxis/spank_pyxis.so
      register: pyxis_check

    - name: "[PYXIS] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏"
      shell: |
        if [ -f /usr/local/src/pyxis/spank_pyxis.so ]; then
          echo "–§–∞–π–ª: $(ls -la /usr/local/src/pyxis/spank_pyxis.so)"
          echo "–õ–∏–Ω–∫–æ–≤–∫–∞: $(ldd /usr/local/src/pyxis/spank_pyxis.so | grep slurm || echo 'Standalone - OK!')"
          echo "–†–∞–∑–º–µ—Ä: $(du -h /usr/local/src/pyxis/spank_pyxis.so)"
        else
          echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
      register: pyxis_info
      when: pyxis_check.stat.exists

    - name: "[PYXIS] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—Ä–∞–Ω–Ω–æ–º Pyxis"
      debug:
        var: pyxis_info.stdout_lines
      when: pyxis_check.stat.exists

# =============================================================================
# –≠–¢–ê–ü 5: –ü–ï–†–ï–ó–ê–ü–£–°–ö –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# =============================================================================

- name: "üîÑ –≠–¢–ê–ü 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"
  hosts: slurm_compute
  become: true
  gather_facts: false
  tasks:
    - name: "[RESTART] –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd"
      systemd:
        name: slurmd
        state: restarted
      register: slurmd_restart

    - name: "[RESTART] –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
      pause:
        seconds: 5

    - name: "[RESTART] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ slurmd"
      systemd:
        name: slurmd
      register: slurmd_status

    - name: "[RESTART] –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
      debug:
        msg: |
          üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd: {{ slurmd_restart.changed | ternary('‚úÖ –≤—ã–ø–æ–ª–Ω–µ–Ω', '‚ùå –æ—à–∏–±–∫–∞') }}
          üìä –°—Ç–∞—Ç—É—Å: {{ slurmd_status.status.ActiveState | default('unknown') }}

# =============================================================================
# –≠–¢–ê–ü 6: –§–ò–ù–ê–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# =============================================================================

- name: "‚úÖ –≠–¢–ê–ü 6: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
  hosts: slurm_master
  become: true
  gather_facts: false
  tasks:
    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞"
      shell: |
        echo "=== –°–¢–ê–¢–£–° –ö–õ–ê–°–¢–ï–†–ê ==="
        sinfo
        echo ""
        echo "=== –¢–ï–°–¢ –û–ë–´–ß–ù–û–ô –ó–ê–î–ê–ß–ò ==="
        timeout 30 srun date || echo "–¢–µ—Å—Ç –∑–∞–¥–∞—á–∏ –Ω–µ –ø—Ä–æ—à–µ–ª"
        echo ""
        echo "=== –¢–ï–°–¢ –ö–û–ù–¢–ï–ô–ù–ï–†–ê ==="
        timeout 60 srun --container-image=docker://hello-world || echo "–¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ –ø—Ä–æ—à–µ–ª"
      register: final_test
      failed_when: false

    - name: "[TEST] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
      debug:
        var: final_test.stdout_lines

# =============================================================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢
# =============================================================================

- name: "üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏"
      debug:
        msg: |
          ==========================================
          üéâ –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–°–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!
          ==========================================
          
          ‚úÖ –≠—Ç–∞–ø 1: –û—á–∏—Å—Ç–∫–∞ - –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
          ‚úÖ –≠—Ç–∞–ø 2: Slurm + headers - —Å–æ–±—Ä–∞–Ω
          ‚úÖ –≠—Ç–∞–ø 3: –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ - –≤—ã–ø–æ–ª–Ω–µ–Ω–æ  
          ‚úÖ –≠—Ç–∞–ø 4: Pyxis - –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω
          ‚úÖ –≠—Ç–∞–ø 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ - –≤—ã–ø–æ–ª–Ω–µ–Ω
          ‚úÖ –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
          
          üöÄ –ö–û–ù–¢–ï–ô–ù–ï–†–´ –ì–û–¢–û–í–´ –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ!
          
          üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
          srun --container-image=docker://hello-world
          srun --pty --container-image=docker://ubuntu:20.04 /bin/bash
          
          ==========================================