# fix_plugstack.yml  
---
- name: "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• PLUGSTACK ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ˜"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ plugstack.conf"
      copy:
        dest: /etc/slurm/plugstack.conf
        content: |
          # Slurm SPANK Plugin Stack Configuration
          # Generated by Ansible
          
          # Pyxis container support
          required /usr/local/lib/slurm/spank_pyxis.so
        owner: root
        group: root
        mode: '0644'
        backup: yes
      register: plugstack_created
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ plugstack.conf"
      debug:
        msg: |
          âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ /etc/slurm/plugstack.conf
          ğŸ“ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ:
          required /usr/local/lib/slurm/spank_pyxis.so

- name: "ğŸ”„ ĞŸĞ•Ğ Ğ•Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ĞĞ’"
  hosts: slurm_compute
  become: true
  tasks:
    - name: "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº slurmd Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°"
      systemd:
        name: slurmd
        state: restarted
        
    - name: "â° ĞŸĞ°ÑƒĞ·Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°"
      pause:
        seconds: 5
        
    - name: "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°"
      shell: |
        echo "=== ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ĞŸĞĞ¡Ğ›Ğ• ĞŸĞ•Ğ Ğ•Ğ—ĞĞŸĞ£Ğ¡ĞšĞ ==="
        echo "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ slurmd: $(systemctl is-active slurmd)"
        echo ""
        echo "ĞŸĞ¾Ğ¸ÑĞº spank Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…:"
        tail -20 /var/log/slurm/slurmd.log | grep -i spank || echo "ĞĞµÑ‚ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹ spank"
        echo ""
        echo "ĞŸĞ¾Ğ¸ÑĞº pyxis Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…:"
        tail -20 /var/log/slurm/slurmd.log | grep -i pyxis || echo "ĞĞµÑ‚ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹ pyxis"
      register: plugin_check
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸"
      debug:
        var: plugin_check.stdout_lines

- name: "ğŸ§ª Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢"
  hosts: slurm_master
  become: true
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ Ğ¾Ğ¿Ñ†Ğ¸Ğ¹ srun Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
      shell: |
        echo "=== ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ĞĞŸĞ¦Ğ˜Ğ™ SRUN ==="
        echo "Ğ˜Ñ‰ĞµĞ¼ container-image Ğ¾Ğ¿Ñ†Ğ¸Ñ:"
        srun --help | grep -i container-image || echo "âŒ ĞĞ•Ğ¢ container-image"
        
        echo ""
        echo "Ğ’ÑĞµ container Ğ¾Ğ¿Ñ†Ğ¸Ğ¸:"
        srun --help | grep -i container || echo "âŒ ĞĞ•Ğ¢ container Ğ¾Ğ¿Ñ†Ğ¸Ğ¹"
        
        echo ""
        echo "=== Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ ==="
        timeout 60 srun --container-image=docker://hello-world 2>&1 || echo "Ğ¢ĞµÑÑ‚ Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑˆĞµĞ»"
      register: final_test
      
    - name: "ğŸ‰ Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢"
      debug:
        msg: |
          {{ final_test.stdout }}
          
          {% if '--container-image' in final_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞĞŸĞ¦Ğ˜Ğ¯ --container-image ĞŸĞĞ¯Ğ’Ğ˜Ğ›ĞĞ¡Ğ¬! PYXIS Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'Hello from Docker' in final_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢! PYXIS Ğ—ĞĞ“Ğ Ğ£Ğ–Ğ•Ğ! ğŸ‰ğŸ‰ğŸ‰
          {% else %}
          ğŸ’” ĞÑƒĞ¶Ğ½Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ°
          
          ğŸ“‹ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:
          1. ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½ Ğ½Ğµ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼ Ñ Ğ²ĞµÑ€ÑĞ¸ĞµĞ¹ Slurm
          2. ĞÑˆĞ¸Ğ±ĞºĞ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ğ¸ Pyxis
          3. ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼
          {% endif %}