# fix_plugstack.yml  
---
- name: "🔧 ИСПРАВЛЕНИЕ PLUGSTACK КОНФИГУРАЦИИ"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "🔧 Создание основного plugstack.conf"
      copy:
        dest: /etc/slurm/plugstack.conf
        content: |
          # Slurm SPANK Plugin Stack Configuration
          # Generated by Ansible
          
          # Pyxis container support
          required /usr/local/lib/slurm/spank_pyxis.so
        owner: root
        group: root
        mode: '0644'
        backup: yes
      register: plugstack_created
      
    - name: "📊 Результат создания plugstack.conf"
      debug:
        msg: |
          ✅ Создан /etc/slurm/plugstack.conf
          📝 Содержимое:
          required /usr/local/lib/slurm/spank_pyxis.so

- name: "🔄 ПЕРЕЗАПУСК СЕРВИСОВ"
  hosts: slurm_compute
  become: true
  tasks:
    - name: "🔄 Перезапуск slurmd для загрузки плагина"
      systemd:
        name: slurmd
        state: restarted
        
    - name: "⏰ Пауза после перезапуска"
      pause:
        seconds: 5
        
    - name: "🔍 Проверка загрузки плагина"
      shell: |
        echo "=== ПРОВЕРКА ПОСЛЕ ПЕРЕЗАПУСКА ==="
        echo "Статус slurmd: $(systemctl is-active slurmd)"
        echo ""
        echo "Поиск spank в логах:"
        tail -20 /var/log/slurm/slurmd.log | grep -i spank || echo "Нет упоминаний spank"
        echo ""
        echo "Поиск pyxis в логах:"
        tail -20 /var/log/slurm/slurmd.log | grep -i pyxis || echo "Нет упоминаний pyxis"
      register: plugin_check
      
    - name: "📊 Результат проверки"
      debug:
        var: plugin_check.stdout_lines

- name: "🧪 ФИНАЛЬНЫЙ ТЕСТ"
  hosts: slurm_master
  become: true
  tasks:
    - name: "🧪 Тест опций srun после исправления"
      shell: |
        echo "=== ПРОВЕРКА ОПЦИЙ SRUN ==="
        echo "Ищем container-image опцию:"
        srun --help | grep -i container-image || echo "❌ НЕТ container-image"
        
        echo ""
        echo "Все container опции:"
        srun --help | grep -i container || echo "❌ НЕТ container опций"
        
        echo ""
        echo "=== ТЕСТ КОНТЕЙНЕРА ==="
        timeout 60 srun --container-image=docker://hello-world 2>&1 || echo "Тест не прошел"
      register: final_test
      
    - name: "🎉 ФИНАЛЬНЫЙ РЕЗУЛЬТАТ"
      debug:
        msg: |
          {{ final_test.stdout }}
          
          {% if '--container-image' in final_test.stdout %}
          🎉🎉🎉 ОПЦИЯ --container-image ПОЯВИЛАСЬ! PYXIS РАБОТАЕТ! 🎉🎉🎉
          {% elif 'Hello from Docker' in final_test.stdout %}
          🎉🎉🎉 КОНТЕЙНЕРЫ РАБОТАЮТ! PYXIS ЗАГРУЖЕН! 🎉🎉🎉
          {% else %}
          💔 Нужна дополнительная отладка
          
          📋 Возможные причины:
          1. Плагин не совместим с версией Slurm
          2. Ошибки компиляции Pyxis
          3. Права доступа к файлам
          {% endif %}