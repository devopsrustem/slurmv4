# proper_fix.yml
---
- name: "ğŸ”§ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ENROOT/PYXIS"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ”§ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… capabilities Ğ½Ğ° enroot"
      shell: |
        echo "ğŸ”§ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ¯ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ ENROOT ĞĞ {{ inventory_hostname }}"
        
        # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ²ÑĞµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ enroot
        ENROOT_BINS=$(find /usr -name "*enroot*" -type f -executable 2>/dev/null)
        
        echo "ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ enroot Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹:"
        echo "$ENROOT_BINS"
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ capabilities Ğ½Ğ° Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
        for bin in $ENROOT_BINS; do
          echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° $bin..."
          
          # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ capabilities
          setcap -r "$bin" 2>/dev/null || true
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ capabilities
          if [[ "$bin" == *"enroot"* ]]; then
            setcap 'cap_sys_admin+ep' "$bin" 2>/dev/null || echo "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ capabilities Ğ½Ğ° $bin"
          fi
        done
        
        # Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ enroot-aufs2ovlfs ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ
        if [ -f /usr/bin/enroot-aufs2ovlfs ]; then
          echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° enroot-aufs2ovlfs..."
          setcap 'cap_sys_admin+ep' /usr/bin/enroot-aufs2ovlfs || echo "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ"
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° capabilities:"
        for bin in $ENROOT_BINS; do
          echo "$bin: $(getcap $bin 2>/dev/null || echo 'Ğ½ĞµÑ‚ capabilities')"
        done
        
      register: capabilities_setup
      
    - name: "ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° user namespaces Ğ¸ subuid/subgid"
      shell: |
        echo "ğŸ”§ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ USER NAMESPACES"
        
        # Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ user namespaces
        echo 1 > /proc/sys/kernel/unprivileged_userns_clone 2>/dev/null || echo "Ğ£Ğ¶Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾"
        
        # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹
        echo 65536 > /proc/sys/user/max_user_namespaces 2>/dev/null || echo "Ğ£Ğ¶Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾"
        
        # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ subuid/subgid Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
        # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ master
        sed -i '/^master:/d' /etc/subuid /etc/subgid 2>/dev/null || true
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ
        echo "master:100000:65536" >> /etc/subuid
        echo "master:100000:65536" >> /etc/subgid
        
        echo "User namespaces Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹"
        echo "subuid: $(grep master /etc/subuid || echo 'Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾')"
        echo "subgid: $(grep master /etc/subgid || echo 'Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾')"
        
      register: namespaces_setup
      
    - name: "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞĞšĞĞĞ§ĞĞ¢Ğ•Ğ›Ğ¬ĞĞĞ™ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Enroot"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Enroot Configuration - FINAL VERSION
          # Generated by Ansible - ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ¯ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯
          
          # Basic paths
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          
          # Mount points
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # User namespaces - Ğ’ĞšĞ›Ğ®Ğ§Ğ•ĞĞ
          ENROOT_REMAP_ROOT yes
          
          # Security settings - Ğ¡Ğ‘ĞĞ›ĞĞĞ¡Ğ˜Ğ ĞĞ’ĞĞĞĞ«Ğ•
          ENROOT_RESTRICT_DEV no
          ENROOT_ROOTFS_WRITABLE yes
          ENROOT_ALLOW_SETUID yes
          ENROOT_ALLOW_PRIVILEGED yes
          
          # Capabilities - Ğ ĞĞ—Ğ Ğ•Ğ¨Ğ•ĞĞ (Ñƒ Ğ½Ğ°Ñ ĞµÑÑ‚ÑŒ setcap)
          ENROOT_CAP_SYS_ADMIN yes
          
          # Compression settings
          ENROOT_SQUASH_OPTIONS -comp gzip -noappend
          
          # Runtime settings
          ENROOT_TEMP_PATH /tmp
          ENROOT_MAX_PROCESSORS {{ ansible_processor_vcpus }}
          ENROOT_MAX_MEMORY {{ (ansible_memtotal_mb * 0.8) | int }}M
        owner: root
        group: root
        mode: '0644'
        backup: yes
        
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸"
      debug:
        msg: |
          ğŸ”§ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ¯ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ ĞĞ {{ inventory_hostname }}:
          
          ğŸ“Š Capabilities:
          {{ capabilities_setup.stdout }}
          
          ğŸ“Š User namespaces:
          {{ namespaces_setup.stdout }}

- name: "ğŸ§ª Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯"
  hosts: slurm_master
  become: false
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
      shell: |
        echo "ğŸ§ª Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞĞ¡Ğ›Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯"
        echo "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: $(whoami)"
        echo ""
        
        echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ==="
        echo "User namespaces: $(cat /proc/sys/kernel/unprivileged_userns_clone 2>/dev/null || echo 'Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾')"
        echo "Max namespaces: $(cat /proc/sys/user/max_user_namespaces 2>/dev/null || echo 'Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾')"
        echo "subuid: $(grep $(whoami) /etc/subuid 2>/dev/null || echo 'Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾')"
        
        echo ""
        echo "=== Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞ ĞĞ¡Ğ¢ĞĞ“Ğ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ ==="
        timeout 120 srun --container-image=docker://hello-world 2>&1
        
        echo ""
        echo "=== Ğ¢Ğ•Ğ¡Ğ¢ UBUNTU ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ ==="
        timeout 120 srun --container-image=docker://ubuntu:22.04 echo "Ubuntu container SUCCESS!" 2>&1
        
        echo ""
        echo "=== Ğ¢Ğ•Ğ¡Ğ¢ Ğ¡Ğ›ĞĞ–ĞĞĞ“Ğ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ ==="
        timeout 120 srun --container-image=docker://ubuntu:22.04 /bin/bash -c "ls /bin | head -5" 2>&1
        
      register: final_proper_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯"
      debug:
        msg: |
          ğŸ§ª Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯:
          {{ final_proper_test.stdout }}
          
          {% if 'Ubuntu container SUCCESS!' in final_proper_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ• Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ• Ğ¡Ğ ĞĞ‘ĞĞ¢ĞĞ›Ğ! PYXIS Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'Hello from Docker' in final_proper_test.stdout %}
          ğŸ‰ğŸ‰ Ğ‘ĞĞ—ĞĞ’Ğ«Ğ• ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢! ğŸ‰ğŸ‰
          {% elif 'failed to set capabilities' in final_proper_test.stdout %}
          ğŸ’” Ğ’ÑĞµ ĞµÑ‰Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ capabilities - Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ setcap
          {% else %}
          âš ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¾ÑÑŒ - Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
          {% endif %}