# playbooks/test_slurm_compute.yml
---
# =============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–û–õ–ò SLURM_COMPUTE
# =============================================================================

- name: "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ slurm_compute"
  hosts: slurm_compute
  become: yes
  gather_facts: yes
  
  vars:
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    slurm_install_prefix: "/usr/local/slurm"
    slurm_config_dir: "/etc/slurm"
    slurm_log_dir: "/var/log/slurm"
    gpu_detection_enabled: true
    
  pre_tasks:
    - name: "[TEST] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏"
      debug:
        msg: |
          üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–æ–ª—å slurm_compute –Ω–∞ {{ inventory_hostname }}
          üì¶ Slurm —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {{ slurm_install_prefix }}
          üîó Master —É–∑–µ–ª: {{ groups['slurm_master'][0] }}
          üñ•Ô∏è  GPU —Ç–µ—Å—Ç: –≤–∫–ª—é—á–µ–Ω
      tags: always

    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π"
      stat:
        path: "{{ item }}"
      register: prereq_check
      loop:
        - "{{ slurm_install_prefix }}/sbin/slurmd"
        - "/etc/munge/munge.key"
        - "/sw/config/slurm.conf"
      tags: pre-check
      
    - name: "[TEST] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π"
      debug:
        msg: |
          üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:
          {% for item in prereq_check.results %}
          {{ item.item }}: {{ item.stat.exists | ternary('‚úÖ –Ω–∞–π–¥–µ–Ω', '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') }}
          {% endfor %}
      tags: pre-check

  tasks:
    - name: "[TEST] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ slurm_compute"
      include_role:
        name: slurm_compute
      tags: role

  post_tasks:
    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"
      systemd:
        name: slurmd
      register: slurmd_status
      tags: verify

    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
      stat:
        path: "{{ item }}"
      register: files_check
      loop:
        - "/etc/systemd/system/slurmd.service"
        - "{{ slurm_config_dir }}/slurm.conf"
        - "{{ slurm_config_dir }}/gres.conf"
        - "/usr/local/bin/slurm_health_check.sh"
        - "/usr/sbin/slurmd"
      tags: verify

    - name: "[TEST] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–æ–≤"
      debug:
        msg: |
          üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
          {% for item in files_check.results %}
          {{ item.item }}: {{ item.stat.exists | ternary('‚úÖ —Å–æ–∑–¥–∞–Ω', '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') }}
          {% endfor %}
      tags: verify

    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ slurmd"
      shell: |
        if systemctl is-active slurmd >/dev/null 2>&1; then
          echo "üéõÔ∏è slurmd: –ê–ö–¢–ò–í–ï–ù"
          echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
          tail -3 {{ slurm_log_dir }}/slurmd.log 2>/dev/null || echo "–õ–æ–≥–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
        else
          echo "üéõÔ∏è slurmd: –ù–ï–ê–ö–¢–ò–í–ï–ù"
          echo "üìù –û—à–∏–±–∫–∏ –∏–∑ journalctl:"
          journalctl -u slurmd -n 3 --no-pager
        fi
      register: slurmd_logs
      changed_when: false
      tags: verify

    - name: "[TEST] –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –º–∞—Å—Ç–µ—Ä—É (—Å –º–∞—Å—Ç–µ—Ä–∞)"
      shell: /usr/bin/scontrol ping
      register: master_ping
      delegate_to: "{{ groups['slurm_master'][0] }}"
      run_once: true
      changed_when: false
      failed_when: false
      tags: verify

    - name: "[TEST] –°—Ç–∞—Ç—É—Å —É–∑–ª–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ (—Å –º–∞—Å—Ç–µ—Ä–∞)"
      shell: /usr/bin/sinfo -N
      register: cluster_status
      delegate_to: "{{ groups['slurm_master'][0] }}"
      run_once: true
      changed_when: false
      failed_when: false
      tags: verify

    - name: "[TEST] –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç"
      debug:
        msg: |
          üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –†–û–õ–ò SLURM_COMPUTE
          
          üéõÔ∏è –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ slurmd:
          {{ slurmd_logs.stdout }}
          
          üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–∞—Å—Ç–µ—Ä—É:
          {{ master_ping.stdout | default('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è') }}
          
          üìã –°—Ç–∞—Ç—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∞:
          {{ cluster_status.stdout | default('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') }}
          
          {% if slurmd_status.status.ActiveState == 'active' %}
          ‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: slurmd —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ {{ inventory_hostname }}
          {% else %}
          ‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: slurmd –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
          {% endif %}
          
          üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
          1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: systemctl status slurmd
          2. –ù–∞ –º–∞—Å—Ç–µ—Ä–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: sinfo
          3. –£–∑–ª—ã –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–π—Ç–∏ –∏–∑ unknown* –≤ idle
      run_once: true
      tags: verify