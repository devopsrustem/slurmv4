---
# –¢–µ—Å—Ç–æ–≤—ã–π playbook –¥–ª—è —Ä–æ–ª–∏ slurm_build

- name: "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ slurm_build"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  
  pre_tasks:
    - name: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ Slurm"
      debug:
        msg: |
          üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É Slurm {{ slurm_version }}
          üìç –°–±–æ—Ä–∫–∞ –Ω–∞: {{ groups['slurm_master'][0] }}
          üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞: {{ groups['slurm_cluster'] | join(', ') }}
          üîê JWT –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
      run_once: true

    - name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ"
      shell: "df -h /tmp | tail -1 | awk '{print $4}'"
      register: disk_space
      when: inventory_hostname in groups['slurm_master']
      
    - name: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –º–µ—Å—Ç–µ –Ω–∞ –¥–∏—Å–∫–µ"
      debug:
        msg: |
          üíæ –î–æ—Å—Ç—É–ø–Ω–æ –º–µ—Å—Ç–∞ –≤ /tmp: {{ disk_space.stdout }}
          ‚ö†Ô∏è  –î–ª—è —Å–±–æ—Ä–∫–∏ Slurm —Ç—Ä–µ–±—É–µ—Ç—Å—è ~2GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
      when: inventory_hostname in groups['slurm_master']

  roles:
    - slurm_build

  post_tasks:
    - name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Slurm"
      command: "/usr/bin/sinfo --version"
      register: slurm_check
      changed_when: false
      ignore_errors: true

    - name: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
      debug:
        msg: |
          {% if slurm_check.rc == 0 %}
          ‚úÖ Slurm —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {{ inventory_hostname }}
          üìã –í–µ—Ä—Å–∏—è: {{ slurm_check.stdout }}
          üìÅ –ö–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ /usr/bin/, –¥–µ–º–æ–Ω—ã –≤ /usr/sbin/
          üì¶ –ò—Å—Ö–æ–¥–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ {{ slurm_install_prefix }}
          {% else %}
          ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Slurm –Ω–∞ {{ inventory_hostname }}
          {% endif %}

    - name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥ Slurm"
      shell: |
        echo "=== –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã Slurm ==="
        ls -la /usr/bin/s* 2>/dev/null | grep slurm || ls -la /usr/bin/s*info* /usr/bin/s*queue* 2>/dev/null || echo "–ö–æ–º–∞–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        echo "=== –°–∏—Å—Ç–µ–º–Ω—ã–µ –¥–µ–º–æ–Ω—ã Slurm ==="  
        ls -la /usr/sbin/slurm* 2>/dev/null || echo "–î–µ–º–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        echo "=== –£—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ==="
        ls -la {{ slurm_install_prefix }}/bin/ 2>/dev/null | head -5 || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—É—Å—Ç–∞"
      register: slurm_binaries

    - name: "–°–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"
      debug:
        var: slurm_binaries.stdout_lines

  handlers:
    - name: clean build directory
      file:
        path: /tmp/slurm-build
        state: absent