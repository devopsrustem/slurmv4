# containers_debug.yml
---
- name: "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ENROOT + PYXIS"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  
  tasks:
    - name: "üìã –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–µ"
      debug:
        msg: |
          üñ•Ô∏è –£–∑–µ–ª: {{ inventory_hostname }}
          üìç –†–æ–ª—å: {{ group_names | join(', ') }}
          üíæ RAM: {{ (ansible_memtotal_mb / 1024) | round(1) }}GB
      run_once: false

    # =================================================================
    # –ü–†–û–í–ï–†–ö–ê ENROOT
    # =================================================================
    
    - name: "[ENROOT] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Enroot"
      command: enroot version
      register: enroot_check
      failed_when: false
      changed_when: false
    
    - name: "[ENROOT] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Enroot"
      stat:
        path: /etc/enroot/enroot.conf
      register: enroot_config_check
    
    - name: "[ENROOT] –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Enroot"
      shell: cat /etc/enroot/enroot.conf
      register: enroot_config_content
      when: enroot_config_check.stat.exists
      failed_when: false
      changed_when: false

    # =================================================================
    # –ü–†–û–í–ï–†–ö–ê SLURM HEADERS (–ö–†–ò–¢–ò–ß–ù–û!)
    # =================================================================
    
    - name: "[HEADERS] –ü—Ä–æ–≤–µ—Ä–∫–∞ Slurm headers"
      stat:
        path: /opt/slurm/include/slurm/spank.h
      register: slurm_headers_check
    
    - name: "[HEADERS] –ü–æ–¥—Å—á–µ—Ç header —Ñ–∞–π–ª–æ–≤"
      shell: find /opt/slurm/include -name "*.h" | wc -l
      register: headers_count
      when: slurm_headers_check.stat.exists
      failed_when: false
      changed_when: false

    # =================================================================
    # –ü–†–û–í–ï–†–ö–ê PYXIS
    # =================================================================
    
    - name: "[PYXIS] –ü—Ä–æ–≤–µ—Ä–∫–∞ SPANK –ø–ª–∞–≥–∏–Ω–∞ Pyxis"
      stat:
        path: /usr/local/src/pyxis/spank_pyxis.so
      register: pyxis_plugin_check
    
    - name: "[PYXIS] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Pyxis –ø–ª–∞–≥–∏–Ω–µ"
      shell: |
        if [ -f /usr/local/src/pyxis/spank_pyxis.so ]; then
          echo "–†–∞–∑–º–µ—Ä: $(du -h /usr/local/src/pyxis/spank_pyxis.so)"
          echo "–ü—Ä–∞–≤–∞: $(ls -la /usr/local/src/pyxis/spank_pyxis.so)"
          echo "–õ–∏–Ω–∫–æ–≤–∫–∞: $(ldd /usr/local/src/pyxis/spank_pyxis.so | head -3)"
        else
          echo "‚ùå –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        fi
      register: pyxis_info
      when: inventory_hostname in groups['slurm_compute']
      failed_when: false
      changed_when: false
    
    - name: "[PYXIS] –ü—Ä–æ–≤–µ—Ä–∫–∞ plugstack.conf"
      stat:
        path: /etc/slurm/plugstack.conf
      register: plugstack_check
    
    - name: "[PYXIS] –°–æ–¥–µ—Ä–∂–∏–º–æ–µ plugstack.conf"
      shell: cat /etc/slurm/plugstack.conf
      register: plugstack_content
      when: plugstack_check.stat.exists
      failed_when: false
      changed_when: false

    # =================================================================
    # –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ò–°–û–í
    # =================================================================
    
    - name: "[SERVICES] –°—Ç–∞—Ç—É—Å slurmd"
      shell: systemctl status slurmd --no-pager -l
      register: slurmd_status
      when: inventory_hostname in groups['slurm_compute']
      failed_when: false
      changed_when: false
    
    - name: "[SERVICES] –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ slurmd"
      shell: tail -10 /var/log/slurm/slurmd.log
      register: slurmd_logs
      when: inventory_hostname in groups['slurm_compute']
      failed_when: false
      changed_when: false

    # =================================================================
    # –ü–†–û–í–ï–†–ö–ê GPU (–µ—Å–ª–∏ –µ—Å—Ç—å)
    # =================================================================
    
    - name: "[GPU] –ü—Ä–æ–≤–µ—Ä–∫–∞ NVIDIA"
      command: nvidia-smi -L
      register: nvidia_check
      failed_when: false
      changed_when: false
    
    - name: "[GPU] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
      shell: ls -la /dev/nvidia* 2>/dev/null || echo "–ù–µ—Ç NVIDIA —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
      register: nvidia_devices
      failed_when: false
      changed_when: false

    # =================================================================
    # –¢–ï–°–¢ –ö–û–ù–¢–ï–ô–ù–ï–†–ê
    # =================================================================
    
    - name: "[TEST] –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
      shell: timeout 30 srun --container-image=docker://hello-world 2>&1 || echo "–¢–ï–°–¢ –ù–ï –ü–†–û–®–ï–õ"
      register: container_test
      when: inventory_hostname in groups['slurm_master']
      failed_when: false
      changed_when: false

# =================================================================
# –û–¢–ß–ï–¢ –û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–•
# =================================================================

- name: "üìä –û–¢–ß–ï–¢ –û –î–ò–ê–ì–ù–û–°–¢–ò–ö–ï"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
      debug:
        msg: |
          ==========================================
          üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –ó–ê–í–ï–†–®–ï–ù–ê
          ==========================================
          
          {% for host in groups['slurm_cluster'] %}
          üñ•Ô∏è {{ host }}:
          {% set h = hostvars[host] %}
          
          üì¶ ENROOT:
          {% if h.enroot_check.rc == 0 %}
          ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {{ h.enroot_check.stdout }}
          ‚úÖ –ö–æ–Ω—Ñ–∏–≥: {{ h.enroot_config_check.stat.exists | ternary('–µ—Å—Ç—å', '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') }}
          {% else %}
          ‚ùå –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù
          {% endif %}
          
          üìÅ SLURM HEADERS:
          {% if h.slurm_headers_check.stat.exists %}
          ‚úÖ spank.h –Ω–∞–π–¥–µ–Ω
          ‚úÖ –í—Å–µ–≥–æ headers: {{ h.headers_count.stdout | default('?') }}
          {% else %}
          ‚ùå HEADERS –û–¢–°–£–¢–°–¢–í–£–Æ–¢ - –≠–¢–û –ü–†–û–ë–õ–ï–ú–ê!
          {% endif %}
          
          üîå PYXIS –ü–õ–ê–ì–ò–ù:
          {% if h.pyxis_plugin_check.stat.exists %}
          ‚úÖ –ü–ª–∞–≥–∏–Ω –Ω–∞–π–¥–µ–Ω
          {% if h.pyxis_info is defined %}
          üìä {{ h.pyxis_info.stdout }}
          {% endif %}
          {% else %}
          ‚ùå –ü–õ–ê–ì–ò–ù –ù–ï –ù–ê–ô–î–ï–ù
          {% endif %}
          
          ‚öôÔ∏è PLUGSTACK.CONF:
          {% if h.plugstack_check.stat.exists %}
          ‚úÖ –§–∞–π–ª –µ—Å—Ç—å: {{ h.plugstack_content.stdout | default('?') }}
          {% else %}
          ‚ùå –§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢
          {% endif %}
          
          {% if host in groups['slurm_compute'] %}
          üîß SLURMD:
          {% if h.slurmd_status.rc == 0 %}
          ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
          {% else %}
          ‚ùå –ü—Ä–æ–±–ª–µ–º—ã: {{ h.slurmd_status.stdout | default('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') }}
          {% endif %}
          {% endif %}
          
          üéÆ GPU:
          {% if h.nvidia_check.rc == 0 %}
          ‚úÖ GPU –Ω–∞–π–¥–µ–Ω—ã: {{ h.nvidia_check.stdout_lines | length }}
          {% else %}
          ‚ö™ GPU –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã
          {% endif %}
          
          {% endfor %}
          
          {% if hostvars[groups['slurm_master'][0]].container_test is defined %}
          üß™ –¢–ï–°–¢ –ö–û–ù–¢–ï–ô–ù–ï–†–ê:
          {{ hostvars[groups['slurm_master'][0]].container_test.stdout }}
          {% endif %}
          
          ==========================================
          
          üîß –ü–†–û–ë–õ–ï–ú–´ (—Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):
          {% for host in groups['slurm_cluster'] %}
          {% set h = hostvars[host] %}
          {% if not h.slurm_headers_check.stat.exists %}
          ‚ùå {{ host }}: –û–¢–°–£–¢–°–¢–í–£–Æ–¢ SLURM HEADERS
          {% endif %}
          {% if not h.pyxis_plugin_check.stat.exists and host in groups['slurm_compute'] %}
          ‚ùå {{ host }}: –û–¢–°–£–¢–°–¢–í–£–ï–¢ PYXIS –ü–õ–ê–ì–ò–ù  
          {% endif %}
          {% if not h.plugstack_check.stat.exists and host in groups['slurm_compute'] %}
          ‚ùå {{ host }}: –û–¢–°–£–¢–°–¢–í–£–ï–¢ PLUGSTACK.CONF
          {% endif %}
          {% if h.enroot_check.rc != 0 %}
          ‚ùå {{ host }}: ENROOT –ù–ï –†–ê–ë–û–¢–ê–ï–¢
          {% endif %}
          {% endfor %}
          
          ==========================================