# playbooks/containers.yml
---
# =============================================================================
# –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ù–û–ô –ü–û–î–î–ï–†–ñ–ö–ò (ENROOT + PYXIS)
# =============================================================================

- name: "üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏"
      debug:
        msg: |
          ================================================================================
          üê≥ –£–°–¢–ê–ù–û–í–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–ù–û–ô –ü–û–î–î–ï–†–ñ–ö–ò
          ================================================================================
          üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: Enroot + Pyxis + NVIDIA Container Toolkit
          üéØ –¶–µ–ª–µ–≤—ã–µ —É–∑–ª—ã: {{ groups['slurm_cluster'] | length }}
          üéÆ GPU —É–∑–ª—ã: {{ groups['gpu_nodes'] | default([]) | length }}
          
          üìä –£–∑–ª—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
          üñ•Ô∏è  Compute: {{ groups['slurm_compute'] | join(', ') }}
          üîë Login:   {{ groups['slurm_login'] | join(', ') }}
          üéõÔ∏è  Master:  {{ groups['slurm_master'] | join(', ') }}
          
          ‚è±Ô∏è  –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: ~20-30 –º–∏–Ω—É—Ç
          ================================================================================

# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê –ù–ê –í–°–ï –£–ó–õ–´ –ö–õ–ê–°–¢–ï–†–ê
# =============================================================================

- name: "üê≥ –≠—Ç–∞–ø 1/3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot –Ω–∞ –≤—Å–µ —É–∑–ª—ã"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–µ"
      debug:
        msg: |
          üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ {{ inventory_hostname }}
          üîß –†–æ–ª—å: {{ 'GPU' if inventory_hostname in groups['gpu_nodes'] | default([]) else 'CPU' }}
          üíæ RAM: {{ (ansible_memtotal_mb / 1024) | round(1) }}GB
      run_once: false

  roles:
    - containers

  post_tasks:
    - name: "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
      debug:
        msg: |
          ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ {{ inventory_hostname }}
          üê≥ Enroot: –≥–æ—Ç–æ–≤
          üîå Pyxis: {{ '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if inventory_hostname in groups['slurm_compute'] else '–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è' }}
          üéÆ NVIDIA: {{ '–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ' if inventory_hostname in groups['gpu_nodes'] | default([]) else '–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è' }}

# =============================================================================
# –û–ë–ù–û–í–õ–ï–ù–ò–ï SLURM –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
# =============================================================================

- name: "üê≥ –≠—Ç–∞–ø 2/3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Slurm –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
  hosts: slurm_master
  become: true
  tasks:
    - name: "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ slurm.conf"
      lineinfile:
        path: /etc/slurm/slurm.conf
        regexp: '^#?TaskPlugin='
        line: 'TaskPlugin=task/cgroup,task/affinity'
        backup: yes
      notify: restart slurmctld

    - name: "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ NFS"
      copy:
        src: /etc/slurm/slurm.conf
        dest: /sw/config/slurm.conf
        remote_src: yes
        owner: slurm
        group: slurm
        mode: '0644'

    - name: "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmctld –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"
      systemd:
        name: slurmctld
        state: restarted

  handlers:
    - name: restart slurmctld
      systemd:
        name: slurmctld
        state: restarted

# =============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
# =============================================================================

- name: "üê≥ –≠—Ç–∞–ø 3/3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
  hosts: slurm_master
  become: true
  tasks:
    - name: "üß™ –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
      shell: |
        echo "================================================================================"
        echo "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ù–û–ô –ü–û–î–î–ï–†–ñ–ö–ò"
        echo "================================================================================"
        echo ""
        
        echo "üê≥ –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
        timeout 300 srun -N1 --container-image=docker://hello-world || echo "–ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"
        echo ""
        
        echo "üêß –¢–µ—Å—Ç Ubuntu –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
        timeout 300 srun -N1 --container-image=docker://ubuntu:22.04 /bin/bash -c "uname -a && echo 'Ubuntu –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!'" || echo "Ubuntu —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"
        echo ""
        
        {% if groups['gpu_nodes'] | default([]) | length > 0 %}
        echo "üéÆ –¢–µ—Å—Ç GPU –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
        timeout 300 srun -N1 --container-image=nvcr.io/nvidia/cuda:12.3-runtime-ubuntu22.04 nvidia-smi || echo "GPU —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"
        echo ""
        {% endif %}
        
        echo "üìä –°—Ç–∞—Ç—É—Å —É–∑–ª–æ–≤ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
        sinfo -N
        echo ""
        
        echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—Ä–∞–∑—ã:"
        enroot list 2>/dev/null || echo "–ù–µ—Ç –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤"
        echo ""
        
        echo "================================================================================"
      register: container_tests
      failed_when: false
      changed_when: false

- name: "üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –ü–û –ö–û–ù–¢–ï–ô–ù–ï–†–ò–ó–ê–¶–ò–ò"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏"
      debug:
        msg: |
          ================================================================================
          üéâ –ö–û–ù–¢–ï–ô–ù–ï–†–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!
          ================================================================================
          
          üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:
          {{ hostvars[groups['slurm_master'][0]]['container_tests']['stdout'] }}
          
          ================================================================================
          ‚úÖ –ö–õ–ê–°–¢–ï–† –ì–û–¢–û–í –î–õ–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–û–í!
          ================================================================================
          
          üê≥ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
          
          # –ü—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          srun --container-image=docker://ubuntu:22.04 hostname
          
          # Python/AI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          srun --container-image=nvcr.io/nvidia/pytorch:23.12-py3 python --version
          
          {% if groups['gpu_nodes'] | default([]) | length > 0 %}
          # GPU –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          srun --gres=gpu:1 --container-image=nvcr.io/nvidia/cuda:12.3-runtime-ubuntu22.04 nvidia-smi
          
          # PyTorch —Å GPU
          srun --gres=gpu:1 --container-image=nvcr.io/nvidia/pytorch:23.12-py3 python -c "import torch; print(torch.cuda.is_available())"
          {% endif %}
          
          # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          srun --pty --container-image=docker://ubuntu:22.04 /bin/bash
          
          # Batch job —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
          sbatch --container-image=nvcr.io/nvidia/pytorch:23.12-py3 my_script.py
          
          üîß –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
          - enroot list                    # –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑–æ–≤
          - enroot import docker://image   # –ò–º–ø–æ—Ä—Ç –æ–±—Ä–∞–∑–∞  
          - enroot create image            # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          
          ================================================================================