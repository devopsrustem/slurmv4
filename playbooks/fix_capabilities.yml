# fix_capabilities.yml
---
- name: "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ENROOT CAPABILITIES"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Enroot Ğ´Ğ»Ñ unprivileged Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Enroot Configuration for Unprivileged Users
          # Generated by Ansible
          
          # Basic paths
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          
          # Mount points
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # CRITICAL: Disable capabilities for unprivileged users
          ENROOT_RESTRICT_DEV yes
          ENROOT_ROOTFS_WRITABLE no
          
          # User namespaces (if available)
          ENROOT_REMAP_ROOT yes
          
          # Disable setuid/setgid for security
          ENROOT_ALLOW_SETUID no
          
          # Don't try to set capabilities
          ENROOT_CAP_SYS_ADMIN no
          
          # Use squashfs for better compatibility
          ENROOT_SQUASH_OPTIONS -noappend
        owner: root
        group: root
        mode: '0644'
        backup: yes
      register: enroot_config_update
      
    - name: "ğŸ”§ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° user namespaces Ğ½Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ"
      shell: |
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ user namespaces:"
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ user namespaces
        if [ -f /proc/sys/user/max_user_namespaces ]; then
          echo "max_user_namespaces: $(cat /proc/sys/user/max_user_namespaces)"
        else
          echo "User namespaces Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ"
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ unprivileged_userns_clone
        if [ -f /proc/sys/kernel/unprivileged_userns_clone ]; then
          echo "unprivileged_userns_clone: $(cat /proc/sys/kernel/unprivileged_userns_clone)"
        else
          echo "unprivileged_userns_clone Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
        fi
        
        # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ user namespaces ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
        if [ -f /proc/sys/kernel/unprivileged_userns_clone ]; then
          current=$(cat /proc/sys/kernel/unprivileged_userns_clone)
          if [ "$current" = "0" ]; then
            echo "Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ unprivileged user namespaces..."
            echo 1 > /proc/sys/kernel/unprivileged_userns_clone
            echo "ĞĞ¾Ğ²Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ: $(cat /proc/sys/kernel/unprivileged_userns_clone)"
          fi
        fi
        
      register: userns_check
      failed_when: false
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ namespaces"
      debug:
        var: userns_check.stdout_lines
        
    - name: "ğŸ”§ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Enroot Configuration - Maximum Compatibility Mode
          # Generated by Ansible
          
          # Basic paths
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          
          # Mount points
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # COMPATIBILITY MODE - no advanced features
          ENROOT_RESTRICT_DEV yes
          ENROOT_ROOTFS_WRITABLE no
          ENROOT_ALLOW_SETUID no
          
          # Use simple extraction without capabilities
          ENROOT_ALLOW_SUPERUSER yes
          ENROOT_ALLOW_PRIVILEGED no
          
          # Disable problematic features
          ENROOT_SQUASH_OPTIONS -noappend -no-xattrs
        owner: root
        group: root
        mode: '0644'
      when: userns_check.stdout is defined and 'Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ' in userns_check.stdout

- name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ CAPABILITIES"
  hosts: slurm_master
  become: false
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ capabilities"
      shell: |
        echo "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ ĞŸĞĞ¡Ğ›Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ CAPABILITIES"
        echo "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: $(whoami)"
        echo ""
        
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ enroot:"
        head -10 /etc/enroot/enroot.conf
        echo ""
        
        echo "Ğ¢ĞµÑÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 120 srun --container-image=docker://hello-world 2>&1
        
        echo ""
        echo "Ğ¢ĞµÑÑ‚ Ubuntu ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 120 srun --container-image=docker://ubuntu:22.04 echo "Ubuntu container works!" 2>&1
        
      register: capabilities_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ Ğ¢Ğ•Ğ¡Ğ¢Ğ CAPABILITIES"
      debug:
        msg: |
          ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞĞ¡Ğ›Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ CAPABILITIES:
          {{ capabilities_test.stdout }}
          
          {% if 'Ubuntu container works!' in capabilities_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ UBUNTU ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ  Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! CAPABILITIES Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ«! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'Hello from Docker' in capabilities_test.stdout %}
          ğŸ‰ğŸ‰ HELLO-WORLD Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! ğŸ‰ğŸ‰
          {% elif 'failed to set capabilities' in capabilities_test.stdout %}
          ğŸ’” Ğ’ÑĞµ ĞµÑ‰Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ capabilities
          {% elif 'Permission denied' in capabilities_test.stdout %}
          ğŸ’” Ğ’ÑĞµ ĞµÑ‰Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸
          {% else %}
          âš ï¸ Ğ”Ñ€ÑƒĞ³Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ²Ñ‹Ğ²Ğ¾Ğ´
          {% endif %}