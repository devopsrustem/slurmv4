# playbooks/test_slurm_master_simple.yml
---
# =============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –£–ü–†–û–©–ï–ù–ù–û–ô –†–û–õ–ò SLURM_MASTER
# =============================================================================

- name: "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ slurm_master (–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è)"
  hosts: slurm_master
  become: yes
  gather_facts: yes  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–±–∏—Ä–∞–µ–º —Ñ–∞–∫—Ç—ã
  
  vars:
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    mysql_root_password: "testroot123"
    vault_slurm_db_password: "testslurm123"
    slurm_install_prefix: "/usr/local/slurm"  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    jwt_enabled: false  # –û—Ç–∫–ª—é—á–∞–µ–º JWT –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
    
  tasks:
    - name: "[TEST] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏"
      debug:
        msg: |
          üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ä–æ–ª—å slurm_master –Ω–∞ {{ inventory_hostname }}
          üì¶ Slurm —Å–æ–±—Ä–∞–Ω: {{ slurm_install_prefix }}
          üê¨ MariaDB —Ä–∞–±–æ—Ç–∞–µ—Ç: –ø—Ä–æ–≤–µ—Ä–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      tags: always

    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ MariaDB –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π"
      command: systemctl status mariadb
      register: mariadb_status
      changed_when: false
      tags: pre-check

    - name: "[TEST] –°—Ç–∞—Ç—É—Å MariaDB"
      debug:
        msg: "üê¨ MariaDB: {{ mariadb_status.rc == 0 | ternary('—Ä–∞–±–æ—Ç–∞–µ—Ç', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç') }}"
      tags: pre-check

    - name: "[TEST] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ slurm_master"
      include_role:
        name: slurm_master
      tags: role

    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
      stat:
        path: "{{ item }}"
      register: file_check
      loop:
        - "/etc/slurm/slurm.conf"
        - "/etc/slurm/slurmdbd.conf"  
        - "/etc/slurm/gres.conf"
        - "/etc/systemd/system/slurmctld.service"
        - "/etc/systemd/system/slurmdbd.service"
      tags: verify

    - name: "[TEST] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–æ–≤"
      debug:
        msg: |
          üìÅ {{ item.item }}: {{ item.stat.exists | ternary('‚úÖ —Å–æ–∑–¥–∞–Ω', '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') }}
      loop: "{{ file_check.results }}"
      tags: verify

    - name: "[TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤"
      systemd:
        name: "{{ item }}"
      register: service_check
      loop:
        - slurmdbd
        - slurmctld
      failed_when: false
      tags: verify

    - name: "[TEST] –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤"
      debug:
        msg: |
          üéõÔ∏è {{ item.item }}: {{ item.status.ActiveState | default('–Ω–µ –Ω–∞–π–¥–µ–Ω') }}
      loop: "{{ service_check.results }}"
      tags: verify

    - name: "[TEST] –¢–µ—Å—Ç scontrol ping"
      command: "/usr/bin/scontrol ping"
      register: scontrol_test
      changed_when: false
      failed_when: false
      tags: verify

    - name: "[TEST] –†–µ–∑—É–ª—å—Ç–∞—Ç scontrol ping"
      debug:
        msg: |
          üîß scontrol ping: 
          {% if scontrol_test.rc == 0 %}
          ‚úÖ –£–°–ü–ï–•: {{ scontrol_test.stdout }}
          {% else %}
          ‚ùå –û–®–ò–ë–ö–ê: {{ scontrol_test.stderr | default('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') }}
          {% endif %}
      tags: verify