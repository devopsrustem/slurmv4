---
- name: "ğŸ”¥ ĞŸĞ ĞĞ¡Ğ¢ĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• UBUNTU 24.04"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ”§ ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ AppArmor (Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ubuntu 24.04)"
      shell: |
        systemctl stop apparmor || true
        systemctl disable apparmor || true
        echo "AppArmor Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½"
      register: apparmor_fix
      
    - name: "ğŸ”§ Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ user namespaces Ğ´Ğ»Ñ Ubuntu 24.04"
      shell: |
        echo 1 > /proc/sys/kernel/unprivileged_userns_clone
        echo 65536 > /proc/sys/user/max_user_namespaces
        echo 'kernel.unprivileged_userns_clone=1' >> /etc/sysctl.conf
        echo 'user.max_user_namespaces=65536' >> /etc/sysctl.conf
        echo "User namespaces Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹"
      register: namespaces_fix
      
    - name: "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ enroot.conf Ğ´Ğ»Ñ Ubuntu 24.04"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Ubuntu 24.04 Compatible Configuration
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_TEMP_PATH /tmp
          
          # ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ Ğ´Ğ»Ñ Ubuntu 24.04
          ENROOT_REMAP_ROOT yes
          
          # Bind mounts
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
          ENROOT_ROOTFS_WRITABLE no
          ENROOT_ALLOW_SETUID no
          
          # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼
          ENROOT_SQUASH_OPTIONS -comp gzip -noappend
        owner: root
        group: root
        mode: '0644'
        
    - name: "ğŸ”§ ĞĞ±Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ´Ğ»Ñ enroot-aufs2ovlfs"
      shell: |
        if [ -f /usr/bin/enroot-aufs2ovlfs ]; then
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ backup
          cp /usr/bin/enroot-aufs2ovlfs /usr/bin/enroot-aufs2ovlfs.bak
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ wrapper Ğ±ĞµĞ· capabilities
          cat > /usr/bin/enroot-aufs2ovlfs << 'EOF'
        #!/bin/bash
        # Ubuntu 24.04 wrapper - Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ñ‚ capabilities Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ
        exec /usr/bin/enroot-aufs2ovlfs.bak "$@" 2>/dev/null || exit 0
        EOF
          chmod +x /usr/bin/enroot-aufs2ovlfs
          echo "enroot-aufs2ovlfs wrapper ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
        else
          echo "enroot-aufs2ovlfs Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
        fi
      register: aufs_fix
      
    - name: "ğŸ”§ Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹"
      shell: |
        mkdir -p /var/lib/enroot /var/cache/enroot /run/enroot
        chmod 1777 /var/cache/enroot /run/enroot
        chmod 755 /var/lib/enroot
        rm -rf /var/cache/enroot/* /run/enroot/* 2>/dev/null || true
        echo "ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹"
      register: dirs_fix
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹"
      debug:
        msg: |
          âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹:
          - AppArmor: {{ apparmor_fix.stdout }}
          - User namespaces: {{ namespaces_fix.stdout }}
          - aufs2ovlfs: {{ aufs_fix.stdout }}
          - Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸: {{ dirs_fix.stdout }}
          
    - name: "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº slurmd"
      systemd:
        name: slurmd
        state: restarted
      when: inventory_hostname in groups['slurm_compute']

- name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯"
  hosts: slurm_master
  become: false
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹"
      shell: |
        echo "=== Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞĞ¡Ğ›Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ™ ==="
        echo "AppArmor: $(systemctl is-active apparmor 2>/dev/null || echo 'Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½')"
        echo "User namespaces: $(cat /proc/sys/kernel/unprivileged_userns_clone)"
        echo ""
        echo "Ğ¢ĞµÑÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
        timeout 60 srun --container-image=docker://ubuntu:22.04 echo "Ubuntu 24.04 FIXED!" 2>&1
      register: container_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢"
      debug:
        msg: |
          {{ container_test.stdout }}
          
          {% if 'Ubuntu 24.04 FIXED!' in container_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ UBUNTU 24.04 Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ! ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢! ğŸ‰ğŸ‰ğŸ‰
          {% elif 'failed to set capabilities' in container_test.stdout %}
          âŒ ĞÑƒĞ¶Ğ½Ğ° Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹: sudo reboot
          {% else %}
          âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°
          {% endif %}