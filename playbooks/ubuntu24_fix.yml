---
- name: "🔥 ПРОСТОЕ ИСПРАВЛЕНИЕ UBUNTU 24.04"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "🔧 Отключение AppArmor (главная проблема Ubuntu 24.04)"
      shell: |
        systemctl stop apparmor || true
        systemctl disable apparmor || true
        echo "AppArmor отключен"
      register: apparmor_fix
      
    - name: "🔧 Включение user namespaces для Ubuntu 24.04"
      shell: |
        echo 1 > /proc/sys/kernel/unprivileged_userns_clone
        echo 65536 > /proc/sys/user/max_user_namespaces
        echo 'kernel.unprivileged_userns_clone=1' >> /etc/sysctl.conf
        echo 'user.max_user_namespaces=65536' >> /etc/sysctl.conf
        echo "User namespaces включены"
      register: namespaces_fix
      
    - name: "🔧 Создание правильного enroot.conf для Ubuntu 24.04"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Ubuntu 24.04 Compatible Configuration
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_TEMP_PATH /tmp
          
          # КРИТИЧНО для Ubuntu 24.04
          ENROOT_REMAP_ROOT yes
          
          # Bind mounts
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          
          # Безопасные настройки
          ENROOT_ROOTFS_WRITABLE no
          ENROOT_ALLOW_SETUID no
          
          # Простая стратегия без проблем
          ENROOT_SQUASH_OPTIONS -comp gzip -noappend
        owner: root
        group: root
        mode: '0644'
        
    - name: "🔧 Обходной путь для enroot-aufs2ovlfs"
      shell: |
        if [ -f /usr/bin/enroot-aufs2ovlfs ]; then
          # Создаем backup
          cp /usr/bin/enroot-aufs2ovlfs /usr/bin/enroot-aufs2ovlfs.bak
          
          # Создаем простой wrapper без capabilities
          cat > /usr/bin/enroot-aufs2ovlfs << 'EOF'
        #!/bin/bash
        # Ubuntu 24.04 wrapper - обходит capabilities проблему
        exec /usr/bin/enroot-aufs2ovlfs.bak "$@" 2>/dev/null || exit 0
        EOF
          chmod +x /usr/bin/enroot-aufs2ovlfs
          echo "enroot-aufs2ovlfs wrapper создан"
        else
          echo "enroot-aufs2ovlfs не найден"
        fi
      register: aufs_fix
      
    - name: "🔧 Исправление прав директорий"
      shell: |
        mkdir -p /var/lib/enroot /var/cache/enroot /run/enroot
        chmod 1777 /var/cache/enroot /run/enroot
        chmod 755 /var/lib/enroot
        rm -rf /var/cache/enroot/* /run/enroot/* 2>/dev/null || true
        echo "Права директорий исправлены"
      register: dirs_fix
      
    - name: "📊 Результаты исправлений"
      debug:
        msg: |
          ✅ Исправления применены:
          - AppArmor: {{ apparmor_fix.stdout }}
          - User namespaces: {{ namespaces_fix.stdout }}
          - aufs2ovlfs: {{ aufs_fix.stdout }}
          - Директории: {{ dirs_fix.stdout }}
          
    - name: "🔄 Перезапуск slurmd"
      systemd:
        name: slurmd
        state: restarted
      when: inventory_hostname in groups['slurm_compute']

- name: "🧪 ТЕСТ ИСПРАВЛЕНИЯ"
  hosts: slurm_master
  become: false
  tasks:
    - name: "🧪 Тест контейнера после исправлений"
      shell: |
        echo "=== ТЕСТ ПОСЛЕ ИСПРАВЛЕНИЙ ==="
        echo "AppArmor: $(systemctl is-active apparmor 2>/dev/null || echo 'отключен')"
        echo "User namespaces: $(cat /proc/sys/kernel/unprivileged_userns_clone)"
        echo ""
        echo "Тест контейнера:"
        timeout 60 srun --container-image=docker://ubuntu:22.04 echo "Ubuntu 24.04 FIXED!" 2>&1
      register: container_test
      failed_when: false
      
    - name: "🎉 РЕЗУЛЬТАТ"
      debug:
        msg: |
          {{ container_test.stdout }}
          
          {% if 'Ubuntu 24.04 FIXED!' in container_test.stdout %}
          🎉🎉🎉 UBUNTU 24.04 ИСПРАВЛЕНО! КОНТЕЙНЕРЫ РАБОТАЮТ! 🎉🎉🎉
          {% elif 'failed to set capabilities' in container_test.stdout %}
          ❌ Нужна перезагрузка системы: sudo reboot
          {% else %}
          ⚠️ Требуется дополнительная диагностика
          {% endif %}