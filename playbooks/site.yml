# site.yml - –û–±—â–∏–π playbook —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
---
- name: "üöÄ –£–°–¢–ê–ù–û–í–ö–ê SLURM HPC –ö–õ–ê–°–¢–ï–†–ê"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏"
      debug:
        msg: |
          üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Slurm HPC –∫–ª–∞—Å—Ç–µ—Ä–∞
          üìç Master:  {{ groups['slurm_master'] | join(', ') }}
          üìç Login:   {{ groups['slurm_login'] | join(', ') }}
          üìç Compute: {{ groups['slurm_compute'] | join(', ') }}

# –≠–¢–ê–ü 1: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- name: "–≠–¢–ê–ü 1: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - common

# –≠–¢–ê–ü 2: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Slurm 
- name: "–≠–¢–ê–ü 2: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Slurm"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - slurm_build

# –≠–¢–ê–ü 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ master
- name: "–≠–¢–ê–ü 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ master"
  hosts: slurm_master
  become: true
  gather_facts: true
  roles:
    - slurm_master

# –≠–¢–ê–ü 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ compute —É–∑–ª–æ–≤
- name: "–≠–¢–ê–ü 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ compute"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - slurm_compute

# –≠–¢–ê–ü 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ login —É–∑–ª–æ–≤
- name: "–≠–¢–ê–ü 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ login"
  hosts: slurm_login
  become: true
  gather_facts: true
  roles:
    - slurm_login

# –≠–¢–ê–ü 6: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ù–ê –í–°–ï–•
- name: "–≠–¢–ê–ü 6: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - containers

# –≠–¢–ê–ü 7: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
- name: "–≠–¢–ê–ü 7: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"
  hosts: slurm_cluster
  become: true
  tasks:
    - name: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd"
      systemd:
        name: slurmd
        state: restarted
        daemon_reload: yes
      when: inventory_hostname in groups['slurm_compute']

    - name: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmctld"
      systemd:
        name: slurmctld
        state: restarted
        daemon_reload: yes
      when: inventory_hostname in groups['slurm_master']

    - name: "–ü–∞—É–∑–∞"
      pause:
        seconds: 5

# –≠–¢–ê–ü 8: –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç
- name: "–≠–¢–ê–ü 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
  hosts: slurm_master
  become: true
  tasks:
    - name: "–¢–µ—Å—Ç –∫–ª–∞—Å—Ç–µ—Ä–∞"
      shell: |
        echo "=== –¢–ï–°–¢ –ö–õ–ê–°–¢–ï–†–ê ==="
        scontrol ping || echo "Controller –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è..."
        sinfo || echo "–£–∑–ª—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è..."
        srun -N1 hostname || echo "–¢–µ—Å—Ç –∑–∞–¥–∞—á–∏..."
        srun --container-image=docker://hello-world || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è..."
      register: cluster_test
      failed_when: false
      changed_when: false

    - name: "–†–µ–∑—É–ª—å—Ç–∞—Ç"
      debug:
        msg: |
          {{ cluster_test.stdout }}
          
          üéâ –ö–õ–ê–°–¢–ï–† –£–°–¢–ê–ù–û–í–õ–ï–ù!
          
          –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
          - sinfo
          - srun hostname
          - srun --container-image=docker://hello-world