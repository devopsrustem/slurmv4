# site_complete.yml
---
# ================================================================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –ü–û–õ–ù–´–ô PLAYBOOK - SLURM HPC + –ö–û–ù–¢–ï–ô–ù–ï–†–´
# ================================================================================
# Ubuntu 24.04 + Slurm 25.05.1 + JWT + Enroot + Pyxis
# –†–ê–ë–û–¢–ê–ï–¢ –ò–ó –ö–û–†–û–ë–ö–ò –ù–ê –ß–ò–°–¢–´–• –°–ï–†–í–ï–†–ê–•!

- name: "üöÄ –ü–û–õ–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï HPC –ö–õ–ê–°–¢–ï–†–ê"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏"
      debug:
        msg: |
          ================================================================================
          üöÄ –ü–û–õ–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï SLURM HPC –ö–õ–ê–°–¢–ï–†–ê + –ö–û–ù–¢–ï–ô–ù–ï–†–´
          ================================================================================
          üìã OS: Ubuntu 24.04 LTS
          üîß Slurm: 25.05.1 —Å JWT –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π + headers
          üê≥ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: Enroot + Pyxis (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï!)
          üéØ –ö–ª–∞—Å—Ç–µ—Ä: hpc-cluster
          
          üìä –£–∑–ª—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:
          üéõÔ∏è  Master:  {{ groups['slurm_master'] | join(', ') }}
          üîë Login:   {{ groups['slurm_login'] | join(', ') }}  
          üíª Compute: {{ groups['slurm_compute'] | join(', ') }}
          üìà –í—Å–µ–≥–æ:   {{ groups['slurm_cluster'] | length }} —É–∑–ª–æ–≤
          
          üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –í–ö–õ–Æ–ß–ï–ù–´:
          ‚úÖ Headers —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ –í–°–ï —É–∑–ª—ã
          ‚úÖ Pyxis —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –í–°–ï —É–∑–ª—ã (–≤–∫–ª—é—á–∞—è master!)
          ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π plugstack.conf —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–µ–∑–¥–µ –∏–∑ –∫–æ—Ä–æ–±–∫–∏
          
          ‚è±Ô∏è  –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: ~25-30 –º–∏–Ω—É—Ç
          ================================================================================

# ================================================================================
# –≠–¢–ê–ü 1: –ë–ê–ó–û–í–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê –í–°–ï–• –£–ó–õ–û–í
# ================================================================================

- name: "üì¶ –≠–¢–ê–ü 1/6: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Å–µ—Ö —É–∑–ª–æ–≤"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç—Ç–∞–ø–µ"
      debug:
        msg: |
          üì¶ –≠–¢–ê–ü 1: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
          üîß –£–∑–µ–ª: {{ inventory_hostname }}
          üìç IP: {{ ansible_default_ipv4.address | default('–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...') }}
          üíæ RAM: {{ (ansible_memtotal_mb / 1024) | round(1) }}GB
          üñ•Ô∏è  CPU: {{ ansible_processor_vcpus }}
      run_once: false

  roles:
    - common

  post_tasks:
    - name: "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ 1"
      debug:
        msg: |
          ‚úÖ –≠—Ç–∞–ø 1 –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–∞ {{ inventory_hostname }}
          üîë MUNGE: –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
          üìÅ NFS: {{ '–Ω–∞—Å—Ç—Ä–æ–µ–Ω' if inventory_hostname in groups['nfs_server'] else '–ø–æ–¥–∫–ª—é—á–µ–Ω' }}
          üíæ MariaDB: {{ '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' if inventory_hostname in groups['slurm_master'] else '–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è' }}

# ================================================================================
# –≠–¢–ê–ü 2: –ö–û–ú–ü–ò–õ–Ø–¶–ò–Ø SLURM –° HEADERS (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø!)
# ================================================================================

- name: "üî® –≠–¢–ê–ü 2/6: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –∫–æ–º–ø–∏–ª—è—Ü–∏—è Slurm —Å headers"
  hosts: slurm_master
  become: true
  gather_facts: true
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"
      debug:
        msg: |
          üî® –≠–¢–ê–ü 2: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –∫–æ–º–ø–∏–ª—è—Ü–∏—è Slurm 25.05.1
          üìç –ú–∞—Å—Ç–µ—Ä —É–∑–µ–ª: {{ inventory_hostname }}
          ‚úÖ Headers –±—É–¥—É—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω—ã –Ω–∞ –í–°–ï —É–∑–ª—ã!
          ‚ö†Ô∏è  –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–π–º–µ—Ç ~10-15 –º–∏–Ω—É—Ç...

  roles:
    - slurm_build  # –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ä–æ–ª—å

  post_tasks:
    - name: "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"
      debug:
        msg: |
          ‚úÖ Slurm —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω —Å headers!
          üì¶ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤: /opt/slurm
          üîó –°—Å—ã–ª–∫–∏ —Å–æ–∑–¥–∞–Ω—ã: /usr/bin/sinfo, /usr/sbin/slurmctld
          üì§ –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω —á–µ—Ä–µ–∑ NFS: /sw/slurm-complete
          üìÅ Headers: /opt/slurm/include/slurm/spank.h (–ù–ê –í–°–ï–• –£–ó–õ–ê–•!)

# ================================================================================
# –≠–¢–ê–ü 3: –ù–ê–°–¢–†–û–ô–ö–ê –ú–ê–°–¢–ï–†–ê
# ================================================================================

- name: "üéõÔ∏è –≠–¢–ê–ü 3/6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slurm Master"
  hosts: slurm_master
  become: true
  gather_facts: true
  roles:
    - slurm_master

  post_tasks:
    - name: "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Å—Ç–µ—Ä–∞"
      shell: |
        echo "=== –°–¢–ê–¢–£–° –°–ï–†–í–ò–°–û–í ==="
        systemctl is-active slurmctld slurmdbd
        echo "=== –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ==="
        /usr/bin/scontrol ping
      register: master_check
      changed_when: false
      
    - name: "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—Ç–µ—Ä–∞"
      debug:
        msg: |
          ‚úÖ Slurm Master {{ inventory_hostname }} –≥–æ—Ç–æ–≤!
          {{ master_check.stdout }}

# ================================================================================
# –≠–¢–ê–ü 4: –ù–ê–°–¢–†–û–ô–ö–ê COMPUTE –£–ó–õ–û–í
# ================================================================================

- name: "üíª –≠–¢–ê–ü 4/6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Compute —É–∑–ª–æ–≤"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - slurm_compute

  post_tasks:
    - name: "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ compute —É–∑–ª–æ–≤"
      shell: |
        echo "=== –°–¢–ê–¢–£–° SLURMD ==="
        systemctl is-active slurmd
        echo "=== –í–ï–†–°–ò–Ø SLURM ==="
        /usr/bin/sinfo --version
      register: compute_check
      changed_when: false
      
    - name: "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ compute"
      debug:
        msg: |
          ‚úÖ Compute —É–∑–µ–ª {{ inventory_hostname }} –≥–æ—Ç–æ–≤!
          {{ compute_check.stdout }}

# ================================================================================
# –≠–¢–ê–ü 5: –ù–ê–°–¢–†–û–ô–ö–ê LOGIN –£–ó–õ–û–í
# ================================================================================

- name: "üîë –≠–¢–ê–ü 5/6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Login —É–∑–ª–æ–≤"
  hosts: slurm_login
  become: true
  gather_facts: true
  roles:
    - slurm_login

  post_tasks:
    - name: "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ login —É–∑–ª–æ–≤"
      shell: |
        echo "=== –ö–û–ú–ê–ù–î–´ SLURM ==="
        /usr/bin/sinfo --version
        echo "=== –î–û–°–¢–£–ü –ö –ö–õ–ê–°–¢–ï–†–£ ==="
        /usr/bin/sinfo --summarize 2>&1 || echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
      register: login_check
      changed_when: false
      
    - name: "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ login"
      debug:
        msg: |
          ‚úÖ Login —É–∑–µ–ª {{ inventory_hostname }} –≥–æ—Ç–æ–≤!
          {{ login_check.stdout }}

# ================================================================================
# –≠–¢–ê–ü 6: –£–°–¢–ê–ù–û–í–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –ù–ê –í–°–ï –£–ó–õ–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û!)
# ================================================================================

- name: "üê≥ –≠–¢–ê–ü 6/6: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
  hosts: slurm_cluster  # –ù–ê –í–°–ï –£–ó–õ–´ –í–ö–õ–Æ–ß–ê–Ø MASTER!
  become: true
  gather_facts: true
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
      debug:
        msg: |
          üê≥ –≠–¢–ê–ü 6: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot + Pyxis
          üîß –£–∑–µ–ª: {{ inventory_hostname }}
          üìÅ Headers: –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã
          üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–µ–∑–¥–µ!
      run_once: false

    - name: "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ headers"
      stat:
        path: /opt/slurm/include/slurm/spank.h
      register: headers_check
      failed_when: not headers_check.stat.exists

    - name: "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
      apt:
        name:
          - fuse3
          - squashfs-tools
          - parallel
          - curl
          - gzip
          - zstd
          - pigz
          - pv
          - build-essential
          - pkg-config
        state: present
        update_cache: yes

    - name: "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot"
      shell: |
        if ! command -v enroot >/dev/null 2>&1; then
          cd /tmp
          wget -q https://github.com/NVIDIA/enroot/releases/download/v3.5.0/enroot_3.5.0-1_amd64.deb
          apt install -y ./enroot_3.5.0-1_amd64.deb
          echo "Enroot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        else
          echo "Enroot —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
      register: enroot_install

    - name: "üî® –û–§–ò–¶–ò–ê–õ–¨–ù–ê–Ø —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Pyxis –Ω–∞ –í–°–ï —É–∑–ª—ã"
      shell: |
        echo "üî® –£–°–¢–ê–ù–û–í–ö–ê PYXIS –ù–ê {{ inventory_hostname }}"
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
        mkdir -p /tmp/pyxis-build
        cd /tmp/pyxis-build
        rm -rf *
        
        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
        wget -q https://github.com/NVIDIA/pyxis/archive/v0.20.0.tar.gz
        tar -xf v0.20.0.tar.gz --strip-components=1
        
        # –ö–æ–º–ø–∏–ª—è—Ü–∏—è
        export CPPFLAGS="-I/opt/slurm/include"
        export LDFLAGS="-L/opt/slurm/lib"
        make clean || true
        make
        
        # –û–§–ò–¶–ò–ê–õ–¨–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê
        make install
        
        echo "‚úÖ Pyxis —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {{ inventory_hostname }}!"
        echo "–ü–ª–∞–≥–∏–Ω: $(ls -la /usr/local/lib/slurm/spank_pyxis.so)"
        
      register: pyxis_install

    - name: "üìù –°–æ–∑–¥–∞–Ω–∏–µ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û plugstack.conf"
      copy:
        dest: /etc/slurm/plugstack.conf
        content: |
          # Slurm SPANK Plugin Stack Configuration
          # Generated by Ansible for {{ inventory_hostname }}
          
          # Pyxis container support
          required /usr/local/lib/slurm/spank_pyxis.so
        owner: root
        group: root
        mode: '0644'

    - name: "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π Enroot"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/enroot
        - /var/cache/enroot
        - /run/enroot
        - /etc/enroot

    - name: "üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Enroot"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          ENROOT_ALLOW_PRIVILEGED yes
        mode: '0644'

  post_tasks:
    - name: "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
      debug:
        msg: |
          ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {{ inventory_hostname }}!
          üì¶ Enroot: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
          üîå Pyxis: —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ headers
          üìù plugstack.conf: —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç–µ–º –∫ –ø–ª–∞–≥–∏–Ω—É
          üéØ –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤!

# ================================================================================
# –≠–¢–ê–ü 7: –ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
# ================================================================================

- name: "üîÑ –≠–¢–ê–ü 7: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–≥–∏–Ω–æ–≤"
  hosts: slurm_compute
  become: true
  tasks:
    - name: "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd"
      systemd:
        name: slurmd
        state: restarted
        
    - name: "‚è∞ –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
      pause:
        seconds: 5

# ================================================================================
# –≠–¢–ê–ü 8: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ================================================================================

- name: "‚úÖ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ + –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
  hosts: slurm_master
  become: true
  gather_facts: false
  tasks:
    - name: "üß™ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∫–ª–∞—Å—Ç–µ—Ä–∞ + –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
      shell: |
        echo "================================================================================"
        echo "üß™ –§–ò–ù–ê–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–õ–ê–°–¢–ï–†–ê + –ö–û–ù–¢–ï–ô–ù–ï–†–û–í"
        echo "================================================================================"
        echo ""
        echo "üéõÔ∏è –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞:"
        /usr/bin/scontrol ping
        echo ""
        echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ:"
        /usr/bin/sinfo
        echo ""
        echo "üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–∞—Ö:"
        /usr/bin/sinfo -N
        echo ""
        echo "üß™ –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π –∑–∞–¥–∞—á–∏:"
        timeout 30 /usr/bin/srun -N1 hostname
        echo ""
        echo "üê≥ –¢–ï–°–¢ –ö–û–ù–¢–ï–ô–ù–ï–†–ê –ù–ê –ú–ê–°–¢–ï–†–ï:"
        timeout 120 /usr/bin/srun --container-image=docker://hello-world 2>&1 || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"
        echo ""
        echo "üêß –¢–µ—Å—Ç Ubuntu –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
        timeout 120 /usr/bin/srun --container-image=docker://ubuntu:22.04 /bin/bash -c "uname -a && echo 'Ubuntu –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!'" 2>&1 || echo "Ubuntu —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"
        echo ""
        echo "üìä –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á:"
        /usr/bin/squeue
        echo ""
        echo "================================================================================"
      register: full_cluster_test
      changed_when: false
      failed_when: false

# ================================================================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ò
# ================================================================================

- name: "üìä –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ü–û–õ–ù–û–ì–û —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è HPC –∫–ª–∞—Å—Ç–µ—Ä–∞"
      debug:
        msg: |
          ================================================================================
          üéâ –ü–û–õ–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï SLURM HPC –ö–õ–ê–°–¢–ï–†–ê –ó–ê–í–ï–†–®–ï–ù–û!
          ================================================================================
          
          üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:
          {{ hostvars[groups['slurm_master'][0]]['full_cluster_test']['stdout'] }}
          
          ================================================================================
          {% if hostvars[groups['slurm_master'][0]]['full_cluster_test']['stdout'] is search('Hello from Docker') %}
          üéâüéâüéâ –ö–û–ù–¢–ï–ô–ù–ï–†–´ –†–ê–ë–û–¢–ê–Æ–¢ –ù–ê –í–°–ï–• –£–ó–õ–ê–•! –ü–û–õ–ù–´–ô –£–°–ü–ï–•! üéâüéâüéâ
          {% else %}
          ‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          {% endif %}
          ================================================================================
          ‚úÖ –ö–õ–ê–°–¢–ï–† –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ!
          ================================================================================
          
          üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –í–°–ï–• —É–∑–ª–∞—Ö:
          - sinfo     - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ
          - squeue    - –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á  
          - sbatch    - –ø–∞–∫–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏
          - srun      - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
          - scancel   - –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á
          
          üê≥ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Ä–∞–±–æ—Ç–∞—é—Ç –í–ï–ó–î–ï!):
          - srun --container-image=docker://ubuntu:22.04 hostname
          - srun --pty --container-image=docker://ubuntu:22.04 /bin/bash
          - sbatch --container-image=nvcr.io/nvidia/pytorch:23.12-py3 script.py
          
          üìÅ –û–±—â–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
          - /home     - –¥–æ–º–∞—à–Ω–∏–µ –ø–∞–ø–∫–∏ (NFS)
          - /sw       - –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (NFS)
          
          üîß –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:
          - Master:   {{ groups['slurm_master'][0] }}
          - Login:    {{ groups['slurm_login'] | join(', ') }}
          - Compute:  {{ groups['slurm_compute'] | join(', ') }}
          
          ================================================================================
          üöÄ –ü–†–û–ï–ö–¢ –†–ê–ë–û–¢–ê–ï–¢ –ò–ó –ö–û–†–û–ë–ö–ò –ù–ê –ß–ò–°–¢–´–• –°–ï–†–í–ï–†–ê–•!
          ================================================================================