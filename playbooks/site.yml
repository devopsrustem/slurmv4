# site.yml - –û–±—â–∏–π playbook —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
---
- name: "üöÄ –£–°–¢–ê–ù–û–í–ö–ê SLURM HPC –ö–õ–ê–°–¢–ï–†–ê"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏"
      debug:
        msg: |
          üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Slurm HPC –∫–ª–∞—Å—Ç–µ—Ä–∞
          üìç Master:  {{ groups['slurm_master'] | join(', ') }}
          üìç Login:   {{ groups['slurm_login'] | join(', ') }}
          üìç Compute: {{ groups['slurm_compute'] | join(', ') }}

# –≠–¢–ê–ü 1: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- name: "–≠–¢–ê–ü 1: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - common

# –≠–¢–ê–ü 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PMIx –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö
- name: "–≠–¢–ê–ü 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PMIx"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - pmix

# –≠–¢–ê–ü 2.1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OpenMPI —Ç–æ–ª—å–∫–æ –Ω–∞ compute —É–∑–ª–∞—Ö
- name: "–≠–¢–ê–ü 2.1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OpenMPI"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - openmpi

# –≠–¢–ê–ü 3: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Slurm 
- name: "–≠–¢–ê–ü 3: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Slurm"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - slurm_build

# –≠–¢–ê–ü 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ master
- name: "–≠–¢–ê–ü 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ master"
  hosts: slurm_master
  become: true
  gather_facts: true
  roles:
    - slurm_master

# –≠–¢–ê–ü 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ compute —É–∑–ª–æ–≤
- name: "–≠–¢–ê–ü 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ compute"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - slurm_compute

# –≠–¢–ê–ü 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ login —É–∑–ª–æ–≤
- name: "–≠–¢–ê–ü 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ login"
  hosts: slurm_login
  become: true
  gather_facts: true
  roles:
    - slurm_login

# –≠–¢–ê–ü 7: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ AppArmor –Ω–∞ compute —É–∑–ª–∞—Ö
- name: "–≠–¢–ê–ü 7: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ AppArmor"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - grub_apparmor

# –≠–¢–ê–ü 8: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot —á–µ—Ä–µ–∑ nvidia.enroot —Ä–æ–ª—å
- name: "–≠–¢–ê–ü 8: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Enroot"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - nvidia.enroot

# –≠–¢–ê–ü 9: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Pyxis –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- name: "–≠–¢–ê–ü 9: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Pyxis"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - pyxis

# –≠–¢–ê–ü 10: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
- name: "–≠–¢–ê–ü 10: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"
  hosts: slurm_cluster
  become: true
  tasks:
    - name: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd"
      systemd:
        name: slurmd
        state: restarted
        daemon_reload: yes
      when: inventory_hostname in groups['slurm_compute']

    - name: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmctld"
      systemd:
        name: slurmctld
        state: restarted
        daemon_reload: yes
      when: inventory_hostname in groups['slurm_master']