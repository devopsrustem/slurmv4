---
# playbooks/site.yml
# ================================================================================
# –ü–û–õ–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï SLURM HPC –ö–õ–ê–°–¢–ï–†–ê
# ================================================================================
# Ubuntu 24.04 + Slurm 25.05.1 + JWT + Login —É–∑–µ–ª
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —á–∏—Å—Ç—ã—Ö VM

- name: "üöÄ Slurm HPC Cluster - –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏"
      debug:
        msg: |
          ================================================================================
          üöÄ –ü–û–õ–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï SLURM HPC –ö–õ–ê–°–¢–ï–†–ê
          ================================================================================
          üìã OS: Ubuntu 24.04 LTS
          üîß Slurm: 25.05.1 —Å JWT –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
          üéØ –ö–ª–∞—Å—Ç–µ—Ä: hpc-cluster
          
          üìä –£–∑–ª—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:
          üéõÔ∏è  Master:  {{ groups['slurm_master'] | join(', ') }}
          üîë Login:   {{ groups['slurm_login'] | join(', ') }}  
          üíª Compute: {{ groups['slurm_compute'] | join(', ') }}
          üìà –í—Å–µ–≥–æ:   {{ groups['slurm_cluster'] | length }} —É–∑–ª–æ–≤
          
          ‚è±Ô∏è  –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: ~15-20 –º–∏–Ω—É—Ç
          ================================================================================

# ================================================================================
# –≠–¢–ê–ü 1: –ë–ê–ó–û–í–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê –í–°–ï–• –£–ó–õ–û–í
# ================================================================================

- name: "üì¶ –≠–¢–ê–ü 1/5: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Å–µ—Ö —É–∑–ª–æ–≤"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç—Ç–∞–ø–µ"
      debug:
        msg: |
          üì¶ –≠–¢–ê–ü 1: –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
          üîß –£–∑–µ–ª: {{ inventory_hostname }}
          üìç IP: {{ ansible_default_ipv4.address | default('–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...') }}
          üíæ RAM: {{ (ansible_memtotal_mb / 1024) | round(1) }}GB
          üñ•Ô∏è  CPU: {{ ansible_processor_vcpus }}
      run_once: false

  roles:
    - common

  post_tasks:
    - name: "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ 1"
      debug:
        msg: |
          ‚úÖ –≠—Ç–∞–ø 1 –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–∞ {{ inventory_hostname }}
          üîë MUNGE: –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
          üìÅ NFS: {{ '–Ω–∞—Å—Ç—Ä–æ–µ–Ω' if inventory_hostname in groups['nfs_server'] else '–ø–æ–¥–∫–ª—é—á–µ–Ω' }}
          üíæ MariaDB: {{ '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' if inventory_hostname in groups['slurm_master'] else '–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è' }}

# ================================================================================
# –≠–¢–ê–ü 2: –ö–û–ú–ü–ò–õ–Ø–¶–ò–Ø SLURM –ù–ê –ú–ê–°–¢–ï–†–ï
# ================================================================================

- name: "üî® –≠–¢–ê–ü 2/5: –ö–æ–º–ø–∏–ª—è—Ü–∏—è Slurm –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ"
  hosts: slurm_master
  become: true
  gather_facts: true
  # tasks:
  #   - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"
  #     debug:
  #       msg: |
  #         üî® –≠–¢–ê–ü 2: –ö–æ–º–ø–∏–ª—è—Ü–∏—è Slurm 25.05.1
  #         üìç –ú–∞—Å—Ç–µ—Ä —É–∑–µ–ª: {{ inventory_hostname }}
  #         üíø –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ: {{ (ansible_mounts | selectattr('mount', 'equalto', '/tmp') | map(attribute='size_available') | first / 1024 / 1024 / 1024) | round(1) }}GB
  #         ‚ö†Ô∏è  –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–π–º–µ—Ç ~10-15 –º–∏–Ω—É—Ç...

  roles:
    - slurm_build

  post_tasks:
    - name: "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"
      debug:
        msg: |
          ‚úÖ Slurm —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω!
          üì¶ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤: /opt/slurm
          üîó –°—Å—ã–ª–∫–∏ —Å–æ–∑–¥–∞–Ω—ã: /usr/bin/sinfo, /usr/sbin/slurmctld
          üì§ –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω —á–µ—Ä–µ–∑ NFS: /sw/slurm-final

# ================================================================================
# –≠–¢–ê–ü 3: –ù–ê–°–¢–†–û–ô–ö–ê –ú–ê–°–¢–ï–†–ê
# ================================================================================

- name: "üéõÔ∏è –≠–¢–ê–ü 3/5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slurm Master"
  hosts: slurm_master
  become: true
  gather_facts: true
  roles:
    - slurm_master

  post_tasks:
    - name: "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Å—Ç–µ—Ä–∞"
      shell: |
        echo "=== –°–¢–ê–¢–£–° –°–ï–†–í–ò–°–û–í ==="
        systemctl is-active slurmctld slurmdbd
        echo "=== –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ==="
        /usr/bin/scontrol ping
      register: master_check
      changed_when: false
      
    - name: "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—Ç–µ—Ä–∞"
      debug:
        msg: |
          ‚úÖ Slurm Master {{ inventory_hostname }} –≥–æ—Ç–æ–≤!
          {{ master_check.stdout }}

# ================================================================================
# –≠–¢–ê–ü 4: –ù–ê–°–¢–†–û–ô–ö–ê COMPUTE –£–ó–õ–û–í
# ================================================================================

- name: "üíª –≠–¢–ê–ü 4/5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Compute —É–∑–ª–æ–≤"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - slurm_compute

  post_tasks:
    - name: "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ compute —É–∑–ª–æ–≤"
      shell: |
        echo "=== –°–¢–ê–¢–£–° SLURMD ==="
        systemctl is-active slurmd
        echo "=== –í–ï–†–°–ò–Ø SLURM ==="
        /usr/bin/sinfo --version
      register: compute_check
      changed_when: false
      
    - name: "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ compute"
      debug:
        msg: |
          ‚úÖ Compute —É–∑–µ–ª {{ inventory_hostname }} –≥–æ—Ç–æ–≤!
          {{ compute_check.stdout }}

# ================================================================================
# –≠–¢–ê–ü 5: –ù–ê–°–¢–†–û–ô–ö–ê LOGIN –£–ó–õ–û–í
# ================================================================================

- name: "üîë –≠–¢–ê–ü 5/5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Login —É–∑–ª–æ–≤"
  hosts: slurm_login
  become: true
  gather_facts: true
  roles:
    - slurm_login

  post_tasks:
    - name: "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ login —É–∑–ª–æ–≤"
      shell: |
        echo "=== –ö–û–ú–ê–ù–î–´ SLURM ==="
        /usr/bin/sinfo --version
        echo "=== –î–û–°–¢–£–ü –ö –ö–õ–ê–°–¢–ï–†–£ ==="
        /usr/bin/sinfo --summarize 2>&1 || echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
      register: login_check
      changed_when: false
      
    - name: "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ login"
      debug:
        msg: |
          ‚úÖ Login —É–∑–µ–ª {{ inventory_hostname }} –≥–æ—Ç–æ–≤!
          {{ login_check.stdout }}

# ================================================================================
# –≠–¢–ê–ü 6: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ================================================================================

- name: "‚úÖ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞"
  hosts: slurm_master
  become: true
  gather_facts: false
  tasks:
    - name: "üß™ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∫–ª–∞—Å—Ç–µ—Ä–∞"
      shell: |
        echo "================================================================================"
        echo "üß™ –§–ò–ù–ê–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–õ–ê–°–¢–ï–†–ê"
        echo "================================================================================"
        echo ""
        echo "üéõÔ∏è –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞:"
        /usr/bin/scontrol ping
        echo ""
        echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ:"
        /usr/bin/sinfo
        echo ""
        echo "üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–∞—Ö:"
        /usr/bin/sinfo -N
        echo ""
        echo "üìã –†–∞–∑–¥–µ–ª—ã –∫–ª–∞—Å—Ç–µ—Ä–∞:"
        /usr/bin/sinfo -s
        echo ""
        echo "üß™ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:"
        /usr/bin/srun -N1 hostname
        echo ""
        echo "üß™ –¢–µ—Å—Ç –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö:"
        /usr/bin/srun -N2 hostname
        echo ""
        echo "üìä –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á:"
        /usr/bin/squeue
        echo ""
        echo "================================================================================"
      register: full_cluster_test
      changed_when: false
      failed_when: false

- name: "‚úÖ –ü–†–û–í–ï–†–ö–ê LOGIN –£–ó–õ–û–í"
  hosts: slurm_login
  become: true
  gather_facts: false
  tasks:
    - name: "üîë –¢–µ—Å—Ç login —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏"
      shell: |
        echo "üîë –¢–µ—Å—Ç login —É–∑–ª–∞ {{ inventory_hostname }}:"
        echo "  –í–µ—Ä—Å–∏—è: $(/usr/bin/sinfo --version)"
        echo "  –ö–ª–∞—Å—Ç–µ—Ä: $(/usr/bin/sinfo --summarize 2>&1 | head -1 || echo '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω')"
        echo "  –ö–æ–º–∞–Ω–¥—ã: $(ls /usr/bin/s* | grep -E '(sinfo|squeue|srun|sbatch)' | wc -l) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
      register: login_final_test
      changed_when: false

# ================================================================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ò
# ================================================================================

- name: "üìä –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è HPC –∫–ª–∞—Å—Ç–µ—Ä–∞"
      debug:
        msg: |
          ================================================================================
          üéâ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï SLURM HPC –ö–õ–ê–°–¢–ï–†–ê –ó–ê–í–ï–†–®–ï–ù–û!
          ================================================================================
          
          üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:
          {{ hostvars[groups['slurm_master'][0]]['full_cluster_test']['stdout'] }}
          
          üîë LOGIN –£–ó–õ–´:
          {% for host in groups['slurm_login'] %}
          {{ hostvars[host]['login_final_test']['stdout'] }}
          {% endfor %}
          
          ================================================================================
          ‚úÖ –ö–õ–ê–°–¢–ï–† –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ!
          ================================================================================
          
          üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è:
          {% for host in groups['slurm_login'] %}
          ssh username@{{ host }}
          {% endfor %}
          
          üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
          - sinfo     - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ
          - squeue    - –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á  
          - sbatch    - –ø–∞–∫–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏
          - srun      - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
          - scancel   - –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á
          
          üìÅ –û–±—â–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
          - /home     - –¥–æ–º–∞—à–Ω–∏–µ –ø–∞–ø–∫–∏ (NFS)
          - /sw       - –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (NFS)
          - /scratch  - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          - /projects - –ø—Ä–æ–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          
          üîß –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:
          - Master:   {{ groups['slurm_master'][0] }}
          - Login:    {{ groups['slurm_login'] | join(', ') }}
          - Compute:  {{ groups['slurm_compute'] | join(', ') }}
          
          üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
          1. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ login —É–∑–ª–∞—Ö
          2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞
          3. –î–æ–±–∞–≤–∏—Ç—å Pyxis + Enroot –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GPU –ø–æ–¥–¥–µ—Ä–∂–∫—É (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏)
          
          ================================================================================