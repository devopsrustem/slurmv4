# playbooks/site.yml - Main cluster deployment playbook
---
- name: "Deploy Slurm HPC cluster"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "Display deployment info"
      debug:
        msg: |
          Deploying Slurm HPC cluster
          Master nodes: {{ groups['slurm_master'] | join(', ') }}
          Login nodes:  {{ groups['slurm_login'] | join(', ') }}
          Compute nodes: {{ groups['slurm_compute'] | join(', ') }}

- name: "Base system preparation"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - common

- name: "Install PMIx on all nodes"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - pmix

- name: "Install OpenMPI on compute nodes"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - openmpi

- name: "Build and distribute Slurm"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - slurm_build

- name: "Configure master nodes"
  hosts: slurm_master
  become: true
  gather_facts: true
  roles:
    - slurm_master

- name: "Configure compute nodes"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - slurm_compute

- name: "Configure login nodes"
  hosts: slurm_login
  become: true
  gather_facts: true
  roles:
    - slurm_login

- name: "Disable AppArmor on compute nodes"
  hosts: slurm_compute
  become: true
  gather_facts: true
  roles:
    - grub_apparmor

- name: "Install Enroot container runtime"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - nvidia.enroot

- name: "Install Pyxis container integration"
  hosts: slurm_cluster
  become: true
  gather_facts: true
  roles:
    - pyxis

- name: "Restart Slurm services"
  hosts: slurm_cluster
  become: true
  tasks:
    - name: "Restart slurmd service"
      systemd:
        name: slurmd
        state: restarted
        daemon_reload: yes
      when: inventory_hostname in groups['slurm_compute']

    - name: "Restart slurmctld service"
      systemd:
        name: slurmctld
        state: restarted
        daemon_reload: yes
      when: inventory_hostname in groups['slurm_master']