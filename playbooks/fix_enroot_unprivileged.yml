# fix_enroot_unprivileged.yml
---
# =============================================================================
# –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: ENROOT –î–õ–Ø UNPRIVILEGED –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
# =============================================================================
# –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ + DeepOps + Pyxis Wiki

- name: "üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Enroot –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  hosts: slurm_cluster
  become: true
  gather_facts: false
  
  tasks:
    - name: "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏"
      debug:
        msg: |
          üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ENROOT
          ================================
          ‚úÖ –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—É—Ç–∏
          ‚úÖ Prolog/Epilog —Å–∫—Ä–∏–ø—Ç—ã –∫–∞–∫ –≤ DeepOps
          ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ root –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
          ================================

# =============================================================================
# –≠–¢–ê–ü 1: –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ENROOT
# =============================================================================

    - name: "üìù –°–æ–∑–¥–∞–Ω–∏–µ –ü–†–û–î–ê–ö–®–ù –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ enroot.conf"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          # Enroot Configuration - PRODUCTION SETUP
          # Based on NVIDIA/pyxis wiki + real production deployment
          
          # =============================================================================
          # USER-SPECIFIC PATHS (–∫–ª—é—á –∫ —Ä–µ—à–µ–Ω–∏—é!)
          # =============================================================================
          
          # Runtime path - per user (–∫–∞–∫ –≤ –ø—Ä–æ–¥–µ)
          ENROOT_RUNTIME_PATH /run/enroot/user-$(id -u)
          
          # Cache path - per group (—ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞)
          ENROOT_CACHE_PATH /var/lib/enroot-cache/group-$(id -g)
          
          # Data path - per user (–∏–∑–æ–ª—è—Ü–∏—è)
          ENROOT_DATA_PATH /tmp/enroot-data/user-$(id -u)
          
          # =============================================================================
          # UNPRIVILEGED SETTINGS
          # =============================================================================
          
          # –ù–ï –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å home –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          ENROOT_MOUNT_HOME n
          
          # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º  
          ENROOT_RESTRICT_DEV y
          
          # –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          ENROOT_ROOTFS_WRITABLE y
          
          # –ù–ï –¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è root'–æ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–ö–õ–Æ–ß–ï–í–û–ï!)
          ENROOT_REMAP_ROOT n
          
          # =============================================================================
          # PERFORMANCE SETTINGS
          # =============================================================================
          
          # –û—Ç–∫–ª—é—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
          ENROOT_SQUASH_OPTIONS -noI -noD -noF -noX -no-duplicates
          
          # –†–∞–∑—Ä–µ—à–∏—Ç—å superuser —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
          ENROOT_ALLOW_SUPERUSER n
          
          # =============================================================================
          # –úOUNTING –ù–ê–°–¢–†–û–ô–ö–ò
          # =============================================================================
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          # ENROOT_MOUNT_HOME /home:/home
          # ENROOT_MOUNT_HOME /sw:/sw
        owner: root
        group: root
        mode: '0644'
        backup: yes

# =============================================================================
# –≠–¢–ê–ü 2: PROLOG –°–ö–†–ò–ü–¢ (—Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∫–∞–∫ –≤ –ø—Ä–æ–¥–µ)
# =============================================================================

    - name: "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è prolog —Å–∫—Ä–∏–ø—Ç–æ–≤"
      file:
        path: /etc/slurm/prolog.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "üìù –°–æ–∑–¥–∞–Ω–∏–µ Prolog —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è Enroot (–∫–∞–∫ –≤ –ø—Ä–æ–¥–µ)"
      copy:
        dest: /etc/slurm/prolog.d/50-all-enroot-dirs
        content: |
          #!/usr/bin/env bash
          # Slurm Prolog: Create Enroot directories for unprivileged users
          # Based on production configuration from DeepOps
          
          set -ex
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ enroot
          command -v enroot >/dev/null || exit 0
          
          # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
          logger -s -t slurm-prolog-enroot "Creating enroot dirs for user=$SLURM_JOB_USER job=$SLURM_JOB_ID"
          
          # =============================================================================
          # RUNTIME PATH - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π
          # =============================================================================
          
          runtime_path="$(sudo -u "$SLURM_JOB_USER" sh -c 'echo "/run/enroot/user-$(id -u)"')"
          mkdir -p "$runtime_path"
          chown "$SLURM_JOB_UID:$(id -g "$SLURM_JOB_UID")" "$runtime_path"
          chmod 0755 "$(dirname "$runtime_path")" 2>/dev/null || true
          chmod 0700 "$runtime_path"
          
          # =============================================================================
          # CACHE PATH - –≥—Ä—É–ø–ø–æ–≤–æ–π (—ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞)
          # =============================================================================
          
          cache_path="$(sudo -u "$SLURM_JOB_USER" sh -c 'echo "/var/lib/enroot-cache/group-$(id -g)"')"
          mkdir -p "$cache_path"
          chown "$SLURM_JOB_UID:$(id -g "$SLURM_JOB_UID")" "$cache_path"
          chmod 0770 "$cache_path"
          
          # =============================================================================
          # DATA PATH - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π
          # =============================================================================
          
          data_path="$(sudo -u "$SLURM_JOB_USER" sh -c 'echo "/tmp/enroot-data/user-$(id -u)"')"
          mkdir -p "$data_path"
          chown "$SLURM_JOB_UID:$(id -g "$SLURM_JOB_UID")" "$data_path"
          chmod 0700 "$data_path"
          
          logger -s -t slurm-prolog-enroot "Created: runtime=$runtime_path cache=$cache_path data=$data_path"
        owner: root
        group: root
        mode: '0755'

# =============================================================================
# –≠–¢–ê–ü 3: EPILOG –°–ö–†–ò–ü–¢ (–æ—á–∏—Å—Ç–∫–∞ –∫–∞–∫ –≤ –ø—Ä–æ–¥–µ)
# =============================================================================

    - name: "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è epilog —Å–∫—Ä–∏–ø—Ç–æ–≤"
      file:
        path: /etc/slurm/epilog.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "üìù –°–æ–∑–¥–∞–Ω–∏–µ Epilog —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è Enroot (–∫–∞–∫ –≤ –ø—Ä–æ–¥–µ)"
      copy:
        dest: /etc/slurm/epilog.d/50-lastuserjob-all-enroot-dirs
        content: |
          #!/usr/bin/env bash
          # Slurm Epilog: Cleanup Enroot directories for unprivileged users
          # Based on production configuration from DeepOps
          
          set -ex
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ enroot
          command -v enroot >/dev/null || exit 0
          
          # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
          logger -s -t slurm-epilog-enroot "Cleaning enroot dirs for user=$SLURM_JOB_USER job=$SLURM_JOB_ID"
          
          # =============================================================================
          # –û–ß–ò–°–¢–ö–ê RUNTIME PATH
          # =============================================================================
          
          runtime_path="$(sudo -u "$SLURM_JOB_USER" sh -c 'echo "/run/enroot/user-$(id -u)"')"
          if [ -d "$runtime_path" ]; then
            rm -rf "$runtime_path"
            logger -s -t slurm-epilog-enroot "Cleaned runtime: $runtime_path"
          fi
          
          # =============================================================================
          # –û–ß–ò–°–¢–ö–ê DATA PATH (–ù–ï —Ç—Ä–æ–≥–∞–µ–º cache - –æ–Ω –æ–±—â–∏–π)
          # =============================================================================
          
          data_path="$(sudo -u "$SLURM_JOB_USER" sh -c 'echo "/tmp/enroot-data/user-$(id -u)"')"
          if [ -d "$data_path" ]; then
            rm -rf "$data_path"
            logger -s -t slurm-epilog-enroot "Cleaned data: $data_path"
          fi
        owner: root
        group: root
        mode: '0755'

# =============================================================================
# –≠–¢–ê–ü 4: –û–°–ù–û–í–ù–´–ï PROLOG/EPILOG –°–ö–†–ò–ü–¢–´
# =============================================================================

    - name: "üìù –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ prolog —Å–∫—Ä–∏–ø—Ç–∞"
      copy:
        dest: /etc/slurm/prolog.sh
        content: |
          #!/usr/bin/env bash
          # Main Slurm Prolog Script
          
          set -e
          
          logger -s -t slurm-prolog "START user=$SLURM_JOB_USER job=$SLURM_JOB_ID"
          
          # –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö prolog —Å–∫—Ä–∏–ø—Ç–æ–≤
          if [ -d /etc/slurm/prolog.d ]; then
            for script in /etc/slurm/prolog.d/*; do
              if [ -x "$script" ]; then
                logger -s -t slurm-prolog "Running $script"
                "$script"
              fi
            done
          fi
          
          logger -s -t slurm-prolog "END user=$SLURM_JOB_USER job=$SLURM_JOB_ID"
        owner: root
        group: root
        mode: '0755'

    - name: "üìù –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ epilog —Å–∫—Ä–∏–ø—Ç–∞"
      copy:
        dest: /etc/slurm/epilog.sh
        content: |
          #!/usr/bin/env bash
          # Main Slurm Epilog Script
          
          set -e
          
          logger -s -t slurm-epilog "START user=$SLURM_JOB_USER job=$SLURM_JOB_ID"
          
          # –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö epilog —Å–∫—Ä–∏–ø—Ç–æ–≤
          if [ -d /etc/slurm/epilog.d ]; then
            for script in /etc/slurm/epilog.d/*; do
              if [ -x "$script" ]; then
                logger -s -t slurm-epilog "Running $script"
                "$script"
              fi
            done
          fi
          
          logger -s -t slurm-epilog "END user=$SLURM_JOB_USER job=$SLURM_JOB_ID"
        owner: root
        group: root
        mode: '0755'

# =============================================================================
# –≠–¢–ê–ü 5: –û–ë–ù–û–í–õ–ï–ù–ò–ï SLURM –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
# =============================================================================

    - name: "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Prolog/Epilog –≤ slurm.conf"
      lineinfile:
        path: /etc/slurm/slurm.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^#?Prolog=', line: 'Prolog=/etc/slurm/prolog.sh' }
        - { regexp: '^#?Epilog=', line: 'Epilog=/etc/slurm/epilog.sh' }
      when: inventory_hostname in groups['slurm_master']

    - name: "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ NFS"
      copy:
        src: /etc/slurm/slurm.conf
        dest: /sw/config/slurm.conf
        remote_src: yes
        owner: slurm
        group: slurm
        mode: '0644'
      when: inventory_hostname in groups['slurm_master']

    - name: "üì• –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ —É–∑–ª—ã"
      copy:
        src: /sw/config/slurm.conf
        dest: /etc/slurm/slurm.conf
        remote_src: yes
        owner: slurm
        group: slurm
        mode: '0644'
        backup: yes
      when: inventory_hostname not in groups['slurm_master']

# =============================================================================
# –≠–¢–ê–ü 6: –ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
# =============================================================================

    - name: "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmctld –Ω–∞ master"
      systemd:
        name: slurmctld
        state: restarted
      when: inventory_hostname in groups['slurm_master']

    - name: "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ slurmd –Ω–∞ compute —É–∑–ª–∞—Ö"
      systemd:
        name: slurmd
        state: restarted
      when: inventory_hostname in groups['slurm_compute']

    - name: "‚è∞ –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
      pause:
        seconds: 5

# =============================================================================
# –≠–¢–ê–ü 7: –§–ò–ù–ê–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# =============================================================================

- name: "üß™ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  hosts: slurm_master
  become: false  # ‚ùó –ö–†–ò–¢–ò–ß–ù–û - —Ç–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!
  tasks:
    - name: "üß™ –¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
      shell: |
        echo "üß™ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ ENROOT –î–õ–Ø –û–ë–´–ß–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô"
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami) (UID: $(id -u))"
        echo "–î–∞—Ç–∞: $(date)"
        echo ""
        
        echo "=== –ü–†–û–í–ï–†–ö–ê ENROOT –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ==="
        echo "ENROOT_RUNTIME_PATH –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: /run/enroot/user-$(id -u)"
        echo "ENROOT_CACHE_PATH –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: /var/lib/enroot-cache/group-$(id -g)"
        echo "ENROOT_DATA_PATH –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: /tmp/enroot-data/user-$(id -u)"
        echo ""
        
        echo "=== –¢–ï–°–¢ –ü–†–û–°–¢–û–ì–û –ö–û–ù–¢–ï–ô–ù–ï–†–ê ==="
        timeout 120 srun --container-image=docker://hello-world 2>&1
        echo ""
        
        echo "=== –¢–ï–°–¢ UBUNTU –ö–û–ù–¢–ï–ô–ù–ï–†–ê ==="
        timeout 120 srun --container-image=docker://ubuntu:22.04 /bin/bash -c "whoami && id && echo 'SUCCESS: Ubuntu –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!'" 2>&1
        echo ""
        
        echo "=== –ü–†–û–í–ï–†–ö–ê –î–ò–†–ï–ö–¢–û–†–ò–ô –ü–û–°–õ–ï –ó–ê–î–ê–ß–ò ==="
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—á–∏—â–µ–Ω—ã epilog —Å–∫—Ä–∏–ø—Ç–æ–º"
        ls -la /run/enroot/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /run/enroot –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
        ls -la /tmp/enroot-data/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /tmp/enroot-data –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
        echo ""
        
      register: final_test
      failed_when: false

    - name: "üéâ –†–ï–ó–£–õ–¨–¢–ê–¢ –§–ò–ù–ê–õ–¨–ù–û–ì–û –¢–ï–°–¢–ê"
      debug:
        msg: |
          ===============================================================================
          üéØ –†–ï–ó–£–õ–¨–¢–ê–¢ –§–ò–ù–ê–õ–¨–ù–û–ì–û –¢–ï–°–¢–ê ENROOT –î–õ–Ø –û–ë–´–ß–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:
          ===============================================================================
          
          {{ final_test.stdout }}
          
          {% if 'SUCCESS: Ubuntu –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!' in final_test.stdout %}
          üéâüéâüéâ –ü–û–õ–ù–ê–Ø –ü–û–ë–ï–î–ê! ENROOT –†–ê–ë–û–¢–ê–ï–¢ –î–õ–Ø –û–ë–´–ß–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô! üéâüéâüéâ
          
          ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –±–µ–∑ root
          ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—É—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç  
          ‚úÖ Prolog —Å–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
          ‚úÖ Epilog –æ—á–∏—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
          ‚úÖ –ü—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
          
          üìã –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:
          - srun --container-image=docker://ubuntu:22.04 hostname
          - srun --pty --container-image=docker://ubuntu:22.04 bash
          - sbatch --container-image=nvcr.io/nvidia/pytorch:latest script.py
          
          üöÄ –ö–õ–ê–°–¢–ï–† –ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ï–ù–£ –ë–ï–ó ROOT!
          
          {% elif 'Hello from Docker' in final_test.stdout %}
          üéâüéâ –ë–ê–ó–û–í–´–ï –ö–û–ù–¢–ï–ô–ù–ï–†–´ –†–ê–ë–û–¢–ê–Æ–¢! üéâüéâ
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Ubuntu —Ç–µ—Å—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
          
          {% else %}
          üíî –ü—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
          - journalctl -u slurmd -f
          - /var/log/slurm/slurmd.log  
          - /var/log/syslog (prolog/epilog –ª–æ–≥–∏)
          
          {% endif %}
          ===============================================================================

# =============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# =============================================================================

- name: "üìã –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "üéØ –ò—Ç–æ–≥–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
      debug:
        msg: |
          ===============================================================================
          üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ENROOT –ó–ê–í–ï–†–®–ï–ù–û
          ===============================================================================
          
          ‚úÖ –ü–†–ò–ú–ï–ù–ï–ù–û –ü–†–û–î–ê–ö–®–ù –†–ï–®–ï–ù–ò–ï:
          
          üìù 1. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è enroot.conf —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –ø—É—Ç—è–º–∏:
             - ENROOT_RUNTIME_PATH /run/enroot/user-$(id -u)
             - ENROOT_CACHE_PATH /var/lib/enroot-cache/group-$(id -g)  
             - ENROOT_DATA_PATH /tmp/enroot-data/user-$(id -u)
             - ENROOT_REMAP_ROOT n (–Ω–µ –¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è root'–æ–º!)
          
          üìÅ 2. Prolog —Å–∫—Ä–∏–ø—Ç (–∫–∞–∫ –≤ DeepOps):
             - –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
             - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (0700 –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
             - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ü–ï–†–ï–î –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–µ–π
          
          üßπ 3. Epilog —Å–∫—Ä–∏–ø—Ç (–∫–∞–∫ –≤ DeepOps):
             - –û—á–∏—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
             - –û—Å—Ç–∞–≤–ª—è–µ—Ç –≥—Ä—É–ø–ø–æ–≤–æ–π cache –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º
             - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ü–û–°–õ–ï –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
          
          ‚öôÔ∏è  4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Slurm:
             - Prolog=/etc/slurm/prolog.sh
             - Epilog=/etc/slurm/epilog.sh
             - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
          
          üéØ –†–ï–ó–£–õ–¨–¢–ê–¢:
          –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è –û–ë–´–ß–ù–´–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ root –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π!
          –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ + –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ NVIDIA.
          
          ===============================================================================