# fix_master.yml
---
- name: "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞœĞĞ¡Ğ¢Ğ•Ğ Ğ - Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ PYXIS"
  hosts: slurm_master
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° pyxis Ğ½Ğ° Ğ¼Ğ°ÑÑ‚ĞµÑ€"
      shell: |
        echo "ğŸ”§ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ PYXIS ĞĞ ĞœĞĞ¡Ğ¢Ğ•Ğ "
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ headers
        if [ ! -f /opt/slurm/include/slurm/spank.h ]; then
          echo "âŒ Headers Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹!"
          exit 1
        fi
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
        apt update
        apt install -y build-essential pkg-config
        
        # ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° build Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        mkdir -p /tmp/pyxis-build
        cd /tmp/pyxis-build
        rm -rf *
        
        # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ
        wget -q https://github.com/NVIDIA/pyxis/archive/v0.20.0.tar.gz
        tar -xf v0.20.0.tar.gz --strip-components=1
        
        export CPPFLAGS="-I/opt/slurm/include"
        export LDFLAGS="-L/opt/slurm/lib"
        
        make clean || true
        make
        
        # ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ¯ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ
        make install
        
        echo "âœ… Pyxis ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ½Ğ° Ğ¼Ğ°ÑÑ‚ĞµÑ€!"
        echo "ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½: $(ls -la /usr/local/lib/slurm/spank_pyxis.so)"
        echo "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³: $(ls -la /usr/local/share/pyxis/pyxis.conf)"
        
      register: master_pyxis_install
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ½Ğ° Ğ¼Ğ°ÑÑ‚ĞµÑ€"
      debug:
        var: master_pyxis_install.stdout_lines
        
    - name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞĞ ĞœĞĞ¡Ğ¢Ğ•Ğ Ğ•"
      shell: |
        echo "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ ĞĞ ĞœĞĞ¡Ğ¢Ğ•Ğ Ğ•"
        timeout 60 srun --container-image=docker://hello-world 2>&1
      register: master_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ Ğ¢Ğ•Ğ¡Ğ¢Ğ ĞœĞĞ¡Ğ¢Ğ•Ğ Ğ"
      debug:
        msg: |
          ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞĞ ĞœĞĞ¡Ğ¢Ğ•Ğ Ğ•:
          {{ master_test.stdout }}
          {{ master_test.stderr }}
          
          {% if 'Hello from Docker' in master_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞœĞĞ¡Ğ¢Ğ•Ğ  Ğ¢ĞĞ–Ğ• Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢! ĞŸĞĞ›ĞĞĞ¯ ĞŸĞĞ‘Ğ•Ğ”Ğ! ğŸ‰ğŸ‰ğŸ‰
          {% else %}
          ğŸ’” ĞœĞ°ÑÑ‚ĞµÑ€ ĞµÑ‰Ğµ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼...
          {% endif %}