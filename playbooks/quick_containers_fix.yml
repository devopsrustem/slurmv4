# quick_fix_official.yml
---
- name: "ğŸ”¥ Ğ‘Ğ«Ğ¡Ğ¢Ğ ĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• - ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ™ ĞŸĞĞ”Ğ¥ĞĞ”"
  hosts: slurm_compute,slurm_login  # Ğ˜ Ğ½Ğ° login Ñ‚Ğ¾Ğ¶Ğµ!
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"
      shell: |
        echo "ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¾Ğº..."
        
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ñ‹ Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸
        rm -f /usr/local/src/pyxis/spank_pyxis.so
        rm -f /etc/slurm/plugstack.conf
        rm -rf /usr/local/src/pyxis/*
        
        # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ pyxis
        rm -f /usr/local/lib/slurm/spank_pyxis.so
        rm -f /usr/local/share/pyxis/pyxis.conf
        rm -f /etc/slurm/plugstack.conf.d/pyxis.conf
        
        echo "Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹"
      register: cleanup_result
      
    - name: "ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° headers"
      shell: |
        if [ -f /opt/slurm/include/slurm/spank.h ]; then
          echo "âœ… Headers Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
        else
          echo "âŒ Headers Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ - ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ· NFS"
          mkdir -p /opt/slurm/include
          cp -r /sw/slurm-complete/include/* /opt/slurm/include/ || exit 1
        fi
        
        echo "Headers: $(find /opt/slurm/include -name '*.h' | wc -l) Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"
      register: headers_check
      
    - name: "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Enroot (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)"
      shell: |
        if ! command -v enroot >/dev/null 2>&1; then
          apt update
          apt install -y fuse3 squashfs-tools curl build-essential pkg-config
          cd /tmp
          wget -q https://github.com/NVIDIA/enroot/releases/download/v3.5.0/enroot_3.5.0-1_amd64.deb
          apt install -y ./enroot_3.5.0-1_amd64.deb
          echo "Enroot ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
        else
          echo "Enroot ÑƒĞ¶Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
        fi
      register: enroot_install
      
    - name: "ğŸ”¨ ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ¯ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Pyxis"
      shell: |
        echo "ğŸ”¨ ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ¯ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ PYXIS"
        
        # ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°
        mkdir -p /tmp/pyxis-build
        cd /tmp/pyxis-build
        rm -rf *
        
        # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ
        wget -q https://github.com/NVIDIA/pyxis/archive/v0.20.0.tar.gz
        tar -xf v0.20.0.tar.gz --strip-components=1
        
        # ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ
        export CPPFLAGS="-I/opt/slurm/include"
        export LDFLAGS="-L/opt/slurm/lib"
        make clean || true
        make
        
        # ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ¯ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ!
        make install
        
        echo "âœ… Pyxis ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾!"
        echo "ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½: $(find /usr/local -name 'spank_pyxis.so')"
        echo "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³: $(find /usr/local -name 'pyxis.conf')"
        
      register: pyxis_install
      
    - name: "ğŸ“ ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ¯ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ"
      shell: |
        echo "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸"
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
        mkdir -p /etc/slurm/plugstack.conf.d
        
        # ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ¯ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑÑ‹Ğ»ĞºĞ°!
        ln -sf /usr/local/share/pyxis/pyxis.conf /etc/slurm/plugstack.conf.d/pyxis.conf
        
        echo "âœ… ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°:"
        ls -la /etc/slurm/plugstack.conf.d/pyxis.conf
        echo "Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ:"
        cat /usr/local/share/pyxis/pyxis.conf
        
      register: config_create
      
    - name: "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Enroot"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/enroot
        - /var/cache/enroot
        - /run/enroot
        - /etc/enroot
        
    - name: "ğŸ“ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Enroot"
      copy:
        dest: /etc/enroot/enroot.conf
        content: |
          ENROOT_DATA_PATH /var/lib/enroot
          ENROOT_CACHE_PATH /var/cache/enroot
          ENROOT_RUNTIME_PATH /run/enroot
          ENROOT_MOUNT_HOME /home:/home
          ENROOT_MOUNT_HOME /sw:/sw
          ENROOT_ALLOW_PRIVILEGED yes
        mode: '0644'
        
    - name: "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº slurmd (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ compute)"
      systemd:
        name: slurmd
        state: restarted
      when: inventory_hostname in groups['slurm_compute']
      
    - name: "â° ĞŸĞ°ÑƒĞ·Ğ°"
      pause:
        seconds: 3
        
    - name: "âœ… Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°"
      shell: |
        echo "=== Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ™ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ˜ ==="
        echo "Enroot: $(enroot version)"
        echo "Pyxis Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½: $(ls -la /usr/local/lib/slurm/spank_pyxis.so 2>/dev/null || echo 'Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½')"
        echo "Pyxis ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³: $(ls -la /usr/local/share/pyxis/pyxis.conf 2>/dev/null || echo 'Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½')"
        echo "Ğ¡ÑÑ‹Ğ»ĞºĞ°: $(ls -la /etc/slurm/plugstack.conf.d/pyxis.conf 2>/dev/null || echo 'Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°')"
        if [ "{{ inventory_hostname in groups['slurm_compute'] }}" = "True" ]; then
          echo "slurmd: $(systemctl is-active slurmd)"
        fi
        echo "Ğ¢Ğ¸Ğ¿ ÑƒĞ·Ğ»Ğ°: {{ 'compute' if inventory_hostname in groups['slurm_compute'] else 'login' }}"
      register: final_check
      
    - name: "ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚"
      debug:
        var: final_check.stdout_lines

# Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ
- name: "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ"
  hosts: slurm_master
  become: true
  tasks:
    - name: "ğŸ§ª Ğ¢ĞµÑÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° (Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ pyxis)"
      shell: |
        echo "ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ Ğ£Ğ•Ğœ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ¡ ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğœ PYXIS..."
        timeout 120 srun --container-image=docker://hello-world 2>&1
      register: container_test
      failed_when: false
      
    - name: "ğŸ‰ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢"
      debug:
        msg: |
          ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ:
          {{ container_test.stdout }}
          {{ container_test.stderr }}
          
          {% if 'Hello from Docker' in container_test.stdout %}
          ğŸ‰ğŸ‰ğŸ‰ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢! ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ™ ĞŸĞĞ”Ğ¥ĞĞ” Ğ¡Ğ ĞĞ‘ĞĞ¢ĞĞ›! ğŸ‰ğŸ‰ğŸ‰
          {% else %}
          ğŸ’” ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚, Ğ½ÑƒĞ¶Ğ½Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ°
          
          ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ:
          1. ls -la /usr/local/lib/slurm/spank_pyxis.so
          2. ls -la /etc/slurm/plugstack.conf.d/pyxis.conf  
          3. tail /var/log/slurm/slurmd.log | grep -i spank
          {% endif %}