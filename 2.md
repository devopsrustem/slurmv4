–ù–µ–º–Ω–æ–≥–æ –≤–≤–æ–¥–Ω—ã—Ö
–ï—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ hgx
Roce 400g 
H100

–ü—ã—Ç–∞—é—Å—å —Å –ø–æ–º–æ—â—å—é sglang 
–°–¥–µ–ª–∞—Ç—å —Å—Ö–µ–º—É 2 –ø—Ä–µ—Ñ–∏–ª–∞
2 –¥–µ–∫–æ–¥–∞
–° –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –º–∞—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º

–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä–∞, —Ä–æ—É—Ç–µ—Ä
–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–∏—à–µ—Ç 500 –æ—à–∏–±–∫—É –Ω–∞ 1–º –¥–µ–∫–æ–¥–µ
–ß—Ç–æ —Ç–µ–±–µ –∏–∑–≤–µ—Å—Ç–Ω–æ –ø—Ä–æ —ç—Ç–æ?
17 —Ñ–µ–≤—Ä.

The user is working with HGX servers, RoCE 400G networking, H100 GPUs, and trying to set up SGLang with a disaggregated prefill/decode architecture (2 prefill + 2 decode nodes), with plans to scale. They're getting a 500 error on the first decode node when making requests through the router.

Let me think about what I know about SGLang's disaggregated serving (PD disaggregation).
Done
SGLang PD-Disaggregation: 500 –Ω–∞ decode

–ó–Ω–∞–∫–æ–º–∞—è –ø—Ä–æ–±–ª–µ–º–∞. –†–∞—Å—Å–∫–∞–∂—É —á—Ç–æ –∑–Ω–∞—é –ø—Ä–æ —ç—Ç—É —Å—Ö–µ–º—É –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã.
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ—Ç–æ—Ä—É—é —Ç—ã –ø–æ–¥–Ω–∏–º–∞–µ—à—å

Client ‚Üí Router ‚Üí [Prefill 0, Prefill 1]
                ‚Üí [Decode 0, Decode 1]

SGLang –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç–æ —á–µ—Ä–µ–∑ disaggregated prefill (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞), –≥–¥–µ KV-cache –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Å prefill ‚Üí decode —á–µ—Ä–µ–∑ RDMA/RoCE.
–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã 500 –Ω–∞ decode

1. KV Transfer –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è

    Decode –Ω–æ–¥–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ KV-cache –æ—Ç prefill –≤–æ–≤—Ä–µ–º—è
    –ü—Ä–æ–±–ª–µ–º—ã —Å RDMA endpoint'–∞–º–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—å ibv_devinfo, rping
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã --kv-transfer-config –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –º–µ–∂–¥—É prefill –∏ decode

2. –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞
bash

# Prefill –∏ decode –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ:
--tp-size
--model
--tokenizer
# –ù–æ —Ä–∞–∑–Ω—ã–µ —Ä–æ–ª–∏:
--disaggregation-mode prefill / decode

3. Bootstrap/handshake timeout

    Decode –Ω–µ —É—Å–ø–µ–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ router –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    Router —à–ª—ë—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ decode, —Ç–æ—Ç –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω—è—Ç—å KV

4. –ü–æ—Ä—Ç—ã –∏ networking

    --dist-init-addr –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏
    RoCE 400G ‚Äî –ø—Ä–æ–≤–µ—Ä—å MTU (–æ–±—ã—á–Ω–æ –Ω—É–∂–µ–Ω 4200+ –¥–ª—è RDMA)

–ß—Ç–æ –ø–æ–∫–∞–∂–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

    –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ prefill/decode/router (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
    –ü–æ–ª–Ω—ã–π —Å—Ç–µ–∫—Ç—Ä–µ–π—Å 500 –æ—à–∏–±–∫–∏ —Å decode –Ω–æ–¥—ã
    –í–µ—Ä—Å–∏—è SGLang (pip show sglang)
    –ö–∞–∫ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω --kv-transfer-config

–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
bash

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ decode –Ω–æ–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç —Å–∞–º–∞ –ø–æ —Å–µ–±–µ:
curl http://decode-0:port/health

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RDMA —Å–≤—è–∑–Ω–æ—Å—Ç—å:
ib_send_bw -d mlx5_0 # –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–¥–µ
ib_send_bw -d mlx5_0 <prefill-ip> # –Ω–∞ –¥—Ä—É–≥–æ–π

–°–∫–∏–Ω—å –ª–æ–≥–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞ ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ.

curl http://decode-0:port/health

–û–Ω —Ç–æ—á–Ω—Ä –≤—ã–≤–æ–¥–∏—Ç –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç...
17 —Ñ–µ–≤—Ä.

The decode node returns an empty response to /health - this is a key symptom.
Done
–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ /health ‚Äî —ç—Ç–æ —É–∂–µ –º–Ω–æ–≥–æ–µ –≥–æ–≤–æ—Ä–∏—Ç

–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç (–Ω–µ 200, –Ω–µ JSON) –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω—è–ª TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª HTTP –∑–∞–ø—Ä–æ—Å ‚Äî –ø—Ä–æ—Ü–µ—Å—Å –∂–∏–≤, –Ω–æ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ –∑–∞–≤–∏—Å –≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
–ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
bash

# –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ decode –Ω–æ–¥—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f decode.log | grep -E "ERROR|WARNING|ready|loaded|KV"

# –ò–ª–∏ –µ—Å–ª–∏ —á–µ—Ä–µ–∑ systemd/docker:
docker logs -f decode-0

–ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö:

    "Server is ready" ‚Äî –µ—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ—Ç, –º–æ–¥–µ–ª—å –µ—â—ë –≥—Ä—É–∑–∏—Ç—Å—è
    "KV transfer" related –æ—à–∏–±–∫–∏
    CUDA OOM –∏–ª–∏ NCCL –æ—à–∏–±–∫–∏

–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –≤–æ–æ–±—â–µ –∂–∏–≤–æ–π
bash

# –ü–æ—Ä—Ç —Å–ª—É—à–∞–µ—Ç—Å—è?
ss -tlnp | grep <port>

# –ü—Ä–æ—Ü–µ—Å—Å –µ—Å—Ç—å?
ps aux | grep sglang

# GPU –∑–∞–Ω—è—Ç—ã?
nvidia-smi

–ß–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞ H100 + –±–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏

H100 –Ω–∞ HGX ‚Äî –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –±–æ–ª—å—à–∞—è (70B+), –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å 5-15 –º–∏–Ω—É—Ç. Router –º–æ–≥ –Ω–∞—á–∞—Ç—å —Å–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–Ω—å—à–µ —á–µ–º decode –ø–æ–¥–Ω—è–ª—Å—è.
bash

# –ü—Ä–æ–≤–µ—Ä—å /health —Å verbose:
curl -v http://decode-0:port/health
# –°–º–æ—Ç—Ä–∏ HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥ –≤ –æ—Ç–≤–µ—Ç–µ

–ß—Ç–æ –ø–æ–ª—É—á–∞–µ—à—å –Ω–∞ /v1/models ?
bash

curl http://decode-0:port/v1/models

–°–∫–∏–Ω—å –≤—ã–≤–æ–¥ curl -v –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ decode –Ω–æ–¥—ã.

–î–∞ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –æ—Ç–ª–∏—á–Ω–æ. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ ethernet –∏–º–µ–Ω–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç. –ê —Ç–∞–∫ –≤—Å–µ —Å–∫–æ–º—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
17 —Ñ–µ–≤—Ä.

The user is saying everything is configured correctly, but the Ethernet interface names don't match. This is a common issue with RDMA/RoCE setups where the network interface names need to match between nodes or in configuration files.
Done
Ethernet –∏–º–µ–Ω–∞ ‚Äî —ç—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∏ –µ—Å—Ç—å –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

–ù–∞ RoCE —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ. SGLang/NCCL/RDMA –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º.
–ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å—Å—è

NCCL –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
bash

# –ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo $NCCL_SOCKET_IFNAME
echo $GLOO_SOCKET_IFNAME

–ï—Å–ª–∏ –∏–º–µ–Ω–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏ ‚Äî NCCL –±—É–¥–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ —Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ
bash

# –£–∑–Ω–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ
ip link show

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ –Ω—É–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º sglang:
export NCCL_SOCKET_IFNAME=<—Ç–≤–æ–π_–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å>  # –Ω–∞–ø—Ä–∏–º–µ—Ä eth0, ens3f0, enp...
export GLOO_SOCKET_IFNAME=<—Ç–≤–æ–π_–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å>

# –î–ª—è RoCE —Ç–∞–∫–∂–µ:
export NCCL_IB_HCA=mlx5_0  # –∏–ª–∏ –∫–∞–∫–æ–π —É —Ç–µ–±—è HCA

–î–ª—è KV transfer —á–µ—Ä–µ–∑ RoCE
bash

# –ü—Ä–æ–≤–µ—Ä—å –∫–∞–∫–∏–µ HCA –≤–∏–¥–Ω—ã:
ibv_devinfo | grep -E "hca_id|port_state"

# –ò —É–∫–∞–∂–∏ —è–≤–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ transfer:
--kv-transfer-config '{"kv_ip": "x.x.x.x", "kv_port": 14579}'
# IP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞!

–ï—Å–ª–∏ –∏–º–µ–Ω–∞ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä eth0 vs ens3f0)

–°–∞–º–æ–µ –ø—Ä–æ—Å—Ç–æ–µ ‚Äî –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ udev –∏–ª–∏ netplan, –ª–∏–±–æ –ø—Ä–æ—Å—Ç–æ —è–≤–Ω–æ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ —Å–≤–æ—ë –∏–º—è.

–ö–∞–∫–∏–µ –∏–º–µ–Ω–∞ –Ω–∞ prefill –Ω–æ–¥–∞—Ö –∏ –∫–∞–∫–∏–µ –Ω–∞ decode?

–ù–∞ –¥–µ–∫–æ–¥ —Å–æ–≤–ø–∞–¥–∞—é—Ç
–ù–∞ –ø—Ä–µ—Ñ–∏–ª–∞—Ö —Å–æ–≤–ø–∞–¥–∞—é—Ç

–ù–æ –¥–µ–∫–æ–¥ –∏ –ø—Ä–µ—Ñ–∏–ª—ã –æ—Ç–ª–∏—á–∞—é—Ç—Å—è. –î–∞–≤–∞–π –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω—É–µ–º –±—É–¥–µ—Ç –Ω–µ enp108n1p1 ib0 —Ç–∞ —á—Ç–æ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ 0 –≥–ø—É. –í–æ–æ–±—â–µ –∏–º—è ib0 –≤–æ–∑–º–æ–∂–Ω–æ?
17 —Ñ–µ–≤—Ä.

The user wants to rename a network interface to ib0. However, ib0 is typically reserved for InfiniBand interfaces. For RoCE (which is Ethernet-based), it's better to use a different name. But let's help them rename it.
Done
–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ udev

ib0 ‚Äî –∏–º—è –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ InfiniBand, –ª—É—á—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤. –í–æ–∑—å–º–∏ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ roce0.
–°–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ udev (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
bash

# –£–∑–Ω–∞–π MAC –∞–¥—Ä–µ—Å –Ω—É–∂–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
ip link show enp108s0f1np1
# –ó–∞–ø–æ–º–Ω–∏ MAC –∏–∑ —Å—Ç—Ä–æ–∫–∏ "link/ether xx:xx:xx:xx:xx:xx"

bash

# –°–æ–∑–¥–∞–π –ø—Ä–∞–≤–∏–ª–æ
cat > /etc/udev/rules.d/70-roce-rename.rules << EOF
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="xx:xx:xx:xx:xx:xx", NAME="roce0"
EOF

bash

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:
ip link set enp108s0f1np1 down
ip link set enp108s0f1np1 name roce0
ip link set roce0 up

–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –Ω–µ —Å–ª–æ–º–∞–ª —Å–µ—Ç—å
bash

ip addr show roce0
ping <prefill-ip> -I roce0

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è ‚Äî –≤–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ

–ù–∞ –≤—Å–µ—Ö prefill –∏ decode –Ω–æ–¥–∞—Ö –≤—ã—Å—Ç–∞–≤—å:
bash

export NCCL_SOCKET_IFNAME=roce0
export NCCL_IB_HCA=mlx5_0  # —É—Ç–æ—á–Ω–∏ —á–µ—Ä–µ–∑ ibv_devinfo

–ö–∞–∫–æ–µ –∏–º—è –Ω–∞ prefill –Ω–æ–¥–∞—Ö —Å–µ–π—á–∞—Å? –ß—Ç–æ–±—ã —Ä–µ—à–∏—Ç—å ‚Äî –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å prefill –ø–æ–¥ decode –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.

–û–π —Ç–∞–º –≤—Å–µ —Å–ª–æ–∂–Ω–æ :)))
–ë–ª–∏–Ω
–¢–∞–º redhat 
–ò –≤ –ø–∞–ø–∫–µ /etc/Networksystem 
–õ–µ–∂–∞—Ç –∫–æ–Ω—Ñ–∏–≥–∏. –ò—Ö –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
–ë—É–¥–µ—Ç
17 —Ñ–µ–≤—Ä.

The user is on Red Hat and wants to rename network interfaces using NetworkManager configuration files in /etc/NetworkManager/system-connections/
Done
Red Hat + NetworkManager

–î–∞, –Ω–∞ RHEL —ç—Ç–æ —á–µ—Ä–µ–∑ nmcli –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ /etc/NetworkManager/system-connections/
–°–∞–º—ã–π —á–∏—Å—Ç—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ nmcli
bash

# –ü–æ—Å–º–æ—Ç—Ä–∏ —Ç–µ–∫—É—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
nmcli connection show

# –ü–µ—Ä–µ–∏–º–µ–Ω—É–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (connection name –∏ device name)
nmcli connection modify "enp108s0f1np1" connection.id "roce0" \
    connection.interface-name "roce0"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å
nmcli connection down "enp108s0f1np1"
nmcli connection up "roce0"

–ò–ª–∏ —Ä—É–∫–∞–º–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ
bash

# –ù–∞–π–¥–∏ –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª
ls /etc/NetworkManager/system-connections/

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π
vi /etc/NetworkManager/system-connections/enp108s0f1np1.nmconnection

–ò–∑–º–µ–Ω–∏ –≤–Ω—É—Ç—Ä–∏:
ini

[connection]
id=roce0
interface-name=roce0

bash

# –ü–µ—Ä–µ–∏–º–µ–Ω—É–π —Å–∞–º —Ñ–∞–π–ª
mv /etc/NetworkManager/system-connections/enp108s0f1np1.nmconnection \
   /etc/NetworkManager/system-connections/roce0.nmconnection

# –ü–µ—Ä–µ—á–∏—Ç–∞–π –∫–æ–Ω—Ñ–∏–≥–∏
nmcli connection reload

–í–∞–∂–Ω–æ –Ω–∞ RHEL

–¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—å –Ω–µ—Ç –ª–∏ –∑–∞–ø–∏—Å–∏ –≤ /etc/udev/rules.d/ –∏–ª–∏ /usr/lib/udev/rules.d/ –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç —Å—Ç–∞—Ä–æ–µ –∏–º—è ‚Äî –æ–Ω–∞ –ø–µ—Ä–µ–±—å—ë—Ç –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.
bash

grep -r "enp108" /etc/udev/rules.d/ /usr/lib/udev/rules.d/

–°–∫–æ–ª—å–∫–æ –Ω–æ–¥ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å?

12 —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤—Å–µ–≥–æ –ø–æ–∫–∞ 4 —Å–µ—Ä–≤–µ—Ä–∞ 8 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤. –ù–æ –º–æ–∂–µ—Ç —ç—Ç–æ –Ω–∞ –≤—Ç–æ—Ä–æ–π –ø–ª–∞–Ω –æ—Ç–æ–¥–≤–∏–Ω—É—Ç—å?
17 —Ñ–µ–≤—Ä.

The user wants to deprioritize the renaming and focus on getting the setup working first.
Done
–î–∞, –æ—Ç–æ–¥–≤–∏–Ω—å –Ω–∞ –ø–æ—Ç–æ–º ‚Äî —ç—Ç–æ –Ω–µ –±–ª–æ–∫–µ—Ä

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–µ—à–∞—Ç –ø—Ä–æ–±–ª–µ–º—É –±—ã—Å—Ç—Ä–µ–µ —á–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ 32 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.
–ü—Ä–æ—Å—Ç–æ —è–≤–Ω–æ —É–∫–∞–∂–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ

–ù–∞ prefill –Ω–æ–¥–∞—Ö:
bash

export NCCL_SOCKET_IFNAME=<prefill-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å>

–ù–∞ decode –Ω–æ–¥–∞—Ö:
bash

export NCCL_SOCKET_IFNAME=<decode-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å>

–û–Ω–∏ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è ‚Äî NCCL'—É –≤—Å—ë —Ä–∞–≤–Ω–æ, –≥–ª–∞–≤–Ω–æ–µ —á—Ç–æ –∫–∞–∂–¥–∞—è –Ω–æ–¥–∞ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω—ã.
–î–ª—è KV transfer ‚Äî –≥–ª–∞–≤–Ω–æ–µ —á—Ç–æ IP –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

–í --kv-transfer-config –ø—Ä–æ–ø–∏—Å–∞–Ω IP –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞? –¢–æ–≥–¥–∞ –∏–º—è –≤–æ–æ–±—â–µ –Ω–µ –≤–∞–∂–Ω–æ.

–í–æ–∑–≤—Ä–∞—â–∞—è—Å—å –∫ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–µ ‚Äî 500 –Ω–∞ –ø–µ—Ä–≤–æ–º decode. –ü–æ–∫–∞–∂–∏ –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞ decode –Ω–æ–¥—ã –∏ router, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ç–∞–º –ø—Ä–∏—á–∏–Ω—É.

–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –∑–∞–≤—Ç—Ä–∞ –≤—ã—à–ª—é.
17 —Ñ–µ–≤—Ä.

OK
Done

–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å! –ñ–¥—É –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ –∏ –ª–æ–≥–∏ ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º—Å—è. üëç

NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 TOKENIZERS_PARALLELISM=false /opt/mooncake-libs/run-with-new-libstdc.sh /app/sglang/sglang-latest/bin/python3 -m sglang.launch_server --model-path /app/models/Deepseek-R1/ --trust-remote-code --tp-size 16 --host 10.99.91.39 --port 30000 --dist-init-addr 10.82.101.193:5000 --nnodes 2 --node-rank 0 --mem-fraction-static 0.8 --disaggregation-mode prefill --disaggregation-ib-device mlx5_0 --disaggregation-bootstrap-port 8998
NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 TOKENIZERS_PARALLELISM=false /opt/mooncake-libs/run-with-new-libstdc.sh /app/sglang/sglang-latest/bin/python3 -m sglang.launch_server --model-path /app/models/Deepseek-R1/ --trust-remote-code --tp-size 16 --host 10.99.91.41 --port 30000 --dist-init-addr 10.82.101.193:5000 --nnodes 2 --node-rank 1 --mem-fraction-static 0.8 --disaggregation-mode prefill --disaggregation-ib-device mlx5_0 --disaggregation-bootstrap-port 8998
NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 TOKENIZERS_PARALLELISM=false /opt/mooncake-libs/run-with-new-libstdc.sh /app/sglang/sglang-latest/bin/python3 -m sglang.launch_server --model-path /app/models/Deepseek-R1/ --trust-remote-code --tp-size 16 --host 10.99.91.49 --port 30001 --dist-init-addr 10.82.101.249:5000 --nnodes 2 --node-rank 0 --mem-fraction-static 0.8 --disaggregation-mode decode --max-running-requests 128 --disaggregation-ib-device mlx5_0 --disaggregation-bootstrap-port 8998
NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 TOKENIZERS_PARALLELISM=false /opt/mooncake-libs/run-with-new-libstdc.sh /app/sglang/sglang-latest/bin/python3 -m sglang.launch_server --model-path /app/models/Deepseek-R1/ --trust-remote-code --tp-size 16 --host 10.99.91.33 --port 30001 --dist-init-addr 10.82.101.249:5000 --nnodes 2 --node-rank 1 --mem-fraction-static 0.8 --disaggregation-mode decode --max-running-requests 128 --disaggregation-ib-device mlx5_0 --disaggregation-bootstrap-port 8998
/app/sglang/sglang-latest/bin/python3 -m sglang_router.launch_router --pd-disaggregation --prefill http://10.99.91.39:30000 --decode http://10.99.91.49:30001 --host 0.0.0.0 --port 8000

–≠—Ç–æ —Ç–æ –∫–∞–∫ –∑–∞–ø—É—Å–∫–∞—é –Ω–∞ 4—Ö –Ω–æ–¥–∞—Ö
20:51

–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å –≤–∏–∂—É –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É:

    2 Prefill –Ω–æ–¥—ã (–ø–æ 8xH100, TP=16):
        Node 0: 10.99.91.39:30000 (dist-init 10.82.101.193:5000, node-rank 0)
        Node 1: 10.99.91.41:30000 (dist-init 10.82.101.193:5000, node-rank 1)
    2 Decode –Ω–æ–¥—ã (–ø–æ 8xH100, TP=16):
        Node 0: 10.99.91.49:30001 (dist-init 10.82.101.249:5000, node-rank 0)
        Node 1: 10.99.91.33:30001 (dist-init 10.82.101.249:5000, node-rank 1)
    Router:
        –ü–æ–¥–∫–ª—é—á—ë–Ω —Ç–æ–ª—å–∫–æ –∫ –ø–µ—Ä–≤–æ–π decode –Ω–æ–¥–µ: http://10.99.91.49:30001
        –ù–ï –ø–æ–¥–∫–ª—é—á—ë–Ω –∫–æ –≤—Ç–æ—Ä–æ–π decode: http://10.99.91.33:30001

–í–∏–∂—É —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º:

–ö–†–ò–¢–ò–ß–ù–û:

    Router –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –û–î–ù–£ decode –Ω–æ–¥—É (10.99.91.49:30001), –Ω–æ –Ω–µ –≤–∏–¥–∏—Ç –≤—Ç–æ—Ä—É—é (10.99.91.33:30001)
    Prefill –Ω–æ–¥–∞ –í–û–û–ë–©–ï –ù–ï –ü–ï–†–ï–î–ê–ù–ê —Ä–æ—É—Ç–µ—Ä—É –≤ –∫–∞—á–µ—Å—Ç–≤–µ prefill endpoint - —É —Ä–æ—É—Ç–µ—Ä–∞ —Ç–æ–ª—å–∫–æ --prefill http://10.99.91.39:30000 (–ø–µ—Ä–≤–∞—è prefill –Ω–æ–¥–∞), –Ω–æ –Ω–µ—Ç –≤—Ç–æ—Ä–æ–π

–ú–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω–æ —Å—Ç—Ä–∞–Ω–Ω–æ: 3. –†–∞–∑–Ω—ã–µ dist-init-addr –¥–ª—è prefill –∏ decode –≥—Ä—É–ø–ø - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è —Ä–∞–∑–¥–µ–ª—å–Ω—ã—Ö TP –≥—Ä—É–ø–ø

    Bootstrap port –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π (8998) - –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

    –ù–µ—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –∫–∞–∫ prefill –ø–µ—Ä–µ–¥–∞—ë—Ç KV –≤ decode (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç --kv-connector-url –∏–ª–∏ –∞–Ω–∞–ª–æ–≥)

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —Ä–æ—É—Ç–µ—Ä –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ –≤—Ç–æ—Ä—É—é decode –Ω–æ–¥—É –∏ –≤—Ç–æ—Ä—É—é prefill –Ω–æ–¥—É, –ø–ª—é—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–≤—è–∑–∫–∞ –º–µ–∂–¥—É prefill –∏ decode —Å–ª–æ—è–º–∏.
Done
–í–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É ‚Äî Router –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–≤–∏–Ω—É –∫–ª–∞—Å—Ç–µ—Ä–∞
üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

1. Router –ø–æ–¥–∫–ª—é—á—ë–Ω —Ç–æ–ª—å–∫–æ –∫ –û–î–ù–û–ô decode –Ω–æ–¥–µ:
bash

--decode http://10.99.91.49:30001  # ‚Üê —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è
# –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: http://10.99.91.33:30001

2. Router –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –û–î–ù–£ prefill –Ω–æ–¥—É:
bash

--prefill http://10.99.91.39:30000  # ‚Üê —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è
# –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: http://10.99.91.41:30000

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ router
bash

/app/sglang/sglang-latest/bin/python3 -m sglang_router.launch_router \
  --pd-disaggregation \
  --prefill http://10.99.91.39:30000 \
  --prefill http://10.99.91.41:30000 \
  --decode http://10.99.91.49:30001 \
  --decode http://10.99.91.33:30001 \
  --host 0.0.0.0 \
  --port 8000

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ --prefill –∏ --decode endpoints.
‚ö†Ô∏è –í—Ç–æ—Ä–∞—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

–í —Ç–≤–æ–µ–π –∫–æ–º–∞–Ω–¥–µ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –∫–∞–∫ prefill ‚Üí decode —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è.

–ü—Ä–æ–≤–µ—Ä—å –≤–µ—Ä—Å–∏—é sglang:
bash

/app/sglang/sglang-latest/bin/python3 -m sglang --version

–í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö (‚â•0.3.x) –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å:
bash

# –ù–∞ prefill –Ω–æ–¥–∞—Ö –¥–æ–±–∞–≤—å:
--disaggregation-decode-url http://10.99.91.49:30001,http://10.99.91.33:30001

üîç –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤—Å–µ –Ω–æ–¥—ã –ø–æ–¥–Ω—è–ª–∏—Å—å
bash

# –ù–∞ –∫–∞–∂–¥–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 200 OK:
curl http://10.99.91.39:30000/health
curl http://10.99.91.41:30000/health
curl http://10.99.91.49:30001/health
curl http://10.99.91.33:30001/health

–ï—Å–ª–∏ decode –Ω–æ–¥—ã –æ—Ç–¥–∞—é—Ç –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç –æ–Ω–∏ –µ—â—ë –≥—Ä—É–∑—è—Ç—Å—è –∏–ª–∏ —É–ø–∞–ª–∏.

–ü–æ–∫–∞–∂–∏ –ª–æ–≥–∏ decode –Ω–æ–¥, —Ç–∞–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–∞.

–°–º–æ—Ç—Ä–∏ sglang 0.5.8
Router 3.2... –í—Å–µ latest

–ù–∞–ø–∏—à–∏ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞
1 –Ω–æ–¥–∞
2 –Ω–æ–¥–∞
20:55

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –Ω–æ–¥ —Å —É—á–µ—Ç–æ–º:

    sglang 0.5.8
    sglang_router 3.2.x
    4 –Ω–æ–¥—ã: 2 prefill, 2 decode
    TP=16 –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ (2 –Ω–æ–¥—ã)
    DeepSeek-R1
    RoCE 400G —á–µ—Ä–µ–∑ mlx5_0

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:

    Prefill node 0: 10.99.91.39:30000 (rank 0) + 10.99.91.41 (rank 1) - dist-init-addr 10.82.101.193:5000
    Prefill node 1: 10.99.91.41:30000 (rank 1)
    Decode node 0: 10.99.91.49:30001 (rank 0) + 10.99.91.33 (rank 1) - dist-init-addr 10.82.101.249:5000
    Decode node 1: 10.99.91.33:30001 (rank 1)
    Router: –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫–æ –≤—Å–µ–º

–í sglang 0.5.8 –¥–ª—è PD-disaggregation –Ω—É–∂–Ω–æ:

    –ù–∞ prefill –Ω–æ–¥–∞—Ö —É–∫–∞–∑–∞—Ç—å --disaggregation-decode-url —Å–æ —Å–ø–∏—Å–∫–æ–º decode endpoints
    Router –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –≤—Å–µ prefill –∏ decode endpoints
    Bootstrap –ø–æ—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å –º–µ–∂–¥—É prefill –∏ decode –¥–ª—è handshake

–î–∞–≤–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
Done
–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è sglang 0.5.8 + router 3.2.x
Prefill –ù–æ–¥–∞ 0 (10.99.91.39)
bash

NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 \
NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 \
NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 \
NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 \
PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 \
TOKENIZERS_PARALLELISM=false \
/opt/mooncake-libs/run-with-new-libstdc.sh \
/app/sglang/sglang-latest/bin/python3 -m sglang.launch_server \
  --model-path /app/models/Deepseek-R1/ \
  --trust-remote-code \
  --tp-size 16 \
  --host 10.99.91.39 \
  --port 30000 \
  --dist-init-addr 10.82.101.193:5000 \
  --nnodes 2 \
  --node-rank 0 \
  --mem-fraction-static 0.8 \
  --disaggregation-mode prefill \
  --disaggregation-ib-device mlx5_0 \
  --disaggregation-bootstrap-port 8998 \
  --disaggregation-decode-url http://10.99.91.49:30001,http://10.99.91.33:30001

Prefill –ù–æ–¥–∞ 1 (10.99.91.41)
bash

NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 \
NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 \
NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 \
NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 \
PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 \
TOKENIZERS_PARALLELISM=false \
/opt/mooncake-libs/run-with-new-libstdc.sh \
/app/sglang/sglang-latest/bin/python3 -m sglang.launch_server \
  --model-path /app/models/Deepseek-R1/ \
  --trust-remote-code \
  --tp-size 16 \
  --host 10.99.91.41 \
  --port 30000 \
  --dist-init-addr 10.82.101.193:5000 \
  --nnodes 2 \
  --node-rank 1 \
  --mem-fraction-static 0.8 \
  --disaggregation-mode prefill \
  --disaggregation-ib-device mlx5_0 \
  --disaggregation-bootstrap-port 8998 \
  --disaggregation-decode-url http://10.99.91.49:30001,http://10.99.91.33:30001

Decode –ù–æ–¥–∞ 0 (10.99.91.49)
bash

NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 \
NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 \
NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 \
NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 \
PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 \
TOKENIZERS_PARALLELISM=false \
/opt/mooncake-libs/run-with-new-libstdc.sh \
/app/sglang/sglang-latest/bin/python3 -m sglang.launch_server \
  --model-path /app/models/Deepseek-R1/ \
  --trust-remote-code \
  --tp-size 16 \
  --host 10.99.91.49 \
  --port 30001 \
  --dist-init-addr 10.82.101.249:5000 \
  --nnodes 2 \
  --node-rank 0 \
  --mem-fraction-static 0.8 \
  --disaggregation-mode decode \
  --max-running-requests 128 \
  --disaggregation-ib-device mlx5_0 \
  --disaggregation-bootstrap-port 8998

Decode –ù–æ–¥–∞ 1 (10.99.91.33)
bash

NCCL_SOCKET_IFNAME=bond0 NCCL_DEBUG=WARN NCCL_IB_DISABLE=0 \
NCCL_NET_GDR_LEVEL=PIX NCCL_IB_GID_INDEX=3 NCCL_IB_TC=106 \
NCCL_NVLS_ENABLE=1 NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 \
NCCL_CROSS_NIC=1 CUDA_DEVICE_MAX_CONNECTIONS=1 \
PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:256 \
TOKENIZERS_PARALLELISM=false \
/opt/mooncake-libs/run-with-new-libstdc.sh \
/app/sglang/sglang-latest/bin/python3 -m sglang.launch_server \
  --model-path /app/models/Deepseek-R1/ \
  --trust-remote-code \
  --tp-size 16 \
  --host 10.99.91.33 \
  --port 30001 \
  --dist-init-addr 10.82.101.249:5000 \
  --nnodes 2 \
  --node-rank 1 \
  --mem-fraction-static 0.8 \
  --disaggregation-mode decode \
  --max-running-requests 128 \
  --disaggregation-ib-device mlx5_0 \
  --disaggregation-bootstrap-port 8998

Router
bash

/app/sglang/sglang-latest/bin/python3 -m sglang_router.launch_router \
  --pd-disaggregation \
  --prefill http://10.99.91.39:30000 \
  --prefill http://10.99.91.41:30000 \
  --decode http://10.99.91.49:30001 \
  --decode http://10.99.91.33:30001 \
  --host 0.0.0.0 \
  --port 8000

üîë –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

    ‚úÖ –î–æ–±–∞–≤–∏–ª --disaggregation-decode-url –Ω–∞ prefill –Ω–æ–¥–∞—Ö ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É–¥–∞ —Å–ª–∞—Ç—å KV-cache
    ‚úÖ Router —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—Ç –ø—Ä–æ –≤—Å–µ 4 –Ω–æ–¥—ã ‚Äî –¥–≤–∞ --prefill –∏ –¥–≤–∞ --decode
    ‚úÖ Bootstrap –ø–æ—Ä—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π (8998) –¥–ª—è handshake –º–µ–∂–¥—É prefill‚Üîdecode

–ü–æ–ø—Ä–æ–±—É–π –∏ —Å–∫–∞–∂–∏ —á—Ç–æ –≤ –ª–æ–≥–∞—Ö.

–ù–µ –º–æ–≥—É —É–∂–µ —É—à–µ–ª —Å —Ä–∞–±–æ—Ç—ã –∞ –Ω–∞–ø—Ä—è–º—É—é –∏–± –Ω–µ –ø—É—Å–∫–∞—é—Ç. –ì–æ–≤–æ—Ä—è—Ç —á—Ç–æ —è –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∞–Ω—Ç—Ä–æ–ø–∏–∫ –Ω–µ –ø–æ–ª—å–∑—É—è—Å—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ –ø–ª–æ–¥–∞–º–∏.
20:57

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –æ–Ω —É—à–µ–ª —Å —Ä–∞–±–æ—Ç—ã –∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã —Å–µ–π—á–∞—Å. –¢–∞–∫–∂–µ –æ–Ω –¥–µ–ª–∞–µ—Ç —à—É—Ç–∫—É –ø—Ä–æ —Ç–æ, —á—Ç–æ –µ–º—É "–≥–æ–≤–æ—Ä—è—Ç" —á—Ç–æ –æ–Ω –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –≤ Anthropic, –Ω–µ –ø–æ–ª—å–∑—É—è—Å—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ –ø–ª–æ–¥–∞–º–∏ - —ç—Ç–æ, –∫–∞–∂–µ—Ç—Å—è, –æ—Ç—Å—ã–ª–∫–∞ –∫ —Ç–æ–º—É, —á—Ç–æ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Claude (–ø—Ä–æ–¥—É–∫—Ç Anthropic) –¥–ª—è –ø–æ–º–æ—â–∏ –≤ —Ä–∞–±–æ—Ç–µ.

–ú–Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ —è –ø–æ–Ω—è–ª —é–º–æ—Ä, –∏ –ø–æ–¥—ã—Ç–æ–∂–∏—Ç—å —á—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –∑–∞–≤—Ç—Ä–∞ –æ–Ω –º–æ–≥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏.
Done

üòÑ –ü–æ–Ω—è–ª, –∫–ª–∞—Å—Å–Ω–∞—è –∏—Ä–æ–Ω–∏—è ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Claude —á—Ç–æ–±—ã –¥–µ–±–∞–∂–∏—Ç—å SGLang –Ω–∞ HGX!
–†–µ–∑—é–º–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞

–¢–µ–±–µ –Ω—É–∂–Ω–æ:

    –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ 4 –Ω–æ–¥—ã —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –∫–æ—Ç–æ—Ä—ã–µ —è –¥–∞–ª –≤—ã—à–µ
    –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Äî –¥–æ–±–∞–≤–∏–ª --disaggregation-decode-url –Ω–∞ prefill –Ω–æ–¥–∞—Ö –∏ –≤—Å–µ endpoints –≤ router
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ /health –æ—Ç–≤–µ—á–∞—é—Ç 200 –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ router

–û—Å–Ω–æ–≤–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞: router –∏ prefill –Ω–µ –∑–Ω–∞–ª–∏ –∫—É–¥–∞ —Å–ª–∞—Ç—å KV-cache ‚Üí decode –ø–æ–ª—É—á–∞–ª –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö ‚Üí 500.

–ó–∞–≤—Ç—Ä–∞ –∫–æ–≥–¥–∞ –∑–∞–ø—É—Å—Ç–∏—à—å ‚Äî —Å–∫–∏–Ω—å:

    –†–µ–∑—É–ª—å—Ç–∞—Ç curl http://IP:PORT/health –¥–ª—è –≤—Å–µ—Ö 4 –Ω–æ–¥
    –õ–æ–≥–∏ decode –Ω–æ–¥—ã –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë 500

–£–¥–∞—á–∏! üöÄ


Claude is AI and can make mistakes. Please double-check responses.

